<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="googlea8ba7e863392b1ab" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,网络通信," />





  <link rel="alternate" href="/atom.xml" title="Scott's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="1. 获取网络图片 通过URL对象封装地址，打开一个HttpURLConnection 设置超时时间以及请求方式 获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据 通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象 需要访问网络的权限 123456">
<meta name="keywords" content="Android,网络通信">
<meta property="og:type" content="article">
<meta property="og:title" content="Android基础5 网络通信">
<meta property="og:url" content="http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html">
<meta property="og:site_name" content="Scott&#39;s Blog">
<meta property="og:description" content="1. 获取网络图片 通过URL对象封装地址，打开一个HttpURLConnection 设置超时时间以及请求方式 获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据 通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象 需要访问网络的权限 123456">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png">
<meta property="og:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.31.43.png">
<meta property="og:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.33.25.png">
<meta property="og:updated_time" content="2017-07-24T06:14:31.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android基础5 网络通信">
<meta name="twitter:description" content="1. 获取网络图片 通过URL对象封装地址，打开一个HttpURLConnection 设置超时时间以及请求方式 获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据 通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象 需要访问网络的权限 123456">
<meta name="twitter:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":true,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html"/>





  <title>Android基础5 网络通信 | Scott's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?760edc77a59a2329550e2d68c6400d9b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>
    
    <!-- 在右上角或者左上角实现fork me on github -->
    <a href="https://github.com/sguotao" class="github-corner" aria-label="View source on Github"><svg width="92" height="92" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Scott's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">和光同尘,静水流深</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Android基础5 网络通信</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2012-06-15T10:27:04+08:00">
                2012-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android基础/" itemprop="url" rel="index">
                    <span itemprop="name">Android基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/Android基础-2012-06-15-android-basic-5.html" class="leancloud_visitors" data-flag-title="Android基础5 网络通信">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  3,025字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  14分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1-获取网络图片"><a href="#1-获取网络图片" class="headerlink" title="1. 获取网络图片"></a>1. 获取网络图片</h2><ol>
<li>通过URL对象封装地址，打开一个HttpURLConnection</li>
<li>设置超时时间以及请求方式</li>
<li>获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据</li>
<li>通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象</li>
<li>需要访问网络的权限<br> <uses-permission android:name="android.permission.INTERNET"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">URL url = new URL(&quot;http://photocdn.sohu.com/20100125/Img269812337.jpg&quot;);</span><br><span class="line">HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">conn.setConnectTimeout(5* 1000);</span><br><span class="line">conn.setRequestMethod(&quot;GET&quot;);</span><br><span class="line">if (conn.getResponseCode() != 200) throw new RuntimeException(&quot;请求url失败&quot;);</span><br><span class="line">InputStream is = conn.getInputStream();</span><br><span class="line">readAsFile(is, &quot;Img269812337.jpg&quot;); </span><br><span class="line">public static void readAsFile(InputStream inSream, File file) throws Exception&#123;</span><br><span class="line">	FileOutputStream outStream = new FileOutputStream(file);</span><br><span class="line">	byte[] buffer = new byte[1024];</span><br><span class="line">	int len = -1;</span><br><span class="line">	while( (len = inSream.read(buffer)) != -1 )&#123;</span><br><span class="line">		outStream.write(buffer, 0, len);</span><br><span class="line">	&#125;</span><br><span class="line"> 	outStream.close();</span><br><span class="line">	inSream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</uses-permission></li>
</ol>
<h2 id="2-获取HTML代码"><a href="#2-获取HTML代码" class="headerlink" title="2. 获取HTML代码"></a>2. 获取HTML代码</h2><ol>
<li>和获取图片相同，使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>需要获取服务器端代码的编码</li>
<li>代码过长屏幕显示不全可以使用<scrollview>进行显示<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">URL url = new URL(&quot;http://www.sohu.com&quot;);</span><br><span class="line">HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">conn.setConnectTimeout(5* 1000);//设置连接超时</span><br><span class="line">conn.setRequestMethod(“GET”);//以get方式发起请求</span><br><span class="line">if (conn.getResponseCode() != 200) throw new RuntimeException(&quot;请求url失败&quot;);</span><br><span class="line">InputStream is = conn.getInputStream();//得到网络返回的输入流</span><br><span class="line">String result = readData(is, &quot;GBK&quot;);</span><br><span class="line">conn.disconnect();</span><br><span class="line">//第一个参数为输入流,第二个参数为字符集编码</span><br><span class="line">public static String readData(InputStream inSream, String charsetName) throws Exception&#123;</span><br><span class="line">	ByteArrayOutputStream outStream = new ByteArrayOutputStream();</span><br><span class="line">	byte[] buffer = new byte[1024];</span><br><span class="line">	int len = -1;</span><br><span class="line">	while( (len = inSream.read(buffer)) != -1 )&#123;</span><br><span class="line">		outStream.write(buffer, 0, len);</span><br><span class="line">	&#125;</span><br><span class="line">	byte[] data = outStream.toByteArray();</span><br><span class="line">	outStream.close();</span><br><span class="line">	inSream.close();</span><br><span class="line">	return new String(data, charsetName);</span><br></pre></td></tr></table></figure>
</scrollview></li>
</ol>
<h2 id="3-获取XML"><a href="#3-获取XML" class="headerlink" title="3. 获取XML"></a>3. 获取XML</h2><ol>
<li>使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>使用XmlPullPaser解析</li>
</ol>
<h2 id="4-获取Json"><a href="#4-获取Json" class="headerlink" title="4. 获取Json"></a>4. 获取Json</h2><ol>
<li>使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>将数据转为String，封装成JSONArray对象</li>
<li>遍历JSONArray对象，获取其中的JSONObject</li>
<li>再从JSONObject中获取每个字段的信息</li>
</ol>
<h2 id="5-发送Get请求"><a href="#5-发送Get请求" class="headerlink" title="5. 发送Get请求"></a>5. 发送Get请求</h2><ol>
<li>拼接路径和参数，通过URL进行封装，打开一个HttpURLConnection，发送请求</li>
<li>如果参数是中文会出现乱码</li>
<li>URL中包含的中文参数需要使用URLEncoder进行编码</li>
<li>服务器端如果是TOMCAT，其默认使用ISO8859-1编码，接收时需要处理编码问题</li>
</ol>
<h2 id="6-发送Post请求"><a href="#6-发送Post请求" class="headerlink" title="6. 发送Post请求"></a>6. 发送Post请求</h2><ol>
<li>通过URL打开一个HttpURLConnection</li>
<li>头信息中除了超时时间和请求方式之外还必须设置Content-Type和Content-Length</li>
<li>从HttpURLConnection获得输出流输出参数数据</li>
<li>服务端可以使用request对象的setCharacterEncoding方法设置编码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder xml =  new StringBuilder();</span><br><span class="line">xml.append(&quot;&amp;lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot; ?&amp;gt;&quot;);</span><br><span class="line">xml.append(&quot;&amp;lt;M1 V=10000&amp;gt;&quot;);</span><br><span class="line">xml.append(&quot;&amp;lt;U I=1 D=\&quot;N73\&quot;&amp;gt;中国&amp;lt;/U&amp;gt;&quot;);</span><br><span class="line">xml.append(&quot;&amp;lt;/M1&amp;gt;&quot;);</span><br><span class="line">byte[] xmlbyte = xml.toString().getBytes(&quot;UTF-8&quot;);</span><br><span class="line">URL url = new URL(&quot;http://localhost:8080/ncist/contanctmanage.do?method=readxml&quot;);</span><br><span class="line">HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">conn.setConnectTimeout(5* 1000);</span><br><span class="line">conn.setDoOutput(true);//允许输出</span><br><span class="line">conn.setUseCaches(false);//不使用Cache</span><br><span class="line">conn.setRequestMethod(&quot;POST&quot;);	        </span><br><span class="line">conn.setRequestProperty(&quot;Connection&quot;, &quot;Keep-Alive&quot;);//维持长连接</span><br><span class="line">conn.setRequestProperty(&quot;Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">conn.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(xmlbyte.length));</span><br><span class="line">conn.setRequestProperty(&quot;Content-Type&quot;, &quot;text/xml; charset=UTF-8&quot;);</span><br><span class="line">DataOutputStream outStream = new DataOutputStream(conn.getOutputStream());</span><br><span class="line">outStream.write(xmlbyte);//发送xml数据</span><br><span class="line">outStream.flush();</span><br><span class="line">if (conn.getResponseCode() != 200) throw new RuntimeException(&quot;请求url失败&quot;);</span><br><span class="line">InputStream is = conn.getInputStream();//获取返回数据</span><br><span class="line">String result = readAsString(is, &quot;UTF-8&quot;);</span><br><span class="line">outStream.close();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="7-Http协议上传文件"><a href="#7-Http协议上传文件" class="headerlink" title="7.Http协议上传文件"></a>7.Http协议上传文件</h2><ol>
<li>搭建服务器，完成上传功能</li>
<li>使用浏览器上传，查看请求信息</li>
</ol>
<p><strong>HttpURLConnection</strong></p>
<ol>
<li>通过URL封装路径打开一个HttpURLConnection</li>
<li>设置请求方式以及头字段：Content-Type、Content-Length、Host</li>
<li>拼接数据发送</li>
</ol>
<p><strong>Socket</strong></p>
<ol>
<li>使用HttpURLConnection发送时内部有缓存机制，如果上传较大文件会导致内存溢出</li>
<li>我们可以使用Socket发送TCP请求，将上传数据分段发送</li>
</ol>
<h2 id="8-发送Xml，访问WebService"><a href="#8-发送Xml，访问WebService" class="headerlink" title="8.发送Xml，访问WebService"></a>8.发送Xml，访问WebService</h2><p><strong>发送XML</strong></p>
<ol>
<li>通过URL封装路径打开一个HttpURLConnection</li>
<li>设置请求方式，Content-Type和Content-Length，XML文件的Content-Type为：text/xml;     charset=UTF-8</li>
<li>使用HttpURLConnection获取输出流输出数据<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder xml =  new StringBuilder();</span><br><span class="line">xml.append(&quot;&amp;lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot; ?&amp;gt;&quot;);</span><br><span class="line">xml.append(&quot;&amp;lt;M1 V=10000&amp;gt;&quot;);</span><br><span class="line">xml.append(&quot;&amp;lt;U I=1 D=\&quot;N73\&quot;&amp;gt;中国&amp;lt;/U&amp;gt;&quot;);</span><br><span class="line">xml.append(&quot;&amp;lt;/M1&amp;gt;&quot;);</span><br><span class="line">byte[] xmlbyte = xml.toString().getBytes(&quot;UTF-8&quot;);</span><br><span class="line">URL url = new URL(&quot;http://localhost:8080/ncist/contanctmanage.do?method=readxml&quot;);</span><br><span class="line">HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">conn.setConnectTimeout(5* 1000);</span><br><span class="line">conn.setDoOutput(true);//允许输出</span><br><span class="line">conn.setUseCaches(false);//不使用Cache</span><br><span class="line">conn.setRequestMethod(&quot;POST&quot;);	        </span><br><span class="line">conn.setRequestProperty(&quot;Connection&quot;, &quot;Keep-Alive&quot;);//维持长连接</span><br><span class="line">conn.setRequestProperty(&quot;Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">conn.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(xmlbyte.length));</span><br><span class="line">conn.setRequestProperty(&quot;Content-Type&quot;, &quot;text/xml; charset=UTF-8&quot;);</span><br><span class="line">DataOutputStream outStream = new DataOutputStream(conn.getOutputStream());</span><br><span class="line">outStream.write(xmlbyte);//发送xml数据</span><br><span class="line">outStream.flush();</span><br><span class="line">if (conn.getResponseCode() != 200) throw new RuntimeException(&quot;请求url失败&quot;);</span><br><span class="line">InputStream is = conn.getInputStream();//获取返回数据</span><br><span class="line">String result = readAsString(is, &quot;UTF-8&quot;);</span><br><span class="line">outStream.close();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>WebService</strong></p>
<ol>
<li>WebService是发布在网络上的API，可以通过发送XML调用，WebService返回结果也是XML数据</li>
<li>WebService没有语言限制，只要可以发送XML数据和接收XML数据即可</li>
<li><a href="http://www.webxml.com.cn" target="_blank" rel="noopener">http://www.webxml.com.cn</a> 网站上提供了一些WebService服务，我们可以对其进行调用</li>
<li><a href="http://webservice.webxml.com.cn/WebServices/MobileCodeWS.asmx?op=getMobileCodeInfo" target="_blank" rel="noopener">http://webservice.webxml.com.cn/WebServices/MobileCodeWS.asmx?op=getMobileCodeInfo</a> 中提供了电话归属地查询的使用说明<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png" alt=""></li>
</ol>
<h2 id="9-多线程断点续传"><a href="#9-多线程断点续传" class="headerlink" title="9.多线程断点续传"></a>9.多线程断点续传</h2><ol>
<li><p>在下载的时候多个线程并发可以占用服务器端更多资源，从而加快下载速度<br>使用多线程下载文件可以更快完成文件的下载，多线程下载文件之所以快，是因为其抢占的服务器资源多。如：假设服务器同时最多服务100个用户，在服务器中一条线程对应一个用户，100条线程在计算机中并非并发执行，而是由CPU划分时间片轮流执行，如果A应用使用了99条线程下载文件，那么相当于占用了99个用户的资源，假设一秒内CPU分配给每条线程的平均执行时间是10ms，A应用在服务器中一秒内就得到了990ms的执行时间，而其他应用在一秒内只有10ms的执行时间。就如同一个水龙头，每秒出水量相等的情况下，放990毫秒的水肯定比放10毫秒的水要多。</p>
</li>
<li><p>手机端下载数据时难免会出现无信号断线、电量不足等情况，所以需要断点续传功能</p>
</li>
<li>根据下载数据长度计算每个线程下载的数据位置，程序中开启多个线程并发下载</li>
<li>在请求头中设置Range字段就可以获取指定位置的数据，例如：Range: bytes=100-200</li>
<li>在下载过程中记录每个线程已拷贝数据的数量，如果下载中断，下次启动时从记录位置继续下载</li>
</ol>
<p><strong>多线程下载的实现过程</strong></p>
<ol>
<li><p>首先得到下载文件的长度，然后设置本地文件的长度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HttpURLConnection.getContentLength();</span><br><span class="line">RandomAccessFile file = new RandomAccessFile(&quot;QQWubiSetup.exe&quot;,&quot;rwd&quot;);</span><br><span class="line">file.setLength(filesize);//设置本地文件的长度</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据文件长度和线程数计算每条线程下载的数据长度和下载位置。如：文件的长度为6M，线程数为3，那么，每条线程下载的数据长度为2M，每条线程开始下载的位置如下图所示。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.31.43.png" alt=""></p>
</li>
<li><p>使用Http的Range头字段指定每条线程从文件的什么位置开始下载，下载到什么位置为止，如：指定从文件的2M位置开始下载，下载到位置(4M-1byte)为止，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HttpURLConnection.setRequestProperty(&quot;Range&quot;, &quot;bytes=2097152-4194303&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存文件，使用RandomAccessFile类指定每条线程从本地文件的什么位置开始写入数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RandomAccessFile threadfile = new RandomAccessFile(&quot;QQWubiSetup.exe &quot;,&quot;rwd&quot;);</span><br><span class="line">threadfile.seek(2097152);//从文件的什么位置开始写入数据</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>多线程下载</strong><br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.33.25.png" alt=""></p>
<ol>
<li>进度条使用&lt;Progress&gt;进行配置<br>默认为圆形进度条，水平进度条需要配置style属性，?android:attr/progressBarStyleHorizontal<br>使用android.R.attr.progressBarStyleHorizontal作为样式</li>
<li>当点击下载按钮时开启多线程下载，下载过程中修改进度条进度<br>设置最大刻度：setMax()<br>设置当前进度：setProgress()<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">public class FileDownLoader &#123;</span><br><span class="line">	@Test</span><br><span class="line">	public void download() throws Exception &#123;</span><br><span class="line">		String path = &quot;http://browse.babasport.com/QQWubiSetup.exe&quot;;</span><br><span class="line">		URL url = new URL(path);</span><br><span class="line">		HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">		conn.setConnectTimeout(5*1000);</span><br><span class="line">		conn.setRequestMethod(&quot;GET&quot;);</span><br><span class="line">		conn.setRequestProperty(&quot;Accept&quot;, &quot;image/gif, image/jpeg, image/pjpeg, image/pjpeg, application/x-shockwave-flash, application/xaml+xml, application/vnd.ms-xpsdocument, application/x-ms-xbap, application/x-ms-application, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*&quot;);</span><br><span class="line">		conn.setRequestProperty(&quot;Accept-Language&quot;, &quot;zh-CN&quot;);</span><br><span class="line">		conn.setRequestProperty(&quot;Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">		conn.setRequestProperty(&quot;User-Agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.2; Trident/4.0; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)&quot;);</span><br><span class="line">		conn.setRequestProperty(&quot;Connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">		System.out.println(conn.getResponseCode());</span><br><span class="line">		</span><br><span class="line">		int filesize = conn.getContentLength();//得到文件大小</span><br><span class="line">		conn.disconnect();</span><br><span class="line">		int threasize = 3;//线程数</span><br><span class="line">		int perthreadsize = filesize / 3 + 1;</span><br><span class="line">		RandomAccessFile file = new RandomAccessFile(&quot;102.wma&quot;,&quot;rw&quot;);</span><br><span class="line">		file.setLength(filesize);//设置本地文件的大小</span><br><span class="line">		file.close();</span><br><span class="line">		for(int i=0; i&lt;threasize ; i++)&#123;</span><br><span class="line">			int startpos = i * perthreadsize;//计算每条线程的下载位置</span><br><span class="line">			RandomAccessFile perthreadfile = new RandomAccessFile(&quot;102.wma&quot;,&quot;rw&quot;);</span><br><span class="line">			perthreadfile.seek(startpos);//从文件的什么位置开始写入数据</span><br><span class="line">			new DownladerThread(i, path, startpos, perthreadsize, perthreadfile).start();</span><br><span class="line">		&#125;</span><br><span class="line">		//以下代码要求用户输入q才会退出测试方法，如果没有下面代码，会因为进程结束而导致进程内的下载线程被销毁</span><br><span class="line">		int quit = System.in.read();</span><br><span class="line">		while(&apos;q&apos;!=quit)&#123;</span><br><span class="line">			Thread.sleep(2 * 1000);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	private class DownladerThread extends Thread&#123;</span><br><span class="line">		private int startpos;//从文件的什么位置开始下载</span><br><span class="line">		private int perthreadsize;//每条线程需要下载的文件大小</span><br><span class="line">		private String path;</span><br><span class="line">		private RandomAccessFile file;</span><br><span class="line">		private int threadid;</span><br><span class="line">		</span><br><span class="line">		public DownladerThread(int threadid, String path, int startpos, int perthreadsize, RandomAccessFile perthreadfile) &#123;</span><br><span class="line">			this.path = path;</span><br><span class="line">			this.startpos = startpos;</span><br><span class="line">			this.perthreadsize = perthreadsize;</span><br><span class="line">			this.file = perthreadfile;</span><br><span class="line">			this.threadid = threadid;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		@Override</span><br><span class="line">		public void run() &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">			URL url = new URL(path);</span><br><span class="line">			HttpURLConnection conn = (HttpURLConnection)url.openConnection();</span><br><span class="line">			conn.setConnectTimeout(5 * 1000);</span><br><span class="line">			conn.setRequestMethod(&quot;GET&quot;);</span><br><span class="line">			conn.setRequestProperty(&quot;Accept&quot;, &quot;image/gif, image/jpeg, image/pjpeg, image/pjpeg, application/x-shockwave-flash, application/xaml+xml, application/vnd.ms-xpsdocument, application/x-ms-xbap, application/x-ms-application, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*&quot;);</span><br><span class="line">			conn.setRequestProperty(&quot;Accept-Language&quot;, &quot;zh-CN&quot;);</span><br><span class="line">			conn.setRequestProperty(&quot;Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">			conn.setRequestProperty(&quot;Range&quot;, &quot;bytes=&quot; + this.startpos + &quot;-&quot;);</span><br><span class="line">			InputStream inStream = conn.getInputStream();</span><br><span class="line">			byte[] buffer = new byte[1024];</span><br><span class="line">			int len = 0;</span><br><span class="line">			int length = 0;</span><br><span class="line">			while(length&lt;perthreadsize &amp;&amp; (len = inStream.read(buffer))!=-1)&#123;</span><br><span class="line">				file.write(buffer, 0, len);</span><br><span class="line">				length += len;//累计该线程下载的总大小</span><br><span class="line">			&#125;</span><br><span class="line">			file.close();</span><br><span class="line">			inStream.close();</span><br><span class="line">			System.out.println(threadid+ &quot;线程完成下载&quot;);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>断点续传</strong></p>
<ol>
<li>断点续传需要在下载过程中记录每条线程的下载进度</li>
<li>每次下载开始之前先读取数据库,查询是否有未完成的记录，有就继续下载，没有则创建新记录插入数据库</li>
<li>在每次向文件中写入数据之后，在数据库中更新下载进度</li>
<li>下载完成之后删除数据库中下载记录</li>
</ol>
<p><strong>Handler传输数据</strong></p>
<ol>
<li>主线程中创建的View只能在主线程中修改，其他线程只能通过和主线程通信，在主线程中改变View数据</li>
<li>我们使用Handler可以处理这种需求<br>主线程中创建Handler，重写handleMessage()方法<br>新线程中使用Handler发送消息，主线程即可收到消息，并且执行handleMessage()方法</li>
</ol>
<p><strong>动态生成新View</strong></p>
<ol>
<li>创建XML文件，将要生成的View配置好</li>
<li>获取系统服务LayoutInflater，用来生成新的View<br>LayoutInflater inflater = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);</li>
<li>使用inflate(int resource, ViewGroup root)方法生成新的View</li>
<li>调用当前页面中某个容器的addView，将新创建的View添加进来</li>
</ol>
<hr>
<p>本文链接：<a href="http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html">http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    
      <div>
        
          
<div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center">
  <div>「真诚赞赏，手留余香」</div>
  <button id="rewardButton", disable="enable", onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}", style="cursor: pointer; border: 0; outline: 0; border-radius: 100%; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0px; text-shadow: none">
    <span onmouseover="this.style.color='rgb(236,96,0)';this.style.background='rgb(204,204,204)'" onMouseOut="this.style.color='#fff';this.style.background='rgb(236,96,0)'" style="display: inline-block; width: 70px; height: 70px; border-radius: 100%; line-height: 81px; color: #fff; font: 400 35px/75px 'microsofty'; background: rgb(236,96,0)">赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_pay.png" alt="Scott WeChat Pay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>微信打赏</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alibaba_pay.png" alt="Scott Alipay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>支付宝打赏</p>
      </div>
    

    

  </div>
</div>

        
      </div>
    

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      Scott
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html" title="Android基础5 网络通信">http://www.sguotao.top/Android基础-2012-06-15-android-basic-5.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <div>
      
        
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-8474352740015305",
    enable_page_level_ads: true
  });
</script>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"><i class="fa fa-tag"></i> Android</a>
          
            <a href="/tags/网络通信/" rel="tag"><i class="fa fa-tag"></i> 网络通信</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Android基础-2012-06-14-android-basic-4.html" rel="next" title="Android基础4 内容提供者（ContentProvider）">
                <i class="fa fa-chevron-left"></i> Android基础4 内容提供者（ContentProvider）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Android基础-2012-06-27-android-basic-6.html" rel="prev" title="Android基础6 活动(Activity)">
                Android基础6 活动(Activity) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODkyOC81NDk3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Scott" />
          <p class="site-author-name" itemprop="name">Scott</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">86</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/sguotao" target="_blank" rel="external nofollow" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-获取网络图片"><span class="nav-number">1.</span> <span class="nav-text">1. 获取网络图片</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-获取HTML代码"><span class="nav-number">2.</span> <span class="nav-text">2. 获取HTML代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-获取XML"><span class="nav-number">3.</span> <span class="nav-text">3. 获取XML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-获取Json"><span class="nav-number">4.</span> <span class="nav-text">4. 获取Json</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-发送Get请求"><span class="nav-number">5.</span> <span class="nav-text">5. 发送Get请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-发送Post请求"><span class="nav-number">6.</span> <span class="nav-text">6. 发送Post请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Http协议上传文件"><span class="nav-number">7.</span> <span class="nav-text">7.Http协议上传文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-发送Xml，访问WebService"><span class="nav-number">8.</span> <span class="nav-text">8.发送Xml，访问WebService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-多线程断点续传"><span class="nav-number">9.</span> <span class="nav-text">9.多线程断点续传</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Scott</span>
  <span class="with-love">
    <i class="fa fa-pencil"></i>
  </span>
  <span class="post-count">共写了192.2k字</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("iH9ug4Eu98bS8XiH30QEwODs-gzGzoHsz", "D0qgHUsqtcQOClhgS4ElkmDQ");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script>


  

</body>
</html>
