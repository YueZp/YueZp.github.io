<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Scott-小白" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="和光同尘,静水流深">
<meta property="og:type" content="website">
<meta property="og:title" content="Scott-小白">
<meta property="og:url" content="http://www.sguotao.com/page/3/index.html">
<meta property="og:site_name" content="Scott-小白">
<meta property="og:description" content="和光同尘,静水流深">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Scott-小白">
<meta name="twitter:description" content="和光同尘,静水流深">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.sguotao.com/page/3/"/>





  <title>Scott-小白</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?760edc77a59a2329550e2d68c6400d9b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Scott-小白</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/07/Android基础-2011-07-21-android-basic-11.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/07/Android基础-2011-07-21-android-basic-11.html" itemprop="url">
                  Android基础11 常用UI（上）
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-07-21T00:00:00+08:00">
                2011-07-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/07/Android基础-2011-07-21-android-basic-11.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/07/Android基础-2011-07-21-android-basic-11.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/07/Android基础-2011-07-21-android-basic-11.html" class="leancloud_visitors" data-flag-title="Android基础11 常用UI（上）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-单选框-RadioButton"><a href="#1-单选框-RadioButton" class="headerlink" title="1. 单选框(RadioButton)"></a>1. 单选框(RadioButton)</h2><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-11%20%E4%B8%8A%E5%8D%8810.40.44.png" alt="图片1"><br>要完成单选框显示，需要使用到RadioGroup和RadioButton(单选框)。</p>
<ol>
<li>RadioGroup用于对单选框进行分组，相同组内的单选框只有一个单选框能被选中。</li>
<li>RadioGroup.check(R.id.dotNet);将id名为dotNet的单选框设置成选中状态。</li>
<li>(RadioButton) findViewById(radioGroup.getCheckedRadioButtonId());//获取被选中的单选框。</li>
<li>RadioButton.getText();//获取单选框的值</li>
<li>调用setOnCheckedChangeListener()方法，处理单选框被选择事件，把RadioGroup.OnCheckedChangeListener实例作为参数传入<br>界面设计代码：</li>
</ol>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;RadioGroup android:<span class="built_in">id</span>=<span class="string">"@+id/radioGroup"</span></div><div class="line">  xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">  android:layout_width=<span class="string">"wrap_content"</span></div><div class="line">  android:layout_height=<span class="string">"wrap_content"</span>&gt;</div><div class="line">&lt;RadioButton android:<span class="built_in">id</span>=<span class="string">"@+id/java"</span></div><div class="line">        android:layout_width=<span class="string">"wrap_content"</span></div><div class="line">        android:layout_height=<span class="string">"wrap_content"</span></div><div class="line">        android:<span class="built_in">text</span>=<span class="string">"java"</span> /&gt;</div><div class="line">    &lt;RadioButton android:<span class="built_in">id</span>=<span class="string">"@+id/dotNet"</span></div><div class="line">        android:layout_width=<span class="string">"wrap_content"</span></div><div class="line">        android:layout_height=<span class="string">"wrap_content"</span></div><div class="line">        android:<span class="built_in">text</span>=<span class="string">"dotNet"</span> /&gt;</div><div class="line">    &lt;RadioButton android:<span class="built_in">id</span>=<span class="string">"@+id/php"</span></div><div class="line">        android:layout_width=<span class="string">"wrap_content"</span></div><div class="line">        android:layout_height=<span class="string">"wrap_content"</span></div><div class="line">        android:<span class="built_in">text</span>=<span class="string">"PHP"</span> /&gt;</div><div class="line">&lt;/RadioGroup&gt;</div></pre></td></tr></table></figure>
<p>处理程序：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="literal">void</span> onCreate(Bundle savedInstanceState) &#123;</div><div class="line">       <span class="params">...</span><span class="params">...</span></div><div class="line">        RadioGroup radioGroup = (RadioGroup) findViewById(R.id.radioGroup); </div><div class="line">        radioGroup.setOnCheckedChangeListener(<span class="literal">new</span> RadioGroup.OnCheckedChangeListener() &#123;</div><div class="line">            <span class="keyword">public</span> <span class="literal">void</span> onCheckedChanged(RadioGroup <span class="keyword">group</span>, int checkedId) &#123;</div><div class="line">                RadioButton radioButton = (RadioButton) findViewById(checkedId);</div><div class="line">                <span class="keyword">Log</span>.i(<span class="built_in">TAG</span>, <span class="built_in">String</span>.valueOf(radioButton.getText()));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-多选框-CheckBox"><a href="#2-多选框-CheckBox" class="headerlink" title="2. 多选框(CheckBox)"></a>2. 多选框(CheckBox)</h2><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-11%20%E4%B8%8A%E5%8D%8810.40.54.png" alt="图片2"></p>
<ol>
<li>每个多选框都是独立的，可以通过迭代所有多选框，然后根据其状态是否被选中再获取其值。</li>
<li>CheckBox.setChecked(true);//设置成选中状态。</li>
<li>CheckBox.getText();//获取多选框的值</li>
<li>调用setOnCheckedChangeListener()方法，处理多选框被选择事件，把CompoundButton.OnCheckedChangeListener实例作为参数传入。</li>
</ol>
<p>代码处理:</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> class CheckBoxActivity extends Activity &#123;</div><div class="line"><span class="keyword">private</span> List&lt;CheckBox&gt; checkboxs = <span class="keyword">new</span> ArrayList&lt;CheckBox&gt;();</div><div class="line">    @Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> onCreate(Bundle savedInstanceState) &#123;</div><div class="line">……</div><div class="line">        checkboxs.<span class="built_in">add</span>((CheckBox) findViewById(R.id.checkboxdotNet)); </div><div class="line">        checkboxs.<span class="built_in">add</span>((CheckBox) findViewById(R.id.checkboxjava)); </div><div class="line">        checkboxs.<span class="built_in">add</span>((CheckBox) findViewById(R.id.checkboxphp)); </div><div class="line">        checkboxs.<span class="built_in">get</span>(<span class="number">1</span>).setChecked(<span class="keyword">true</span>);<span class="comment">//设置成选中状态</span></div><div class="line">        <span class="keyword">for</span>(CheckBox <span class="built_in">box</span> : checkboxs)&#123;</div><div class="line">        	<span class="built_in">box</span>.setOnCheckedChangeListener(listener);</div><div class="line">        &#125;</div><div class="line">        Button button = (Button)findViewById(R.id.checkboxButton);</div><div class="line">        button.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;			</div><div class="line">	@Override</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> onClick(View v) &#123;</div><div class="line">		 List&lt;<span class="keyword">String</span>&gt; values = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;();</div><div class="line">		 <span class="keyword">for</span>(CheckBox <span class="built_in">box</span> : checkboxs)&#123;</div><div class="line">			<span class="keyword">if</span>(<span class="built_in">box</span>.isChecked())&#123;</div><div class="line">			    values.<span class="built_in">add</span>(<span class="built_in">box</span>.getText().toString());</div><div class="line">			&#125;</div><div class="line">		 &#125;</div><div class="line">		 Toast.makeText(CheckBoxActivity.<span class="keyword">this</span>, values.toString(), <span class="number">1</span>).show();</div><div class="line">	&#125;&#125;);</div><div class="line">   &#125;</div><div class="line">  CompoundButton.OnCheckedChangeListener listener = <span class="keyword">new</span> CompoundButton.OnCheckedChangeListener() &#123;	@Override</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> onCheckedChanged(CompoundButton buttonView, <span class="built_in">boolean</span> isChecked) &#123;</div><div class="line">	CheckBox checkBox = (CheckBox) buttonView;</div><div class="line">	Log.i(TAG, <span class="string">"isChecked="</span>+ isChecked +<span class="string">",value="</span>+ checkBox.getText());<span class="comment">//输出单选框的值</span></div><div class="line">	&#125; &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-下拉列表框-Spinner"><a href="#3-下拉列表框-Spinner" class="headerlink" title="3. 下拉列表框(Spinner)"></a>3. 下拉列表框(Spinner)</h2><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-11%20%E4%B8%8A%E5%8D%8810.41.04.png" alt="图片3"></p>
<ol>
<li>Spinner.getItemAtPosition(Spinner.getSelectedItemPosition());获取下拉列表框的值</li>
<li>调用setOnItemSelectedListener()方法，处理下拉列表框被选择事件，把AdapterView.OnItemSelectedListener实例作为参数传入。</li>
</ol>
<p>代码处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinnerActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		……</div><div class="line">      <span class="comment">//第二个参数为下拉列表框每一项的界面样式，该界面样式由Android系统提供，当然您也可以自定义</span></div><div class="line">        ArrayAdapter&lt;String&gt; adapter = <span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>, android.R.layout.simple_spinner_item);</div><div class="line">        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);</div><div class="line">        adapter.add(<span class="string">"java"</span>);</div><div class="line">        adapter.add(<span class="string">"dotNet"</span>);</div><div class="line">        adapter.add(<span class="string">"php"</span>);</div><div class="line">        Spinner spinner = (Spinner) findViewById(R.id.spinner);</div><div class="line">        spinner.setAdapter(adapter);</div><div class="line">        spinner.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; adapterView, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">		Spinner spinner = (Spinner)adapterView;</div><div class="line">		String itemContent = (String)adapterView.getItemAtPosition(position);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; view)</span> </span>&#123;</div><div class="line">		Log.i(TAG,  view.getClass().getName());</div><div class="line">	&#125;  &#125;);   &#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="3-1-下拉列表框—采用javabean作为Adapter元素"><a href="#3-1-下拉列表框—采用javabean作为Adapter元素" class="headerlink" title="3.1 下拉列表框—采用javabean作为Adapter元素"></a>3.1 下拉列表框—采用javabean作为Adapter元素</h3><p>很多时候显示在下拉列表框的值并不是希望得到的值，如果要做一个联系人下拉列表框，列表框列出的是联系人的姓名，因为姓名有可能相同，所以我们希望得到的值应该为该联系人的id，要实现这种需求我们需要自定义Adapter，当然自定义Adapter需要我们编写一小段代码，如果我们不想编写Adapter，又能实现我们的需求，那是最好不过的了。通过观察ArrayAdapter中getView(int position, View convertView, ViewGroup parent)的内部代码发现，如果为ArrayAdapter指定的实际泛型参数类型没有实现CharSequence（字符串）接口，将会调用该类型对象的toString()向下拉列表框输出显示值。利用这个特点我们可以重写javaBean的toString()向下拉列表框提供显示值。</p>
<p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-11%20%E4%B8%8A%E5%8D%8810.41.14.png" alt="图片4"><br>代码处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinnerActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SpinnerActivity"</span>;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.spinner); </div><div class="line">        ArrayAdapter&lt;Person&gt; adapter = <span class="keyword">new</span> ArrayAdapter&lt;Person&gt;(<span class="keyword">this</span>, android.R.layout.simple_spinner_item);</div><div class="line">        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);</div><div class="line">        adapter.add(<span class="keyword">new</span> Person(<span class="number">12</span>, <span class="string">"李明"</span>));</div><div class="line">        adapter.add(<span class="keyword">new</span> Person(<span class="number">100</span>, <span class="string">"李明"</span>));</div><div class="line">        adapter.add(<span class="keyword">new</span> Person(<span class="number">62</span>, <span class="string">"张天"</span>));</div><div class="line">        Spinner spinner = (Spinner) findViewById(R.id.spinner);</div><div class="line">        spinner.setAdapter(adapter);</div><div class="line">        spinner.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; adapterView, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">		Spinner spinner = (Spinner)adapterView;</div><div class="line">		Person person = (Person)adapterView.getItemAtPosition(position);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; view)</span> </span>&#123;</div><div class="line">		Log.i(TAG,  view.getClass().getName());</div><div class="line">	&#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">Person.java:</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Integer id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(Integer id, String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">	……</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-下拉列表框–自定义选项界面样式"><a href="#3-2-下拉列表框–自定义选项界面样式" class="headerlink" title="3.2 下拉列表框–自定义选项界面样式"></a>3.2 下拉列表框–自定义选项界面样式</h3><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-11%20%E4%B8%8A%E5%8D%8810.41.27.png" alt="图片5"></p>
<ol>
<li>Spinner.getItemAtPosition(Spinner.getSelectedItemPosition());获取下拉列表框的值</li>
<li>调用setOnItemSelectedListener()方法，处理下拉列表框被选择事件，把AdapterView.OnItemSelectedListener实例作为参数传入。</li>
</ol>
<p>下拉列表框每一项的界面样式:stylespinner.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">   <span class="attr">android:id</span>=<span class="string">"@+id/contentTextView"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span> </div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> </div><div class="line">    <span class="attr">android:background</span>=<span class="string">"#F4FDFF"</span> /&gt;</div></pre></td></tr></table></figure>
<p>代码处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinnerActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SpinnerActivity"</span>;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.spinner); </div><div class="line">         <span class="comment">//第二个参数为layout文件在R文件的id,第三个参数为TextView在layout文件的id</span></div><div class="line">    ArrayAdapter&lt;String&gt; adapter = <span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>, R.layout.stylespinner,R.id.contentTextView);</div><div class="line">        adapter.add(<span class="string">"java"</span>);</div><div class="line">        adapter.add(<span class="string">"dotNet"</span>);</div><div class="line">        adapter.add(<span class="string">"php"</span>);</div><div class="line">        Spinner spinner = (Spinner) findViewById(R.id.spinner);</div><div class="line">        spinner.setAdapter(adapter);</div><div class="line">        spinner.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; adapterView, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">		Spinner spinner = (Spinner)adapterView;</div><div class="line">		String itemContent = (String)adapterView.getItemAtPosition(position);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; view)</span> </span>&#123;</div><div class="line">		Log.i(TAG,  view.getClass().getName());</div><div class="line">	&#125; &#125;);</div><div class="line">    &#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-总结"><a href="#3-3-总结" class="headerlink" title="3.3 总结"></a>3.3 总结</h3><p>实现spinner的步骤：</p>
<ol>
<li>定义<spinner>标签</spinner></li>
<li>创建一个适配器</li>
<li>获取Spinner标签，调用setAdapter(SpinnerAdapter adapter)方法设置一个适配器</li>
<li>调用setOnItemSelectedListener(OnItemSelectedListener listener)方法设置监听器监听选中事件</li>
<li>Spinner适配器的数据来源：</li>
</ol>
<p>1)    使用字符串构建适配器</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ArrayAdapter&lt;<span class="keyword">String</span>&gt; adapter = <span class="keyword">new</span> ArrayAdapter&lt;<span class="keyword">String</span>&gt;(<span class="keyword">this</span>, android.R.layout.simple_spinner_item);</div><div class="line">adapter.<span class="built_in">add</span>(<span class="string">"Java"</span>);</div><div class="line">adapter.<span class="built_in">add</span>(<span class="string">".NET"</span>);</div><div class="line">adapter.<span class="built_in">add</span>(<span class="string">"PHP"</span>);</div></pre></td></tr></table></figure>
<p>2)    使用JavaBean构建适配器</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ArrayAdapter&lt;User&gt; adapter = <span class="keyword">new</span> <span class="type">ArrayAdapter</span>&lt;User&gt;(<span class="built_in">this</span>, android.R.layout.simple_spinner_item);</div><div class="line">adapter.add(<span class="keyword">new</span> <span class="type">User</span>(<span class="number">1</span>, <span class="string">"lhm"</span>, <span class="string">"lhm@ncist.cn"</span>));</div><div class="line">adapter.add(<span class="keyword">new</span> <span class="type">User</span>(<span class="number">2</span>, <span class="string">"yzk"</span>, <span class="string">"yzk@ncist.cn"</span>));</div><div class="line">adapter.add(<span class="keyword">new</span> <span class="type">User</span>(<span class="number">3</span>, <span class="string">"hsp"</span>, <span class="string">"hsp@ncist.cn"</span>));</div></pre></td></tr></table></figure>
<p>3)    使用资源文件构建适配器</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ArrayAdapter&lt;CharSequence&gt; adapter = ArrayAdapter.createFromResource(<span class="keyword">this</span>, R.<span class="built_in">array</span>.names, android.R.layout.simple_spinner_item);</div></pre></td></tr></table></figure>
<p>4)    自定义适配器样式</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ArrayAdapter&lt;<span class="keyword">String</span>&gt; adapter = <span class="keyword">new</span> <span class="type">ArrayAdapter</span>&lt;<span class="keyword">String</span>&gt;(<span class="built_in">this</span>, R.layout.custom, R.id.content);</div><div class="line"><span class="comment">//R.layout.custom 布局文件ID ，R.id.content 哪一个组件用来显示文本</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/07/Android基础-2011-07-15-android-basic-10.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/07/Android基础-2011-07-15-android-basic-10.html" itemprop="url">
                  Android基础10 通知
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-07-15T00:00:00+08:00">
                2011-07-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/07/Android基础-2011-07-15-android-basic-10.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/07/Android基础-2011-07-15-android-basic-10.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/07/Android基础-2011-07-15-android-basic-10.html" class="leancloud_visitors" data-flag-title="Android基础10 通知">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于通知的文档位置：android-sdk-windows/docs/guide/topics/ui/notifiers/index.html</p>
<h2 id="1-土司通知"><a href="#1-土司通知" class="headerlink" title="1. 土司通知"></a>1. 土司通知</h2><p>a)    创建通知</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Toast.makeText(Context context, CharSequence <span class="built_in">text</span>, <span class="built_in">int</span> <span class="built_in">duration</span>)</div><div class="line">Toast.makeText(Context context, <span class="built_in">int</span> resId, <span class="built_in">int</span> <span class="built_in">duration</span>)</div></pre></td></tr></table></figure>
<p>b)    发送通知  show()</p>
<h2 id="2-状态栏通知"><a href="#2-状态栏通知" class="headerlink" title="2. 状态栏通知"></a>2. 状态栏通知</h2><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.38.30.png" alt="图片1"></p>
<p>通知用于在状态栏显示消息，消息到来时以图标方式表示，如果需要查看消息，可以拖动状态栏到屏幕下方即可查看消息。发送消息的代码如下：</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取通知管理器</span></div><div class="line">NotificationManager mNotificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</div><div class="line"><span class="keyword">int</span> icon = android.R.drawable.stat_notify_chat;</div><div class="line"><span class="built_in">long</span> when = System.currentTimeMillis();</div><div class="line"><span class="comment">//新建一个通知，指定其图标和标题</span></div><div class="line"><span class="comment">//第一个参数为图标,第二个参数为短暂提示标题,第三个为通知时间</span></div><div class="line">Notification notification = <span class="keyword">new</span> Notification(icon, <span class="literal">null</span>, when); </div><div class="line">notification.defaults = Notification.DEFAULT_SOUND;<span class="comment">//发出默认声音</span></div><div class="line">Intent openintent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, OtherActivity.<span class="keyword">class</span>);</div><div class="line"><span class="comment">//当点击消息时就会向系统发送openintent意图，点击时发送</span></div><div class="line">PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, openintent, <span class="number">0</span>);</div><div class="line"><span class="comment">//设置通知点击事件</span></div><div class="line">notification.setLatestEventInfo(<span class="keyword">this</span>, “标题”, “我是内容<span class="string">", contentIntent);</span></div><div class="line">//发送消息，第一个参数为自定义的通知唯一标识</div><div class="line">mNotificationManager.notify(0, notification); </div><div class="line">注意：设置通知点击后清除，设置Notification 对象属性 </div><div class="line">n.flags = Notification.FLAG_AUTO_CANCEL;</div></pre></td></tr></table></figure>
<h2 id="3-对话框通知"><a href="#3-对话框通知" class="headerlink" title="3. 对话框通知"></a>3. 对话框通知</h2><h3 id="3-1-普通对话框"><a href="#3-1-普通对话框" class="headerlink" title="3.1 普通对话框"></a>3.1 普通对话框</h3><p>当应用需要显示一个进度条或需要用户对信息进行确认时，可以使用对话框来完成。下面代码将打开一个如图所示的对话框：代码采用的是一个链式调用，像setTitle()、setMessage()这些方法，他们的返回值都是当前对话框对象。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> AlertDialog.Builder(context)</div><div class="line">	.setTitle(<span class="string">"java培训"</span>)</div><div class="line">	.setCancelable(<span class="keyword">false</span>) <span class="comment">//设置不能通过“后退”按钮关闭对话框</span></div><div class="line">	.setMessage(<span class="string">"浏览华北科技网站?"</span>)</div><div class="line">	.setPositiveButton(<span class="string">"确认"</span>,</div><div class="line">		<span class="keyword">new</span> DialogInterface.OnClickListener()&#123;</div><div class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialoginterface, <span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">	    	    Uri uri = Uri.parse(<span class="string">"http://www.ncist.cn/"</span>);<span class="comment">//打开链接</span></div><div class="line">	    	    Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW, uri);</div><div class="line">	    	    startActivity(intent);</div><div class="line">	    	&#125;</div><div class="line">	&#125;)</div><div class="line">	.setNegativeButton(<span class="string">"取消"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">        	  	 <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">               			 dialog.cancel();</div><div class="line">        	 	  &#125;</div><div class="line">    	&#125;)</div><div class="line">   	 .show();<span class="comment">//显示对话框</span></div></pre></td></tr></table></figure>
<h3 id="3-2-选项列表的对话框"><a href="#3-2-选项列表的对话框" class="headerlink" title="3.2 选项列表的对话框"></a>3.2 选项列表的对话框</h3><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.38.50.png" alt="图片3"><br>下面代码将打开一个如图所示的选项列表对话框：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> String[] items = &#123;<span class="string">"java"</span>, <span class="string">".net"</span>, <span class="string">"php"</span>&#125;;</div><div class="line"><span class="keyword">new</span> AlertDialog.Builder(SenderNotificationActivity.<span class="keyword">this</span>).setTitle(<span class="string">"选择语言"</span>)</div><div class="line">	.setItems(items, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">	    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">	            Toast.makeText(getApplicationContext(), items[item], </div><div class="line">		Toast.LENGTH_SHORT).show();</div><div class="line">	    &#125;</div><div class="line">	&#125;).show();<span class="comment">//显示对话框</span></div></pre></td></tr></table></figure>
<h3 id="3-3-带单选框列表对话框"><a href="#3-3-带单选框列表对话框" class="headerlink" title="3.3 带单选框列表对话框"></a>3.3 带单选框列表对话框</h3><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.38.57.png" alt="图片4"><br>下面代码将打开一个如图所示的带单选框的列表对话框：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> String[] items = &#123;<span class="string">"java"</span>, <span class="string">".net"</span>, <span class="string">"php"</span>&#125;;</div><div class="line"><span class="comment">//setSingleChoiceItems()的第二个参数是设置默认选项，选项索引从0开始，-1代表不选择任何选项。</span></div><div class="line"><span class="keyword">new</span> AlertDialog.Builder(SenderNotificationActivity.<span class="keyword">this</span>).setTitle(<span class="string">"选择语言"</span>)</div><div class="line">.setSingleChoiceItems(items, <span class="number">1</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">	 <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> item)</span> </span>&#123;</div><div class="line">	        Toast.makeText(getApplicationContext(), items[item], </div><div class="line">		Toast.LENGTH_SHORT).show();</div><div class="line">	        dialog.cancel();</div><div class="line">	  &#125;</div><div class="line">&#125;).show();<span class="comment">//显示对话框</span></div></pre></td></tr></table></figure>
<h3 id="3-4-带多选项列表的对话框"><a href="#3-4-带多选项列表的对话框" class="headerlink" title="3.4 带多选项列表的对话框"></a>3.4 带多选项列表的对话框</h3><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.39.05.png" alt="图片6"><br>下面代码将打开一个如图所示的多选项列表对话框：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> String[] items = &#123;<span class="string">"java"</span>, <span class="string">".net"</span>, <span class="string">"php"</span>&#125;;</div><div class="line"><span class="keyword">new</span> AlertDialog.Builder(SenderNotificationActivity.<span class="keyword">this</span>).setCancelable(<span class="keyword">false</span>)</div><div class="line">.setTitle(<span class="string">"选择语言"</span>)</div><div class="line">.setMultiChoiceItems(items, <span class="keyword">new</span> <span class="keyword">boolean</span>[]&#123;<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>&#125;, <span class="keyword">new</span> DialogInterface.OnMultiChoiceClickListener() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which, <span class="keyword">boolean</span> isChecked)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span>(isChecked)&#123;</div><div class="line">		Toast.makeText(getApplicationContext(), items[which], </div><div class="line">			Toast.LENGTH_SHORT).show();</div><div class="line">		&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;)</div><div class="line">.setPositiveButton(<span class="string">"确认"</span>,<span class="keyword">new</span> DialogInterface.OnClickListener()&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialoginterface, <span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">		dialoginterface.dismiss();</div><div class="line">	 &#125;</div><div class="line">&#125;)</div><div class="line">.show();<span class="comment">//显示对话框</span></div></pre></td></tr></table></figure>
<h3 id="3-5-进度对话框"><a href="#3-5-进度对话框" class="headerlink" title="3.5 进度对话框"></a>3.5 进度对话框</h3><p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.39.16.png" alt="图片7"><br>调用setProgressStyle()方法设置进度对话框风格。有两种风格：<br>     ProgressDialog.STYLE_SPINNER 旋体进度条风格 (为默认风格)<br>     ProgressDialog.STYLE_HORIZONTAL 横向进度条风格</p>
<p>下面代码将打开一个如图所示的一个进度对话框：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProgressDialogActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> ProgressDialog progressDialog;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.menu); </div><div class="line">        <span class="comment">//开始一条专门处理耗时工作的线程</span></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</div><div class="line">	        <span class="meta">@Override</span></div><div class="line">	        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	       <span class="keyword">try</span> &#123;</div><div class="line">			Thread.sleep(<span class="number">5</span>*<span class="number">1000</span>);<span class="comment">//假设这项工作需要5秒才能完成</span></div><div class="line">			progressDialog.dismiss();<span class="comment">//关闭进程对话框</span></div><div class="line">			<span class="comment">//runOnUiThread(finishDialog);//要求运行在UI线程</span></div><div class="line">		   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">	        &#125;</div><div class="line">        &#125;).start();        </div><div class="line">       progressDialog = ProgressDialog.show(ProgressDialogActivity.<span class="keyword">this</span>, <span class="string">"请稍等"</span>, <span class="string">"数据正在加载中..."</span>, <span class="keyword">true</span>);</div><div class="line">   &#125;	</div><div class="line">   <span class="keyword">private</span> Runnable finishDialog = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;           </div><div class="line">        	progressDialog.dismiss();</div><div class="line">        &#125;</div><div class="line">   &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>横向进度条风格的对话框</p>
<p><img src="http://obovytgzz.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.39.26.png" alt="图片8"></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ProgressDialog <span class="built_in">dialog</span> = new ProgressDialog(this);</div><div class="line"><span class="built_in">dialog</span>.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);	<span class="comment">// 设置进度条样式</span></div><div class="line"><span class="built_in">dialog</span>.setTitle(<span class="string">"下载中"</span>);</div><div class="line"><span class="built_in">dialog</span>.setMessage(<span class="string">"请稍候..."</span>);</div><div class="line"><span class="built_in">dialog</span>.setCancelable(<span class="literal">false</span>);</div><div class="line"><span class="built_in">dialog</span>.setMax(<span class="number">100</span>);</div><div class="line"><span class="built_in">dialog</span>.show();</div><div class="line"><span class="built_in">dialog</span>.setProgress(<span class="number">10</span>);		<span class="comment">// 设置进度</span></div><div class="line"><span class="built_in">dialog</span>.dismiss();		<span class="comment">// 对话框结束</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/07/Android基础-2011-07-09-android-basic-9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/07/Android基础-2011-07-09-android-basic-9.html" itemprop="url">
                  Android基础9 多媒体
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-07-09T00:00:00+08:00">
                2011-07-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/07/Android基础-2011-07-09-android-basic-9.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/07/Android基础-2011-07-09-android-basic-9.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/07/Android基础-2011-07-09-android-basic-9.html" class="leancloud_visitors" data-flag-title="Android基础9 多媒体">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-录音机"><a href="#1-录音机" class="headerlink" title="1.  录音机"></a>1.  录音机</h2><p>使用手机进行现场录音，实现步骤如下：<br>a)    在功能清单文件AndroidManifest.xml中添加音频刻录权限：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.RECORD_AUDIO"</span>/&gt;</div></pre></td></tr></table></figure>
<p>b)    编写音频刻录代码:</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="type">MediaRecorder</span> recorder = <span class="function"><span class="keyword">new</span> <span class="title">MediaRecorder</span>();</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">setAudioSource</span>(<span class="type">MediaRecorder</span>.<span class="type">AudioSource</span>.<span class="type">MIC</span>);<span class="comment">//从麦克风采集声音</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">setOutputFormat</span>(<span class="type">MediaRecorder</span>.<span class="type">OutputFormat</span>.<span class="type">THREE_GPP</span>);<span class="comment">//内容输出格式</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">setAudioEncoder</span>(<span class="type">MediaRecorder</span>.<span class="type">AudioEncoder</span>.<span class="type">AMR_NB</span>);<span class="comment">//音频编码方式</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">setOutputFile</span>("/mnt/sdcard/ncist.amr");</div><div class="line"> <span class="title">recorder</span>.<span class="title">prepare</span>();<span class="comment">//预期准备</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">start</span>();   <span class="comment">//开始刻录</span></div><div class="line"> ...</div><div class="line"> <span class="title">recorder</span>.<span class="title">stop</span>();<span class="comment">//停止刻录</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">reset</span>();   <span class="comment">//重设</span></div><div class="line"> <span class="title">recorder</span>.<span class="title">release</span>(); <span class="comment">//刻录完成一定要释放资源</span></div></pre></td></tr></table></figure>
<h2 id="2-音频播放器"><a href="#2-音频播放器" class="headerlink" title="2. 音频播放器"></a>2. 音频播放器</h2><p><img src="http://7u2np3.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.18.40.png" alt="图片1"></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">MediaPlayer mediaPlayer = <span class="keyword">new</span> MediaPlayer();</div><div class="line"><span class="built_in">if</span> (mediaPlayer.isPlaying()) &#123;</div><div class="line">   mediaPlayer.reset();<span class="comment">//重置为初始状态</span></div><div class="line">&#125;</div><div class="line">mediaPlayer.setDataSource(<span class="string">"/mnt/sdcard/god.mp3"</span>);</div><div class="line">mediaPlayer.<span class="built_in">prepare</span>();				</div><div class="line">mediaPlayer.start();<span class="comment">//开始或恢复播放</span></div><div class="line">mediaPlayer.pause();<span class="comment">//暂停播放</span></div><div class="line">mediaPlayer.start();<span class="comment">//恢复播放</span></div><div class="line">mediaPlayer.<span class="built_in">stop</span>();<span class="comment">//停止播放</span></div><div class="line">mediaPlayer.<span class="built_in">release</span>();<span class="comment">//释放资源</span></div><div class="line">mediaPlayer.setOnCompletionListener(<span class="keyword">new</span> MediaPlayer.OnCompletionListener() &#123;<span class="comment">//播出完毕事件</span></div><div class="line">       @Override </div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> onCompletion(MediaPlayer arg0) &#123;</div><div class="line">	    mediaPlayer.<span class="built_in">release</span>();</div><div class="line">        &#125;</div><div class="line">&#125;);</div><div class="line">mediaPlayer.setOnErrorListener(<span class="keyword">new</span> MediaPlayer.OnErrorListener() &#123;<span class="comment">// 错误处理事件</span></div><div class="line">         @Override </div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> onError(MediaPlayer player, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2) &#123;</div><div class="line">		mediaPlayer.<span class="built_in">release</span>();</div><div class="line">		<span class="built_in">return</span> false;</div><div class="line">         &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="3-使用soundpool播放音效"><a href="#3-使用soundpool播放音效" class="headerlink" title="3. 使用soundpool播放音效"></a>3. 使用soundpool播放音效</h2><p>在Android开发中我们经常使用MediaPlayer来播放音频文件，但是MediaPlayer存在一些不足，例如：资源占用量较高、延迟时间较长、不支持多个音频同时播放等。这些缺点决定了MediaPlayer在某些场合的使用情况不会很理想，例如在对时间精准度要求相对较高的游戏开发中。在游戏开发中我们经常需要播放一些游戏音效（比如：子弹爆炸，物体撞击等），这些音效的共同特点是短促、密集、延迟程度小。在这样的场景下，我们可以使用SoundPool代替MediaPlayer来播放这些音效。 </p>
<p>SoundPool（android.media.SoundPool），顾名思义是声音池的意思，主要用于播放一些较短的声音片段，支持从程序的资源或文件系统加载。与MediaPlayer相比，SoundPool的优势在于CPU资源占用量低和反应延迟小。另外，SoundPool还支持自行设置声音的品质、音量、播放比率等参数，支持通过ID对多个音频流进行管理。就现在已知的资料来说，SoundPool有一些设计上的BUG，从固件版本1.0开始有些还没有修复，我们在使用中应该小心再小心。相信将来Google会修复这些问题，但我们最好还是列出来：</p>
<ol>
<li>SoundPool最大只能申请1M的内存空间，这就意味着我们只能用一些很短的声音片段，而不是用它来播放歌曲或者做游戏背景音乐。</li>
<li>SoundPool提供了pause和stop方法，但这些方法建议最好不要轻易使用，因为有些时候它们可能会使你的程序莫名其妙的终止.建议使用这两个方法的时候尽可能多做测试工作，还有些朋友反映它们不会立即中止播放声音,而是把缓冲区里的数据播放完才会停下来,也许会多播放一秒钟。</li>
<li>SoundPool的效率问题。其实SoundPool的效率在这些播放类中算是很好的了，但是有的朋友在G1中测试它还是有100ms左右的延迟，这可能会影响用户体验。也许这不能管SoundPool本身，因为到了性能比较好的Droid中这个延迟就可以让人接受了。</li>
</ol>
<p>在现阶段SoundPool有这些缺陷，但也有着它不可替代的优点，基于这些建议大家<br><strong>在如下情况中多使用SoundPool</strong><br>a)    应用程序中的声效(按键提示音，消息等)<br>b)    游戏中密集而短暂的声音(如多个飞船同时爆炸)</p>
<p><strong>开发步骤</strong><br>a)    往项目的res/raw目录中放入音效文件。<br>b)    新建SoundPool对象，然后调用SoundPool.load()加载音效，调用SoundPool.play()播放指定音效文件。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AudioActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> <span class="type">SoundPool</span> pool;</div><div class="line"><span class="meta">@Override</span></div><div class="line">public void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</div><div class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">	setContentView(<span class="type">R</span>.layout.main);</div><div class="line">	<span class="comment">//指定声音池的最大音频流数目为10，声音品质为5</span></div><div class="line">	pool = <span class="keyword">new</span> <span class="type">SoundPool</span>(<span class="number">10</span>, <span class="type">AudioManager</span>.<span class="type">STREAM_SYSTEM</span>, <span class="number">5</span>);</div><div class="line">	<span class="keyword">final</span> int sourceid = pool.load(<span class="keyword">this</span>, <span class="type">R</span>.raw.pj, <span class="number">0</span>);<span class="comment">//载入音频流，返回在池中的id</span></div><div class="line">	<span class="type">Button</span> button = (<span class="type">Button</span>)<span class="keyword">this</span>.findViewById(<span class="type">R</span>.id.button);</div><div class="line">	button.setOnClickListener(<span class="keyword">new</span> <span class="type">View</span>.<span class="type">OnClickListener</span>() &#123;</div><div class="line">		public void onClick(<span class="type">View</span> v) &#123;</div><div class="line">		<span class="comment">//播放音频，第二个参数为左声道音量;</span></div><div class="line">				第三个参数为右声道音量;</div><div class="line">				第四个参数为优先级；</div><div class="line">第五个参数为循环次数，<span class="number">0</span>不循环，<span class="number">-1</span>循环;第六个参数为速率，速率最低<span class="number">0.5</span>最高为<span class="number">2</span>，<span class="number">1</span>代表正常速度</div><div class="line">			pool.play(sourceid, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-视频播放器"><a href="#4-视频播放器" class="headerlink" title="4. 视频播放器"></a>4. 视频播放器</h2><p><img src="http://7u2np3.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-10%20%E4%B8%8B%E5%8D%886.18.54.png" alt="图片2"></p>
<p>a)    在main.xml布局文件添加用于视频画面绘制的SurfaceView 控件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;SurfaceView <span class="string">android:</span>layout_width=<span class="string">"fill_parent"</span> <span class="string">android:</span>layout_height=<span class="string">"240dip"</span> <span class="string">android:</span>id=<span class="string">"@+id/surfaceView"</span> /&gt;</div></pre></td></tr></table></figure>
<p>b)    在Activity中</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="type">SurfaceView</span> surfaceView = (<span class="type">SurfaceView</span>)<span class="literal">this</span>.findViewById(<span class="type">R</span>.id.surfaceView);</div><div class="line">surfaceView.getHolder().setFixedSize(<span class="number">176</span>, <span class="number">144</span>);	<span class="comment">//设置分辨率</span></div><div class="line"><span class="comment">/*下面设置Surface不维护自己的缓冲区，而是等待屏幕的渲染引擎将内容推送到用户面前*/</span></div><div class="line">surfaceView.getHolder().setType(<span class="type">SurfaceHolder</span>.<span class="type">SURFACE_TYPE_PUSH_BUFFERS</span>);</div><div class="line"><span class="type">MediaPlayer</span> mediaPlayer = <span class="function"><span class="keyword">new</span> <span class="title">MediaPlayer</span>();</span></div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">reset</span>();<span class="comment">//重置为初始状态</span></div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">setAudioStreamType</span>(<span class="type">AudioManager</span>.<span class="type">STREAM_MUSIC</span>);</div><div class="line">/* 设置<span class="title">Video</span>影片以<span class="title">SurfaceHolder</span>播放 */</div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">setDisplay</span>(surfaceView.getHolder());</div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">setDataSource</span>("/mnt/sdcard/oppo.mp4");</div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">prepare</span>();				</div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">start</span>();<span class="comment">//播放</span></div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">pause</span>();<span class="comment">//暂停播放</span></div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">start</span>();<span class="comment">//恢复播放</span></div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">stop</span>();<span class="comment">//停止播放</span></div><div class="line"><span class="title">mediaPlayer</span>.<span class="title">release</span>();<span class="comment">//释放资源</span></div></pre></td></tr></table></figure>
<h2 id="5-拍照"><a href="#5-拍照" class="headerlink" title="5. 拍照"></a>5. 拍照</h2><p>a)    在main.xml布局文件添加用于显示取景画面的SurfaceView 控件：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;SurfaceView <span class="string">android:</span>layout_width=<span class="string">"fill_parent"</span> <span class="string">android:</span>layout_height=<span class="string">"240dip"</span> <span class="string">android:</span>id=<span class="string">"@+id/surfaceView"</span> /&gt;</div></pre></td></tr></table></figure>
<p>b)    在Activity中</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">SurfaceView surfaceView = (SurfaceView)this.findViewById(R.id.surfaceView);</div><div class="line">surfaceView.getHolder().setFixedSize(<span class="number">176</span>, <span class="number">144</span>);	<span class="comment">//设置分辨率</span></div><div class="line"><span class="comment">/*下面设置Surface不维护自己的缓冲区，而是等待屏幕的渲染引擎将内容推送到用户面前*/</span></div><div class="line">surfaceView.getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);</div><div class="line"><span class="comment">//打开摄像头SDK2.3之后支持前置摄像头，open方法可以接收一个int参数，用来指定哪个摄像头</span></div><div class="line">Camera camera = Camera.open();</div><div class="line">WindowManager wm = (WindowManager) getSystemService(Context.WINDOW_SERVICE);</div><div class="line"><span class="keyword">Display</span> <span class="keyword">display</span> = wm.getDefaultDisplay();</div><div class="line">Camera.Parameters <span class="keyword">parameters</span> = camera.getParameters();</div><div class="line"><span class="keyword">parameters</span>.setPreviewSize(display.getWidth(), display.getHeight());<span class="comment">//设置预览照片的大小</span></div><div class="line"><span class="keyword">parameters</span>.setPreviewFrameRate(3);<span class="comment">//每秒3帧</span></div><div class="line"><span class="keyword">parameters</span>.setPictureFormat(PixelFormat.JPEG);<span class="comment">//设置照片的输出格式</span></div><div class="line"><span class="keyword">parameters</span>.<span class="keyword">set</span>(<span class="string">"jpeg-quality"</span>, 85);<span class="comment">//照片质量</span></div><div class="line"><span class="keyword">parameters</span>.setPictureSize(display.getWidth(), display.getHeight());<span class="comment">//设置照片的大小</span></div><div class="line">camera.setParameters(<span class="keyword">parameters</span>);</div><div class="line">camera.setPreviewDisplay(surfaceView.getHolder());<span class="comment">//通过SurfaceView显示取景画面</span></div><div class="line">camera.startPreview();<span class="comment">//开始预览</span></div><div class="line">camera.autoFocus(null);<span class="comment">//自动对焦</span></div><div class="line">camera.takePicture(null, null, null, jpegCallback);<span class="comment">//拍照片</span></div><div class="line">camera.stopPreview();<span class="comment">//停止预览</span></div><div class="line">camera.release();<span class="comment">//释放摄像头</span></div></pre></td></tr></table></figure>
<p>c)    需要权限</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.CAMERA"</span> /&gt;</div></pre></td></tr></table></figure>
<p><strong>小结</strong><br>a)    设置预览显示位置</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">setPreviewDisplay</span><span class="params">(SurfaceHolder holder)</span></span></div></pre></td></tr></table></figure>
<p><strong>注意：SurfaceView不在前端显示的时候会被销毁，恢复之后会重绘</strong><br>b)    将摄像头拍摄画面显示在SurfaceView中，在此之前可对摄像头进行参数配置，getParameters() 方法可以获取摄像头的相关参数Parameters，调用其内部方法即可进行配置</p>
<p>c)    自动对焦</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">autoFocus</span><span class="params">(AutoFocusCallback cb)</span></span></div></pre></td></tr></table></figure>
<p>自动对焦是一个异步操作，如果我们向等待自动对焦结束之后才开始拍照，需要传入一个回调对象，在其回调函数中调用拍照方法</p>
<p>d)    拍照 </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">takePicture</span><span class="params">(ShutterCallback shutter, PictureCallback raw, PictureCallback jpeg)</span></span></div></pre></td></tr></table></figure>
<p>拍照也是异步操作，需要通过回调函数来得到拍照之后的数据，注意拍照之后摄像头不回自动回到预览状态，需要重写调用startPreview()方法</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.CAMERA"</span>/&gt;</div></pre></td></tr></table></figure>
<h2 id="6-录像"><a href="#6-录像" class="headerlink" title="6. 录像"></a>6. 录像</h2><p>a)    在功能清单文件AndroidManifest.xml中添加音频刻录和照相机权限：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.RECORD_AUDIO"</span>/&gt;</div><div class="line"> &lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.CAMERA"</span>/&gt;</div><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.MOUNT_UNMOUNT_FILESYSTEMS"</span>/&gt;</div><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;</div></pre></td></tr></table></figure>
<p>b)    编写音频刻录代码:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.reset</span>();</div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setVideoSource</span>(MediaRecorder.VideoSource.CAMERA); <span class="comment">//设置视频输入源，从照相机采集视频</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setAudioSource</span>(MediaRecorder.AudioSource.MIC); <span class="comment">//设置音频输入源</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setOutputFormat</span>(MediaRecorder.OutputFormat.THREE_GPP);<span class="comment">//设置输出格式</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setVideoSize</span>(<span class="number">320</span>, <span class="number">240</span>);</div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setVideoFrameRate</span>(<span class="number">3</span>); <span class="comment">//每秒3帧</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setVideoEncoder</span>(MediaRecorder.VideoEncoder.H263); <span class="comment">//设置视频编码方式</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setAudioEncoder</span>(MediaRecorder.AudioEncoder.AMR_NB);<span class="comment">//设置音频编码器</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setOutputFile</span>(<span class="string">"/mnt/sdcard/ncist.3gp"</span>);<span class="comment">//设置输出文件</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.setPreviewDisplay</span>(surfaceView.getHolder().getSurface());<span class="comment">//设置预览显示位置</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.prepare</span>();<span class="comment">//预期准备</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.start</span>();<span class="comment">//开始刻录</span></div><div class="line">...</div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.stop</span>();<span class="comment">//停止刻录</span></div><div class="line"><span class="selector-tag">recorder</span><span class="selector-class">.release</span>(); <span class="comment">//刻录完成一定要释放资源</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/07/Android基础-2011-07-03-android-basic-8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/07/Android基础-2011-07-03-android-basic-8.html" itemprop="url">
                  Android基础8 服务(Service)
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-07-03T00:00:00+08:00">
                2011-07-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/07/Android基础-2011-07-03-android-basic-8.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/07/Android基础-2011-07-03-android-basic-8.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/07/Android基础-2011-07-03-android-basic-8.html" class="leancloud_visitors" data-flag-title="Android基础8 服务(Service)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-服务-Service"><a href="#1-服务-Service" class="headerlink" title="1. 服务(Service)"></a>1. 服务(Service)</h2><p>Android中的服务和windows中的服务是类似的东西，服务一般没有用户操作界面，它运行于系统中不容易被用户发觉，可以使用它开发如监控之类的程序。服务的开发比较简单，如下：<br>第一步：继承Service类</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SMSService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123; &#125;</div></pre></td></tr></table></figure>
<p>第二步：在AndroidManifest.xml文件中的<application>节点里对服务进行配置:</application></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;service android:<span class="built_in">name</span>=<span class="string">".SMSService"</span> /&gt;</div></pre></td></tr></table></figure>
<p>服务不能自己运行，需要通过调用Context.startService()或Context.bindService()方法启动服务。这两个方法都可以启动Service，但是它们的使用场合有所不同。</p>
<ol>
<li>使用startService()方法启用服务,访问者与服务之间没有关连，即使访问者退出了，服务仍然运行。</li>
<li>使用bindService()方法启用服务，访问者与服务绑定在了一起，访问者一旦退出，服务也就终止，大有“不求同时生，必须同时死”的特点。</li>
</ol>
<p>采用Context.startService()方法启动服务，只能调用Context.stopService()方法结束服务，服务结束时会调用onDestroy()方法。</p>
<h2 id="2-服务的生命周期"><a href="#2-服务的生命周期" class="headerlink" title="2. 服务的生命周期"></a>2. 服务的生命周期</h2><p>服务的生命周期跟启动服务的方法有关：</p>
<ol>
<li>当采用Context.startService()方法启动服务，与之有关的生命周期方法<br><strong>onCreate() –&gt;onStart() –&gt; onDestroy()</strong></li>
</ol>
<ul>
<li>onCreate()该方法在服务被创建时调用，该方法只会被调用一次，无论调用多少次startService()或bindService()方法，服务也只被创建一次。</li>
<li>onStart() 只有采用Context.startService()方法启动服务时才会回调该方法。该方法在服务开始运行时被调用。多次调用startService()方法尽管不会多次创建服务，但onStart() 方法会被多次调用。</li>
<li>onDestroy()该方法在服务被终止时调用。</li>
</ul>
<ol>
<li>当采用Context.bindService()方法启动服务，与之有关的生命周期方法<br><strong>onCreate() –&gt;onBind() –&gt;onUnbind() –&gt;onDestroy()</strong></li>
</ol>
<ul>
<li>onBind()只有采用Context.bindService()方法启动服务时才会回调该方法。该方法在调用者与服务绑定时被调用，当调用者与服务已经绑定，多次调用Context.bindService()方法并不会导致该方法被多次调用。</li>
<li>onUnbind()只有采用Context.bindService()方法启动服务时才会回调该方法。该方法在调用者与服务解除绑定时被调用。</li>
<li>如果先采用startService()启动服务,然后调用bindService()方法绑定到服务，再调用unbindService()解除绑定，最后调用bindService()再次绑定到服务。触发的生命周期方法如下：<br><strong>onCreate() –&gt; onStart() –&gt; onBind() –&gt; onUnbind()</strong>[重载后的方法需返回true] <strong>–&gt; onRebind()</strong></li>
</ul>
<h2 id="3-建立能与访问者进行通讯的本地服务"><a href="#3-建立能与访问者进行通讯的本地服务" class="headerlink" title="3. 建立能与访问者进行通讯的本地服务"></a>3. 建立能与访问者进行通讯的本地服务</h2><p>通过startService()和stopService()启动关闭服务。适用于服务和访问者之间没有交互的情况。如果服务和访问者之间需要方法调用或传递参数,则需要使用bindService()和unbindService()启动关闭服务。</p>
<p>采用Context.bindService()方法启动服务，在服务未被创建时，系统会先调用服务的onCreate()，接着调用onBind()，这个时候访问者和服务绑定在一起。 如果访问者要与服务进行通信，那么，onBind()必须返回Ibinder对象。如果访问者退出了，系统就会先调用服务的onUnbind()，接着调用onDestroy()。如果调用bindService()方法前服务已经被绑定，多次调用bindService()并不会导致多次创建服务及绑定(也就是说onCreate()和onBind()方法并不会被多次调用)。如果访问者希望与正在绑定的服务解除绑定，可以调用unbindService()，调用该方法也会导致系统调用服务的<strong>onUnbind()–&gt;onDestroy()</strong></p>
<p>Activity与服务进行通信，开发人员通常把通信方法定义在接口里，然后让Ibinder对象实现该接口，而Activity通过该接口引用服务onBind()返回的Ibinder对象，然后调用Ibinder对象里自定义的通信方法。本例是一个本地服务，即服务与Activity在同一个应用内部。<br>接口：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span>  <span class="keyword">interface</span>  <span class="title">ICountService</span> &#123;</div><div class="line">	<span class="function"><span class="keyword">public</span>  <span class="keyword">int</span> <span class="title">getCount</span>(<span class="params"></span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> quit;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line"><span class="keyword">private</span> ServiceBinder serviceBinder = <span class="keyword">new</span> ServiceBinder();</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">ICountService</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> count;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> serviceBinder;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onCreate();</div><div class="line">	<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">while</span> (!quit) &#123;</div><div class="line">			    <span class="keyword">try</span> &#123;	Thread.sleep(<span class="number">1000</span>);</div><div class="line">			    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">			    count++;</div><div class="line">			&#125;&#125;</div><div class="line">	&#125;).start();</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.onDestroy();</div><div class="line">	<span class="keyword">this</span>.quit = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端Activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> ICountService countService;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.main);</div><div class="line">		<span class="keyword">this</span>.bindService(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, CountService.class), <span class="keyword">this</span>.serviceConnection, BIND_AUTO_CREATE);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onDestroy();</div><div class="line">		<span class="keyword">this</span>.unbindService(serviceConnection);</div><div class="line">	&#125;	</div><div class="line">	<span class="keyword">private</span> ServiceConnection serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">		<span class="comment">//对于本地服务，获取的实例和服务onBind()返回的实例是同一个</span></div><div class="line">			countService = (ICountService) service;</div><div class="line">			<span class="keyword">int</span> i = countService.getCount();			</div><div class="line">			Log.v(<span class="string">"CountService"</span>, <span class="string">"Count is "</span> + i);</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">			countService = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-使用AIDL和远程服务实现进程通信"><a href="#4-使用AIDL和远程服务实现进程通信" class="headerlink" title="4. 使用AIDL和远程服务实现进程通信"></a>4. 使用AIDL和远程服务实现进程通信</h2><p>在Android中, 每个应用程序都有自己的进程，当需要在不同的进程之间传递对象时，该如何实现呢? 显然, Java中是不支持跨进程内存共享的。因此要传递对象, 需要把对象解析成操作系统能够理解的数据格式, 以达到跨界对象访问的目的。在JavaEE中，采用RMI通过序列化传递对象。在Android中, 则采用AIDL(Android Interface Definition Language：接口定义语言)方式实现。</p>
<p>AIDL是一种接口定义语言，用于约束两个进程间的通讯规则，供编译器生成代码，实现Android设备上的两个进程间通信(IPC)。AIDL的IPC机制和EJB所采用的CORBA很类似，进程之间的通信信息，首先会被转换成AIDL协议消息，然后发送给对方，对方收到AIDL协议消息后再转换成相应的对象。由于进程之间的通信信息需要双向转换，所以android采用代理类在背后实现了信息的双向转换，代理类由android编译器生成，对开发人员来说是透明的。实现进程通信，一般需要下面步骤：</p>
<p>假设A应用需要与B应用进行通信，调用B应用中的download(String path)方法，B应用以Service方式向A应用提供服务。需要下面步骤: </p>
<p>在B应用中创建*.aidl文件，aidl文件的定义和接口的定义很相类，如：在cn.ncist.aidl包下创建IDownloadService.aidl文件，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.ncist.aidl;</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IDownloadService</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">download</span><span class="params">(String path)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当完成aidl文件创建后，eclipse会自动在项目的gen目录中同步生成IDownloadService.java接口文件。</p>
<p>接口文件中生成一个Stub的抽象类，里面包括aidl定义的方法，还包括一些其它辅助方法。值得关注的是asInterface(IBinder iBinder),它返回接口类型的实例，对于远程服务调用，远程服务返回给客户端的对象为代理对象，客户端在onServiceConnected(ComponentName name, IBinder service)引用该对象时不能直接强转成接口类型的实例，而应该使用asInterface(IBinder iBinder)进行类型转换。</p>
<p><strong>编写aidl文件时，需要注意下面几点</strong></p>
<ol>
<li>接口名和aidl文件名相同</li>
<li>接口和方法前不用加访问权限修饰符public,private,protected等,也不能用final,static</li>
<li>aidl默认支持的类型包话java基本类型（int,long,boolean等）和（String,List,Map,CharSequence），使用这些类型时不需要import声明。对于List和Map中的元素类型必须是aidl支持的类型。如果使用自定义类型作为参数或返回值，自定义类型必须实现Parcelable接口。</li>
<li>自定义类型和AIDL生成的其它接口类型在aidl描述文件中，应该显式import，即便在该类和定义的包在同一个包中。</li>
<li>在aidl文件中所有非Java基本类型参数必须加上in、out、inout标记，以指明参数是输入参数、输出参数还是输入输出参数。Java原始类型默认的标记为in,不能为其它标记。</li>
</ol>
<p>在B应用中实现aidl文件生成的接口（本例是IDownloadService），但并非直接实现接口，而是通过继承接口的Stub来实现（Stub抽象类内部实现了aidl接口），并且实现接口方法的代码。<br>内容如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ServiceBinder</span> <span class="keyword">extends</span> <span class="title">IDownloadService</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	public void download(<span class="type">String</span> path) <span class="keyword">throws</span> <span class="type">RemoteException</span> &#123;</div><div class="line">		<span class="type">Log</span>.i(<span class="string">"DownloadService"</span>, path);</div><div class="line">	&#125;		</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在B应用中创建一个Service（服务），在服务的onBind(Intent intent)方法中返回实现了aidl接口的对象（本例是ServiceBinder）。内容如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DownloadService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="type">ServiceBinder</span> serviceBinder = <span class="keyword">new</span> <span class="type">ServiceBinder</span>();</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	public <span class="type">IBinder</span> onBind(<span class="type">Intent</span> intent) &#123;</div><div class="line">		<span class="keyword">return</span> serviceBinder;</div><div class="line">	&#125;</div><div class="line">	public <span class="class"><span class="keyword">class</span> <span class="title">ServiceBinder</span> <span class="keyword">extends</span> <span class="title">IDownloadService</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		public void download(<span class="type">String</span> path) <span class="keyword">throws</span> <span class="type">RemoteException</span> &#123;</div><div class="line">			<span class="type">Log</span>.i(<span class="string">"DownloadService"</span>, path);</div><div class="line">		&#125;		</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其他应用可以通过隐式意图访问服务,意图的动作可以自定义，AndroidManifest.xml配置代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".DownloadService"</span> &gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"cn.ncist.process.aidl.DownloadService"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<p>把B应用中aidl文件所在package连同aidl文件一起拷贝到客户端A应用，eclipse会自动在A应用的gen目录中为aidl文件同步生成IDownloadService.java接口文件,接下来就可以在A应用中实现与B应用通信，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> IDownloadService downloadService;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.main);</div><div class="line">		<span class="keyword">this</span>.bindService(<span class="keyword">new</span> Intent(<span class="string">"cn.ncist.process.aidl.DownloadService"</span>), 				                    <span class="keyword">this</span>.serviceConnection, BIND_AUTO_CREATE);<span class="comment">//绑定到服务</span></div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onDestroy();</div><div class="line">		<span class="keyword">this</span>.unbindService(serviceConnection);<span class="comment">//解除服务</span></div><div class="line">	&#125;	</div><div class="line">	<span class="keyword">private</span> ServiceConnection serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">			downloadService = IDownloadService.Stub.asInterface(service);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				downloadService.download(<span class="string">"http://www.ncist.cn"</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				Log.e(<span class="string">"ClientActivity"</span>, e.toString());</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">			downloadService = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-进程间传递自定义类型参数"><a href="#5-进程间传递自定义类型参数" class="headerlink" title="5. 进程间传递自定义类型参数"></a>5. 进程间传递自定义类型参数</h2><p>Aidl默认支持的类型包话java基本类型（int、long、boolean等）和（String、List、Map、CharSequence），如果要传递自定义的类型该如何实现呢？要传递自定义类型，首先要让自定义类型支持parcelable协议，实现步骤如下：</p>
<ol>
<li>自定义类型必须实现Parcelable接口，并且实现Parcelable接口的<br>public void writeToParcel(Parcel dest, int flags)方法 。</li>
<li>自定义类型中必须含有一个名称为CREATOR的静态成员，该成员对象要求实现Parcelable.Creator接口及其方法。</li>
<li>创建一个aidl文件声明你的自定义类型。</li>
</ol>
<p><strong>Parcelable接口的作用</strong><br>实现了Parcelable接口的实例可以将自身的状态信息（状态信息通常指的是各成员变量的值）写入Parcel，也可以从Parcel中恢复其状态。 Parcel用来完成数据的序列化传递。</p>
<p>进程间传递自定义类型的实现过程如下：<br>a)    创建自定义类型，并实现Parcelable接口,使其支持parcelable协议。如：在cn.ncist.domain包下创建Person.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.ncist.domain;</div><div class="line"><span class="keyword">import</span> android.os.Parcel;</div><div class="line"><span class="keyword">import</span> android.os.Parcelable;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Parcelable</span></span></div><div class="line">	<span class="title">private</span> <span class="title">Integer</span> <span class="title">id</span>;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(Integer id, String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">		<span class="comment">//把javanbean中的数据写到Parcel</span></div><div class="line">		dest.writeInt(<span class="keyword">this</span>.id);</div><div class="line">		dest.writeString(<span class="keyword">this</span>.name);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//添加一个静态成员,名为CREATOR,该对象实现了Parcelable.Creator接口</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Person&gt; CREATOR = <span class="keyword">new</span> 	Parcelable.Creator&lt;Person&gt;()&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Person <span class="title">createFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</div><div class="line">		<span class="comment">//从Parcel中读取数据，返回person对象</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Person(source.readInt(), source.readString());</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="keyword">public</span> Person[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Person[size];</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>b)    在自定义类型所在包下创建一个aidl文件对自定义类型进行声明，文件的名称与自定义类型同名。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">package cn.ncist.domain<span class="comment">;</span></div><div class="line">parcelable Person<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>c)    在接口aidl文件中使用自定义类型,需要使用import显式导入，本例在cn.ncist.aidl包下创建IPersonService.aidl文件，内容如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.ncist.aidl;</div><div class="line"><span class="keyword">import</span> cn.ncist.domain.Person;</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPersonService</span> &#123;</span></div><div class="line">      <span class="keyword">void</span> save(<span class="keyword">in</span> Person person);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>d)    在实现aidl文件生成的接口（本例是IPersonService），但并非直接实现接口，而是通过继承接口的Stub来实现（Stub抽象类内部实现了aidl接口），并且实现接口方法的代码。内容如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ServiceBinder</span> <span class="keyword">extends</span> <span class="title">IPersonService</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       public void save(<span class="type">Person</span> person) <span class="keyword">throws</span> <span class="type">RemoteException</span> &#123;</div><div class="line">		<span class="type">Log</span>.i(<span class="string">"PersonService"</span>, person.getId()+<span class="string">"="</span>+ person.getName());</div><div class="line">       &#125;		</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>e)    创建一个Service（服务），在服务的onBind(Intent intent)方法中返回实现了aidl接口的对象（本例是ServiceBinder）。内容如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="type">ServiceBinder</span> serviceBinder = <span class="keyword">new</span> <span class="type">ServiceBinder</span>();</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	public <span class="type">IBinder</span> onBind(<span class="type">Intent</span> intent) &#123;</div><div class="line">		<span class="keyword">return</span> serviceBinder;</div><div class="line">	&#125;</div><div class="line">	public <span class="class"><span class="keyword">class</span> <span class="title">ServiceBinder</span> <span class="keyword">extends</span> <span class="title">IPersonService</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       public void save(<span class="type">Person</span> person) <span class="keyword">throws</span> <span class="type">RemoteException</span> &#123;</div><div class="line">		<span class="type">Log</span>.i(<span class="string">"PersonService"</span>, person.getId()+<span class="string">"="</span>+ person.getName());</div><div class="line">       &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其他应用可以通过隐式意图访问服务,意图的动作可以自定义，AndroidManifest.xml配置代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".PersonService"</span> &gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"cn.ncist.process.aidl.PersonService "</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<p>f)    把应用中的aidl文件和所在package一起拷贝到客户端应用的src目录下，eclipse会自动在客户端应用的gen目录中为aidl文件同步生成IPersonService.java接口文件,接下来再把自定义类型文件和类型声明aidl文件及所在package一起拷贝到客户端应用的src目录下。最后就可以在客户端应用中实现与远程服务的通信，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> IPersonService personService;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.main);</div><div class="line">		<span class="keyword">this</span>.bindService(<span class="keyword">new</span> Intent(<span class="string">"cn.ncist.process.aidl.PersonService"</span>), 					 				<span class="keyword">this</span>.serviceConnection, BIND_AUTO_CREATE);<span class="comment">//绑定到服务</span></div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onDestroy();</div><div class="line">		<span class="keyword">this</span>.unbindService(serviceConnection);<span class="comment">//解除服务</span></div><div class="line">	&#125;	</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> ServiceConnection serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">			personService = IPersonService.Stub.asInterface(service);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				personService.save(<span class="keyword">new</span> Person(<span class="number">56</span>,<span class="string">"liming"</span>));</div><div class="line">			&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">				Log.e(<span class="string">"ClientActivity"</span>, e.toString());</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">			personService = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-监听电话呼叫状态"><a href="#6-监听电话呼叫状态" class="headerlink" title="6. 监听电话呼叫状态"></a>6. 监听电话呼叫状态</h2><p>要实现电话窃听，需要监听电话的状态，方法如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 取得电话服务 */</span></div><div class="line">	TelephonyManager telManager = (TelephonyManager) 				 		  		                getSystemService(Context.TELEPHONY_SERVICE);</div><div class="line">	PhoneStateListener listener = <span class="keyword">new</span> PhoneStateListener()&#123;	</div><div class="line">	<span class="meta">@Override</span>  </div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> onCallStateChanged(<span class="keyword">int</span> state, String incomingNumber) &#123;</div><div class="line">	      <span class="keyword">switch</span> (state)&#123;</div><div class="line">	        <span class="keyword">case</span> TelephonyManager.<span class="string">CALL_STATE_IDLE:</span> <span class="comment">/* 无任何状态时 */</span></div><div class="line">	        	<span class="keyword">break</span>;</div><div class="line">	        <span class="keyword">case</span> TelephonyManager.<span class="string">CALL_STATE_OFFHOOK:</span> <span class="comment">/* 接起电话时 */</span></div><div class="line">	        	<span class="keyword">break</span>;	</div><div class="line">	        <span class="keyword">case</span> TelephonyManager.<span class="string">CALL_STATE_RINGING:</span> <span class="comment">/* 电话进来时 */</span></div><div class="line">	        	<span class="keyword">break</span>;</div><div class="line">	      &#125;</div><div class="line">	<span class="keyword">super</span>.onCallStateChanged(state, incomingNumber);</div><div class="line">	&#125;        	</div><div class="line">&#125;;</div><div class="line"><span class="comment">//监听电话的状态</span></div><div class="line">telManager.listen(listener, PhoneStateListener.LISTEN_CALL_STATE);</div></pre></td></tr></table></figure>
<p>在清单文件AndroidManifest.xml中添加权限：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.READ_PHONE_STATE"</span>/&gt;</div></pre></td></tr></table></figure>
<h2 id="7-结束通话实现黑名单拦截"><a href="#7-结束通话实现黑名单拦截" class="headerlink" title="7. 结束通话实现黑名单拦截"></a>7. 结束通话实现黑名单拦截</h2><p>Android没有对外公开结束通话的API，如果需要结束通话，必须使用AIDL与电话管理服务进行通信，并调用服务中的API实现结束通话，方法如下：</p>
<p>a)    从Android的源代码中拷贝以下文件到项目中，开发工具会在gen目录下自动生成ITelephony.java<br>com.android.internal.telephony包下的ITelephony.aidl<br>android.telephony包下的NeighboringCellInfo.aidl<br><strong>注意：需要在项目中建立对应的包名存放上述两个aidl文件</strong></p>
<p>b)    调用ITelephony.endCall()结束通话：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">Method</span> <span class="title">method</span> = <span class="title">Class</span>.<span class="title">forName</span><span class="params">("android.os.ServiceManager")</span>.<span class="title">getMethod</span><span class="params">("getService", String.<span class="keyword">class</span>)</span>;</span></div><div class="line">IBinder binder = (IBinder)<span class="function"><span class="keyword">method</span>.<span class="title">invoke</span><span class="params">(null, <span class="keyword">new</span> Object[]&#123;TELEPHONY_SERVICE&#125;)</span>;</span></div><div class="line">ITelephony telephony = ITelephony.Stub.asInterface(binder);</div><div class="line">telephony.endCall();</div></pre></td></tr></table></figure>
<p>在清单文件AndroidManifest.xml中添加权限：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.CALL_PHONE"</span> /&gt;</div></pre></td></tr></table></figure>
<h2 id="8-电话录音"><a href="#8-电话录音" class="headerlink" title="8. 电话录音"></a>8. 电话录音</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="type">TelephonyManager</span> manager = (<span class="type">TelephonyManager</span>) getSystemService(<span class="type">TELEPHONY_SERVICE</span>);</div><div class="line">manager.listen(<span class="keyword">new</span> <span class="type">MyListener</span>(), <span class="type">PhoneStateListener</span>.<span class="type">LISTEN_CALL_STATE</span>);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListener</span> <span class="keyword">extends</span> <span class="title">PhoneStateListener</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="type">String</span> num;</div><div class="line">	<span class="keyword">private</span> <span class="type">MediaRecorder</span> recorder;</div><div class="line">	public void onCallStateChanged(int state, <span class="type">String</span> incomingNumber) &#123;</div><div class="line">		switch (state) &#123;</div><div class="line">			<span class="keyword">case</span> <span class="type">TelephonyManager</span>.<span class="type">CALL_STATE_RINGING</span>:</div><div class="line">				num = incomingNumber;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> <span class="type">TelephonyManager</span>.<span class="type">CALL_STATE_OFFHOOK</span>:</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">				<span class="type">File</span> file = <span class="keyword">new</span> <span class="type">File</span>(<span class="type">Environment</span>.getExternalStorageDirectory(), num + <span class="string">"_"</span> + 									<span class="type">System</span>.currentTimeMillis() + <span class="string">".3gp"</span>);</div><div class="line">					recorder = <span class="keyword">new</span> <span class="type">MediaRecorder</span>();</div><div class="line">					recorder.setAudioSource(<span class="type">AudioSource</span>.<span class="type">MIC</span>);</div><div class="line">					recorder.setOutputFormat(<span class="type">OutputFormat</span>.<span class="type">THREE_GPP</span>);</div><div class="line">					recorder.setAudioEncoder(<span class="type">AudioEncoder</span>.<span class="type">AMR_NB</span>);</div><div class="line">					recorder.setOutputFile(file.getAbsolutePath());</div><div class="line">					recorder.prepare();</div><div class="line">					recorder.start();</div><div class="line">				&#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> <span class="type">TelephonyManager</span>.<span class="type">CALL_STATE_IDLE</span>:</div><div class="line">				<span class="keyword">if</span> (recorder != <span class="literal">null</span>) &#123;</div><div class="line">					recorder.stop();</div><div class="line">					recorder.release();</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-28-android-basic-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/06/Android基础-2011-06-28-android-basic-7.html" itemprop="url">
                  Android基础7 广播接收者(BroadcastReceiver)
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-28T00:00:00+08:00">
                2011-06-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-28-android-basic-7.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-28-android-basic-7.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/06/Android基础-2011-06-28-android-basic-7.html" class="leancloud_visitors" data-flag-title="Android基础7 广播接收者(BroadcastReceiver)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-广播的类型"><a href="#1-广播的类型" class="headerlink" title="1. 广播的类型"></a>1. 广播的类型</h2><p>广播被分为两种不同的类型：普通广播（Normal broadcasts）和“有序广播（Ordered broadcasts）。普通广播是完全异步的，可以在同一时刻（逻辑上）被所有接收者接收到，消息传递的效率比较高，但缺点是：接收者不能将处理结果传递给下一个接收者，并且无法终止广播Intent的传播；</p>
<p>有序广播是按照接收者声明的优先级别，被接收者依次接收广播。如A的级别高于B,B的级别高于C,那么，广播先传给A，再传给B，最后传给C 。优先级别声明在intent-filter元素的android:priority属性中，数越大优先级别越高,取值范围:-1000到1000，优先级别也可以调用IntentFilter对象的setPriority()进行设置 。有序广播的接收者可以终止广播Intent的传播，广播Intent的传播一旦终止，后面的接收者就无法接收到广播。另外，有序广播的接收者可以将数据传递给下一个接收者，如A得到广播后，可以往它的结果对象中存入数据，当广播传给B时,B可以从A的结果对象中得到A存入的数据。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
//发送的是普通广播，所有订阅者都有机会获得并进行处理。
Context.sendBroadcast()
//发送有序广播
Context.sendOrderedBroadcast()
</pre>

<p>发送的是有序广播，系统会根据接收者声明的优先级别按顺序逐个执行接收者，前面的接收者有权终止广播(BroadcastReceiver.abortBroadcast())，如果广播被前面的接收者终止，后面的接收者就再也无法获取到广播。对于有序广播，前面的接收者可以将数据通过setResultExtras(Bundle)方法存放进结果对象，然后传给下一个接收者，下一个接收者通过代码：Bundle bundle = getResultExtras(true))可以获取上一个接收者存入在结果对象中的数据。</p>
<p>系统收到短信，发出的广播属于有序广播。如果想阻止用户收到短信，可以通过设置优先级，让你们自定义的接收者先获取到广播，然后终止广播，这样用户就接收不到短信了。</p>
<h2 id="2-定义广播接收者"><a href="#2-定义广播接收者" class="headerlink" title="2. 定义广播接收者"></a>2. 定义广播接收者</h2><p>广播接收者（BroadcastReceiver）用于接收广播Intent，广播Intent的发送是通过调用Context.sendBroadcast()、Context.sendOrderedBroadcast()来实现的。通常一个广播Intent可以被订阅了此Intent的多个广播接收者所接收，这个特性跟JMS中的Topic消息接收者类似。要实现一个广播接收者方法如下：<br>第一步：继承BroadcastReceiver，并重写onReceive()方法。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class IncomingSMSReceiver extends BroadcastReceiver {
    @Override public void onReceive(Context context, Intent intent) {
    }
}
</pre>

<p>第二步：订阅感兴趣的广播Intent，订阅方法有两种：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
//1.使用代码进行订阅
IntentFilter filter = new IntentFilter("android.provider.Telephony.SMS_RECEIVED");
IncomingSMSReceiver receiver = new IncomingSMSReceiver();
registerReceiver(receiver, filter);
//2.在AndroidManifest.xml文件中的&lt;application&gt;节点里进行订阅:
&lt;receiver android:name=".IncomingSMSReceiver"&gt;
    &lt;intent-filter&gt;
         &lt;action android:name="android.provider.Telephony.SMS_RECEIVED"/&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;
</pre>

<h2 id="3-发送广播（无序广播和有序广播的比较）"><a href="#3-发送广播（无序广播和有序广播的比较）" class="headerlink" title="3. 发送广播（无序广播和有序广播的比较）"></a>3. 发送广播（无序广播和有序广播的比较）</h2><h3 id="3-1-无序广播"><a href="#3-1-无序广播" class="headerlink" title="3.1 无序广播"></a>3.1 无序广播</h3><ol>
<li>使用sendBroadcast方法发送</li>
<li>被所有广播接收者接收，无序，不可中断</li>
<li>广播时可设置接收者权限，仅当接收者含有权限才能接收</li>
<li>接收者的<receiver>也可设置发送方权限，只接收含有权限应用的广播</receiver></li>
</ol>
<h3 id="3-2-有序广播"><a href="#3-2-有序广播" class="headerlink" title="3.2 有序广播"></a>3.2 有序广播</h3><ol>
<li>使用sendOrderedBroadcast方法发送</li>
<li>接收者可以在<intent-filter>中定义android:priority定义优先级，数字越大优先级越高</intent-filter></li>
<li>被各个广播接收者逐个接收，中途可以中断或者添加数据</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">abortBroadcast</span>()  </div><div class="line"><span class="selector-tag">getResultExtras</span>(true)<span class="selector-class">.putString</span>(<span class="string">"data"</span>, <span class="string">"新增数据"</span>);</div></pre></td></tr></table></figure>
<h2 id="4-监听短信接收"><a href="#4-监听短信接收" class="headerlink" title="4. 监听短信接收"></a>4. 监听短信接收</h2><p>当系统收到短信时，会发出一个广播Intent，Intent的action名称为android.provider.Telephony.SMS_RECEIVED，该Intent存放了系统接收到的短信内容，我们使用名称“pdus”即可从Intent中获取到短信内容。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">IncomingSMSReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">SMS_RECEIVED</span> = <span class="string">"android.provider.Telephony.SMS_RECEIVED"</span>;</div><div class="line"><span class="meta">@Override</span> </div><div class="line">public void onReceive(<span class="type">Context</span> context, <span class="type">Intent</span> intent) &#123;</div><div class="line"><span class="keyword">if</span> (intent.getAction().equals(<span class="type">SMS_RECEIVED</span>)) &#123;</div><div class="line">	<span class="type">SmsManager</span> sms = <span class="type">SmsManager</span>.getDefault();</div><div class="line">	<span class="type">Bundle</span> bundle = intent.getExtras();</div><div class="line">	<span class="keyword">if</span> (bundle != <span class="literal">null</span>) &#123;</div><div class="line">	<span class="type">Object</span>[] pdus = (<span class="type">Object</span>[]) bundle.get(<span class="string">"pdus"</span>);</div><div class="line">	<span class="type">SmsMessage</span>[] messages = <span class="keyword">new</span> <span class="type">SmsMessage</span>[pdus.length];</div><div class="line">	<span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; pdus.length; i++) </div><div class="line">	messages[i] = <span class="type">SmsMessage</span>.createFromPdu((byte[]) pdus[i]);</div><div class="line">		<span class="keyword">for</span> (<span class="type">SmsMessage</span> message : messages)&#123;</div><div class="line">			<span class="type">String</span> msg = message.getMessageBody();</div><div class="line">			<span class="type">String</span> to = message.getOriginatingAddress();</div><div class="line">			sms.sendTextMessage(to, <span class="literal">null</span>, msg, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">&#125;&#125;&#125;&#125;&#125;</div></pre></td></tr></table></figure>
<p>在AndroidManifest.xml文件中的<application>节点里对接收到短信的广播Intent进行订阅。</application></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".IncomingSMSReceiver"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">actionandroid:name="android.provider.Telephony.SMS_RECEIVED"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在AndroidManifest.xml文件中添加以下权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.RECEIVE_SMS"</span>/&gt;</span><span class="comment">&lt;!-- 接收短信权限 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.SEND_SMS"</span>/&gt;</span><span class="comment">&lt;!-- 发送短信权限 --&gt;</span></div></pre></td></tr></table></figure>
<p>Android系统在收到短信的时候会发送一条有序广播，我们如果定义一个接收者接收这个广播，就可以得到短信内容，也可以拦截短信。</p>
<ol>
<li>定义广播接收者接收广播</li>
<li>在onReceive方法内部调用Intent的getExtras()获取其中pdus字段，得到一个Object[]，其中每    一个    元素都是一个byte[]。</li>
<li>通过SmsMessage类的createFromPdu方法创建SmsMessage对象</li>
<li>从SmsMessage对象中即可获取发送者号码、短信内容、发送时间等信息</li>
<li>需要接收短信权限：</li>
</ol>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.RECEIVE_SMS"</span>/&gt;</div></pre></td></tr></table></figure>
<p>Android系统中收到短信的通知是一个有序通知，我们如需拦截垃圾短信，可以配置较高的priority，收到信息进行判断是否abortBroadcast()。除了短信到来广播Intent，Android还有很多广播Intent，如：开机启动、电池电量变化、时间已经改变等广播Intent。接收电池电量变化广播Intent ，在AndroidManifest.xml文件中的<application>节点里订阅此Intent</application></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".IncomingSMSReceiver"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.BATTERY_CHANGED"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接收开机启动广播Intent，在AndroidManifest.xml文件中的<application>节点里订阅此Intent:</application></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".IncomingSMSReceiver"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.BOOT_COMPLETED"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></div></pre></td></tr></table></figure>
<p>并且要进行权限声明：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span>/&gt;</div></pre></td></tr></table></figure>
<h2 id="5-监听呼出电话"><a href="#5-监听呼出电话" class="headerlink" title="5. 监听呼出电话"></a>5. 监听呼出电话</h2><p>向外拨打电话时系统会发出一个有序广播，虽然该广播最终会被拔号器里的广播接收者所接收并实现电话拔打，但我们可以在广播传递给拔号广播接收者之前先得到该广播，然后清除传递给拔号广播接收者的电话号码，在拔号广播接收者接收到该广播时，由于电话号码为null，因此取消电话拔打。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OutgoingCallReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</div><div class="line">     public void onReceive(<span class="type">Context</span> context, <span class="type">Intent</span> intent) &#123;</div><div class="line">		<span class="comment">//清除电话，广播被传给系统的接收者后，因为电话为null，取消电话拔打</span></div><div class="line">           setResultData(<span class="literal">null</span>);      </div><div class="line">          <span class="comment">// 同样如果你想修改外拔的电话号码，可以这样做</span></div><div class="line">          <span class="comment">// String phone = getResultData();//得到外拔电话</span></div><div class="line">          <span class="comment">// setResultData(“12593”+ phone);//在电话前面加上12593</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>a)    接收外拔电话广播Intent，在AndroidManifest.xml文件中的<application>节点里订阅此Intent。</application></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">".OutgoingCallReceiver"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">"1"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.NEW_OUTGOING_CALL"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></div></pre></td></tr></table></figure>
<p>b)    并且要进行权限声明：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.PROCESS_OUTGOING_CALLS"</span>/&gt;</div></pre></td></tr></table></figure>
<p>在onReceive方法中使用getResultData() 和 setResultData() 方法获取和设置电话号码</p>
<h2 id="6-生命周期"><a href="#6-生命周期" class="headerlink" title="6. 生命周期"></a>6. 生命周期</h2><ol>
<li>广播接收者的生命周期是非常短暂的，在接收到广播的时候创建，onReceive()方法结束之后销毁</li>
<li>广播接收者中不要做一些耗时的工作，耗时的较长的工作最好放在服务中完成，否则会弹出Application No Response错误对话框</li>
<li>最好也不要在广播接收者中创建子线程做耗时的工作，因为广播接收者被销毁后进程就成为了空进程，很容易被系统杀掉。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-27-android-basic-6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/06/Android基础-2011-06-27-android-basic-6.html" itemprop="url">
                  Android基础6 活动(Activity)
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-27T00:00:00+08:00">
                2011-06-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-27-android-basic-6.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-27-android-basic-6.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/06/Android基础-2011-06-27-android-basic-6.html" class="leancloud_visitors" data-flag-title="Android基础6 活动(Activity)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-创建Activity"><a href="#1-创建Activity" class="headerlink" title="1. 创建Activity"></a>1. 创建Activity</h2><h2 id="1-1-定义Activity"><a href="#1-1-定义Activity" class="headerlink" title="1.1 定义Activity"></a>1.1 定义Activity</h2><p><strong>定义类继承Activity</strong><br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class NewActivity extends Activity {
    @Override protected void onCreate(Bundle savedInstanceState) {
                   super.onCreate(savedInstanceState);
      //这里可以使用setContentView(R.layout.xxx)显示某个视图....
     }
}
</pre>

<p><strong>在AndroidManifest.xml的&lt;application&gt;节点中声明&lt;activity&gt;</strong></p>
<p>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
      package="cn.ncist.action"     android:versionCode="1"  android:versionName="1.0"&gt;
    &lt;application android:icon="@drawable/icon" android:label="@string/app_name"&gt;
        .....
    &lt;activity android:name=".NewActivity" android:label="新activity的页面标题"/&gt;
    &lt;/application&gt;
    ...
&lt;/manifest&gt;
</pre>

<p>android:name属性值的前面加了一个点表示NewActivity是当前包cn.ncist.action下的类，如果类在应用的当前包下，可以省略点符号，如果类在应用的子包下必须加点，如：NewActivity类在cn.ncist.action.user包下可以这样写：<activity android:name="“.user.NewActivity“"></activity></p>
<h3 id="1-2-显式意图创建方式"><a href="#1-2-显式意图创建方式" class="headerlink" title="1.2 显式意图创建方式"></a>1.2 显式意图创建方式</h3><ol>
<li>构造函数，代码少<br>new Intent(this, NewActivity.class);</li>
<li>类名形式，灵活，可扩展性强<br>intent.setClassName(this, “cn.ncist.activity.NewActivity”);</li>
<li>包名类名形式，可启动其他程序中的Activity<br>intent.setClassName(“cn.ncist.downloader”, “cn.ncist.downloader.MainActivity”);</li>
</ol>
<h3 id="1-3-创建Activity并传递数据"><a href="#1-3-创建Activity并传递数据" class="headerlink" title="1.3 创建Activity并传递数据"></a>1.3 创建Activity并传递数据</h3><ol>
<li>在意图对象中封装了一个Bundle对象，可以用来携带数据</li>
<li>在新Activity中可以获得意图对象以获取其中Bundle保存的数据<br>&lt;?prettify?&gt;<br><pre class="prettyprint"><br>public class MainActivity extends Activity {<br>@Override protected void onCreate(Bundle savedInstanceState) {<br> …….<br>  button.setOnClickListener(new View.OnClickListener(){//点击该按钮会打开一个新的Activity<pre><code>public void onClick(View v) {
 Intent intent = new Intent(MainActivity.this, NewActivity.class)
</code></pre>Bundle bundle = new Bundle();//该类用作携带数据<br>bundle.putString(“name”, “华北科技”);<br>bundle.putInt(“age”, 4);<br>intent.putExtras(bundle);//附带上额外的数据<br>startActivity(intent);<br> }}); }<br>}</pre></li>
</ol>
<p>public class NewActivity extends Activity {<br>            @Override protected void onCreate(Bundle savedInstanceState) {<br>         ……..<br>         Bundle bundle = this.getIntent().getExtras();<br>         String name = bundle.getString(“name”);<br>                        int age = bundle.getInt(“age”);<br>            }<br>}<br></p>
<h3 id="1-4-创建Activity获取返回数据"><a href="#1-4-创建Activity获取返回数据" class="headerlink" title="1.4 创建Activity获取返回数据"></a>1.4 创建Activity获取返回数据</h3><ol>
<li>使用startActivityForResult(Intent intent, int requestCode) 方法打开Activity</li>
<li>重写onActivityResult(int requestCode, int resultCode, Intent data) 方法</li>
<li>新Activity中调用setResult(int resultCode, Intent data) 设置返回数据之后，关闭Activity就会调用onActivityResult方法</li>
</ol>
<h3 id="1-5-隐式意图创建Activity"><a href="#1-5-隐式意图创建Activity" class="headerlink" title="1.5 隐式意图创建Activity"></a>1.5 隐式意图创建Activity</h3><ol>
<li>显式意图是指在创建意图时指定了组件，而隐式意图则不指定组件，通过动作、类型、数据匹配对应的组件</li>
<li>在清单文件中定义&lt;activity&gt;时需要定义&lt;intent-filter&gt;才能被隐式意图启动</li>
<li>&lt;intent-filter&gt;中至少配置一个&lt;action&gt;和一个&lt;category&gt;，否则无法被启动</li>
<li>Intent对象中设置的action、category、data在&lt;intent-filter&gt;必须全部包含才能启动</li>
<li>&lt;intent-filter&gt;中的&lt;action&gt;、&lt;category&gt;、&lt;data&gt;都可以配置多个，Intent对象中不用全部匹配，每样匹配一个即可启动<br>如果一个意图可以匹配多个Activity，Android系统会提示选择</li>
</ol>
<h2 id="2-Bundle类的作用"><a href="#2-Bundle类的作用" class="headerlink" title="2. Bundle类的作用"></a>2. Bundle类的作用</h2><p>Bundle类用作携带数据，它类似于Map，用于存放key-value名值对形式的值。相对于Map，它提供了各种常用类型的putXxx()/getXxx()方法，如:putString()/getString()和putInt()/getInt()，putXxx()用于往Bundle对象放入数据，getXxx()方法用于从Bundle对象里获取数据。Bundle的内部实际上是使用了HashMap&lt;String, Object&gt;类型的变量来存放putXxx()方法放入的值：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public final class Bundle implements Parcelable, Cloneable {
            ......
 Map&lt;String, Object&gt; mMap;
 public Bundle() {
       mMap = new HashMap<string, object="">();
        ......
 }
 public void putString(String key, String value) {
      mMap.put(key, value);
 }
public String getString(String key) {
       Object o = mMap.get(key);
        return (String) o;
        ........//类型转换失败后会返回null，这里省略了类型转换失败后的处理代码
}
}
</string,></pre>

<p>在调用Bundle对象的getXxx()方法时，方法内部会从该变量中获取数据，然后对数据进行类型转换，转换成什么类型由方法的Xxx决定，getXxx()方法会把转换后的值返回。</p>
<h2 id="3-Intent意图"><a href="#3-Intent意图" class="headerlink" title="3. Intent意图"></a>3. Intent意图</h2><p>Android基本的设计理念是鼓励减少组件间的耦合，因此Android提供了Intent (意图) ，Intent提供了一种通用的消息系统，它允许在你的应用程序与其它的应用程序间传递Intent来执行动作和产生事件。使用Intent可以激活Android应用的三个核心组件：活动、服务和广播接收器。</p>
<p><strong>Intent可以划分成显式意图和隐式意图</strong><br>显式意图：调用Intent.setComponent()或Intent.setClass()方法明确指定了组件名的Intent为显式意图，显式意图明确指定了Intent应该传递给哪个组件。<br>隐式意图:没有明确指定组件名的Intent为隐式意图。 Android系统会根据隐式意图中设置的动作(action)、类别(category)、数据（URI和数据类型）找到最合适的组件来处理这个意图。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;intent-filter&gt; 
&lt;action android:name="android.intent.action.CALL" /&gt; 
&lt;category android:name="android.intent.category.DEFAULT" /&gt; 
&lt;data android:scheme="tel" /&gt; 
&lt;/intent-filter&gt; 
&lt;intent-filter&gt; 
&lt;action android:name="android.intent.action.CALL" /&gt; 
&lt;category android:name="android.intent.category.DEFAULT" /&gt; 
&lt;data android:mimeType="vnd.android.cursor.item/phone" /&gt; 
&lt;/intent-filter&gt;
</pre>

<p>对于隐式意图，Android是怎样寻找到这个最合适的组件呢？记的前面我们在定义活动时，指定了一个intent-filter，Intent Filter（意图过滤器）其实就是用来匹配隐式Intent的，当一个意图对象被一个意图过滤器进行匹配测试时，只有三个方面会被参考到：动作、数据（URI以及数据类型）和类别。</p>
<p><strong>动作测试（Action test）</strong><br>一个意图对象只能指定一个动作名称，而一个过滤器可能列举多个动作名称。如果意图对象或过滤器没有指定任何动作，结果将如下：</p>
<ol>
<li>如果过滤器没有指定任何动作，那么将阻塞所有的意图，因此所有的意图都会测试失败。没有意图能够通过这个过滤器。 </li>
<li>另一方面，只要过滤器包含至少一个动作，一个没有指定动作的意图对象自动通过这个测试</li>
</ol>
<p><strong>类别测试（Category test）</strong><br>对于一个能够通过类别匹配测试的意图，意图对象中的类别必须匹配过滤器中的类别。这个过滤器可以列举另外的类别，但它不能遗漏在这个意图中的任何类别。原则上一个没有类别的意图对象应该总能够通过匹配测试，而不管过滤器里有什么。大部分情况下这个是对的。但有一个例外，Android把所有传给startActivity()的隐式意图当作他们包含至少一个类别：”android.intent.category.DEFAULT” （CATEGORY_DEFAULT常量）。 因此，想要接收隐式意图的活动必须在它们的意图过滤器中包含”android.intent.category.DEFAULT”。（带”android.intent.action.MAIN”和”android.intent.category.LAUNCHER”设置的过滤器是例外）</p>
<p><strong>数据测试（Data test）</strong><br>当一个意图对象中的URI被用来和一个过滤器中的URI比较时，比较的是URI的各个组成部分。例如，如果过滤器仅指定了一个scheme，所有该scheme的URIs都能够和这个过滤器相匹配；如果过滤器指定了一个scheme、主机名但没有路经部分，所有具有相同scheme和主机名的URIs都可以和这个过滤器相匹配，而不管它们的路经；如果过滤器指定了一个scheme、主机名和路经，只有具有相同scheme、主机名和路经的URIs才可以和这个过滤器相匹配。当然，一个过滤器中的路径规格可以包含通配符，这样只需要部分匹配即可。</p>
<p>数据测试同时比较意图对象和过滤器中指定的URI和数据类型。规则如下：</p>
<ol>
<li>一个既不包含URI也不包含数据类型的意图对象仅在过滤器也同样没有指定任何URIs和数据类型的情况下才能通过测试。</li>
<li>一个包含URI但没有数据类型的意图对象仅在它的URI和一个同样没有指定数据类型的过滤器里的URI匹配时才能通过测试。这通常发生在类似于mailto:和tel：这样的URIs上：它们并不引用实际数据。</li>
<li>一个包含数据类型但不包含URI的意图对象仅在这个过滤器列举了同样的数据类型而且也没有指定一个URI的情况下才能通过测试。</li>
<li>一个同时包含URI和数据类型（或者可从URI推断出数据类型）的意图对象可以通过测试，如果它的类型和过滤器中列举的类型相匹配的话。如果它的URI和这个过滤器中的一个URI相匹配或者它有一个内容content:或者文件file: URI而且这个过滤器没有指定一个URI，那么它也能通过测试。换句话说，一个组件被假定为支持content:和file: 数据如果它的过滤器仅列举了一个数据类型。</li>
</ol>
<p><strong>为Intent附加数据的两种形式</strong>：<br>第一种写法，用于批量添加数据到Intent：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Intent intent = new Intent();
Bundle bundle = new Bundle();//该类用作携带数据
bundle.putString("name", "华北科技");
intent.putExtras(bundle);//为意图追加额外的数据，意图原来已经具有的数据不会丢失，但key同名的数据会被替换
</pre>

<p>第二种写法：这种写法的作用等价于上面的写法，只不过这种写法是把数据一个个地添加进Intent，这种写法使用起来比较方便，而且只需要编写少量的代码。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Intent intent = new Intent();
intent.putExtra("name", "华北科技");
</pre>

<p>Intent提供了各种常用类型重载后的putExtra()方法，如： putExtra(String name, String value)、 putExtra(String name, long value)，在putExtra()方法内部会判断当前Intent对象内部是否已经存在一个Bundle对象，如果不存在就会新建Bundle对象，以后调用putExtra()方法传入的值都会存放于该Bundle对象，下面是Intent的putExtra(String name, String value)方法代码片断：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class Intent implements Parcelable {
private Bundle mExtras;
public Intent putExtra(String name, String value) {
        if (mExtras == null) {
            mExtras = new Bundle();
        }
        mExtras.putString(name, value);
        return this;
 }
</pre>

<h2 id="4-生命周期"><a href="#4-生命周期" class="headerlink" title="4. 生命周期"></a>4. 生命周期</h2><p><strong>Acitivity三种状态</strong></p>
<ol>
<li>运行：activity在屏幕最前端运行（位于当前任务栈的顶部）</li>
<li>暂停：当它上面有另外一个Activity，使它失去了焦点但任然对用户可见时，它处于暂停状态，在它之上的Activity没有完全覆盖屏幕或者是透明的，被暂停的Activity仍然对用户可见，并且是存活状态（它保留着所有的状态和成员信息并保持和窗口管理器的连接）。如果系统处于内存不足时，会杀死这个Activity。</li>
<li>停止：activity不可见，完全被覆盖，它仍然保留着所有的状态和成员信息，然而对用户是不可见的，所以它的窗口被隐藏，如果其它地方需要内存，则系统经常会杀死这个Activity。</li>
</ol>
<p><strong>生命周期相关方法</strong><br>当Activity从一种状态转变到另外一种状态时，会调用以下保护方法来通知这种变化。</p>
<ol>
<li>onCreate：创建时调用，或者程序在暂停、停止状态下被杀死之后重新打开时也会调用</li>
<li>onStart：onCreate之后或者从停止状态恢复时调用</li>
<li>onResume：onStart之后或者从暂停状态恢复时调用，从停止状态恢复时由于调用onStart，也会调用onResume</li>
<li>onPause：进入暂停、停止状态，或者销毁时会调用</li>
<li>onStop：进入停止状态，或者销毁时会调用</li>
<li>onDestroy：销毁时调用</li>
<li>onRestart：从停止状态恢复时调用<br>这七个方法定义了Activity的完整的声明周期。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%884.46.59.png" alt=""></li>
</ol>
<p><strong>Activity的完整声明周期</strong><br>自第一次调用onCreate()开始，直至调用onDestroy()为止。Activity在onCreate()中设置所有“全局”状态以完成初始化，而在onDestroy()中释放所有系统资源。</p>
<p><strong>Activity的可视声明周期</strong><br>自onStart()调用开始直到相应的onStop()调用结束，在此期间，用户可以在屏幕上看到Activity，尽管它也许并不是位于前台或者也不予用户进行交互，在这两个方法之间，可以保留用来向用户显示这个Activity所需的资源。</p>
<p><strong>Activity的前台声明周期</strong><br>自onResume()调用起，至相应的onPause()调用为止，在此期间，Activity位于前台最上面并于用户进行交互。Activity会经常在暂停和恢复之间进行状态转换。</p>
<p>Activity的前台生命周期循环例子:</p>
<ol>
<li>创建一个Activity，添加七个生命周期方法，方法内输出各个方法名称。再添加一个按钮用于打开下面新添加的Activity。<br> startActivity(new Intent(LifeActivity.this, CustomDialogActivity.class));</li>
<li>添加一个新Activity，代码如下：<br>&lt;?prettify?&gt;<pre class="prettyprint">
public class CustomDialogActivity extends Activity {
 @Override protected void onCreate(Bundle savedInstanceState) {
     super.onCreate(savedInstanceState);
     //必须在调用setContentView()之前调用requestWindowFeature()
     requestWindowFeature(Window.FEATURE_LEFT_ICON);//要标题栏显示图标
     setContentView(R.layout.dialog_activity);       
     getWindow().setFeatureDrawableResource(Window.FEATURE_LEFT_ICON, android.R.drawable.ic_dialog_alert);//设置图标
 }
}
</pre>

</li>
</ol>
<p>在AndroidManifest.xml文件配置Activity，并且通过主题指定该Activity以对话框样式显示。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;application android:icon="@drawable/icon" android:label="@string/app_name"&gt;
        .....
       &lt;activity android:name=".CustomDialogActivity" android:label="对话框activity" 
    android:theme="@android:style/Theme.Dialog"/&gt;
 &lt;/application&gt;
</pre>

<h2 id="5-保存信息相关方法"><a href="#5-保存信息相关方法" class="headerlink" title="5. 保存信息相关方法"></a>5. 保存信息相关方法</h2><p>Activity的 onSaveInstanceState() 和 onRestoreInstanceState()并不是生命周期方法，它们不同于 onCreate()、onPause()等生命周期方法，它们并不一定会被触发。当应用遇到意外情况（如：内存不足、用户直接按Home键）由系统销毁一个Activity时，onSaveInstanceState() 会被调用。但是当用户主动去销毁一个Activity时，例如在应用中按返回键，onSaveInstanceState()就不会被调用。因为在这种情况下，用户的行为决定了不需要保存Activity的状态。通常onSaveInstanceState()只适合用于保存一些临时性的状态，而onPause()适合用于数据的持久化保存。</p>
<p>另外，当屏幕的方向发生了改变， Activity会被摧毁并且被重新创建，如果你想在Activity被摧毁前缓存一些数据，并且在Activity被重新创建后恢复缓存的数据。可以重写Activity的 onSaveInstanceState() 和 onRestoreInstanceState()方法，如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class PreferencesActivity extends Activity {
    private String name;
    protected void onRestoreInstanceState(Bundle savedInstanceState) {
    name = savedInstanceState.getString("name"); //被重新创建后恢复缓存的数据
    super.onRestoreInstanceState(savedInstanceState);
    }
    protected void onSaveInstanceState(Bundle outState) {
    outState.putString("name", "liming");//被摧毁前缓存一些数据
    super.onSaveInstanceState(outState);
    }
}
</pre>

<p>onSaveInstanceState()：在Activity被动的摧毁或停止的时候调用，用于保存运行数据，可以将数据存在在Bundle中。</p>
<p>onRestoreInstanceState()：该方法在Activity被重新绘制的时候调用，例如改变屏幕方向，savedInstanceState为onSaveInstanceState保存的数据。</p>
<p><strong>横竖屏幕的切换</strong><br>默认情况下，当“屏幕方向”或“键盘显示隐藏” 变化时都会销毁当前Activity，创建新的Activity。如果不希望重新创建Activity实例，可以按如下配置Activity：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;activity android:name=".MainActivity" android:configChanges="keyboardHidden|orientation"&gt;
</pre>

<p>上面的android:configChanges属性指定了要捕获“屏幕方向”和“键盘显示隐藏”变化，当捕获到这些变化后会调用Activity的onConfigurationChanged()方法。默认情况下(没有配置android:configChanges属性)：</p>
<ol>
<li>竖屏切横屏，销毁当前Activity之后，创建一个新Activity实例。</li>
<li>横屏切竖屏，销毁当前Activity之后，创建一个新Activity实例，新的Activity实例很快就被销毁，接着又会创建一个新Activity实例。如果只希望创建一个实例，可以配置<br>android:configChanges=”orientation”</li>
</ol>
<h2 id="6-得到新打开的Activity关闭后返回的数据"><a href="#6-得到新打开的Activity关闭后返回的数据" class="headerlink" title="6. 得到新打开的Activity关闭后返回的数据"></a>6. 得到新打开的Activity关闭后返回的数据</h2><p>如果你想在Activity中得到新打开Activity 关闭后返回的数据，你需要使用系统提供的startActivityForResult(Intent intent, int requestCode)方法打开新的Activity，新的Activity 关闭后会向前面的Activity 传回数据，为了得到传回的数据，你必须在前面的Activity中重写onActivityResult(int requestCode, int resultCode, Intent data)方法：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class MainActivity extends Activity {
      @Override 
    protected void onCreate(Bundle savedInstanceState) {
    .......
    Button button =(Button) this.findViewById(R.id.button);
    button.setOnClickListener(new View.OnClickListener(){//点击该按钮会打开一个新的Activity
        public void onClick(View v) {
        //第二个参数为请求码，可以根据业务需求自己编号
        startActivityForResult (new Intent(MainActivity.this, NewActivity.class),  1);
    }});
         }
    //第一个参数为请求码，即调用startActivityForResult()传递过去的值
    //第二个参数为结果码，结果码用于标识返回数据来自哪个新Activity
   @Override 
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    String result = data.getExtras().getString(“result”));//得到新Activity 关闭后返回的数据
    }
}    
</pre>

<p>当新Activity关闭后，新Activity返回的数据通过Intent进行传递，android平台会调用前面Activity 的onActivityResult()方法，把存放了返回数据的Intent作为第三个输入参数传入，在onActivityResult()方法中使用第三个输入参数可以取出新Activity返回的数据。</p>
<p>使用startActivityForResult(Intent intent, int requestCode)方法打开新的Activity，新Activity关闭前需要向前面的Activity返回数据需要使用系统提供的setResult(int resultCode, Intent data)方法实现：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class NewActivity extends Activity {
    @Override 
protected void onCreate(Bundle savedInstanceState) {
        ......
      button.setOnClickListener(new View.OnClickListener(){
        public void onClick(View v) {
            Intent intent = new Intent();//数据是使用Intent返回
            intent.putExtra(“result”, “华北科技的学生很可爱”);//把返回数据存入Intent
             NewActivity.this.setResult(RESULT_OK, intent);//设置返回数据
             NewActivity.this.finish();//关闭Activity
        }});
    }
}
</pre>

<p>setResult()方法的第一个参数值可以根据业务需要自己定义，上面代码中使用到的RESULT_OK是系统Activity类定义的一个常量，值为-1，代码片断如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class android.app.Activity extends ......{
  public static final int RESULT_CANCELED = 0;
  public static final int RESULT_OK = -1;
  public static final int RESULT_FIRST_USER = 1;
}
</pre>

<p><strong>请求码的作用</strong><br>使用startActivityForResult(Intent intent, int requestCode)方法打开新的Activity，我们需要为startActivityForResult()方法传入一个请求码(第二个参数)。请求码的值是根据业务需要由自已设定，用于标识请求来源。</p>
<p>例如：一个Activity有两个按钮，点击这两个按钮都会打开同一个Activity，不管是那个按钮打开新Activity，当这个新Activity关闭后，系统都会调用前面Activity的onActivityResult(int requestCode, int resultCode, Intent data)方法。在onActivityResult()方法如果需要知道新Activity是由那个按钮打开的，并且要做出相应的业务处理，这时可以这样做：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
 @Override  
public void onCreate(Bundle savedInstanceState) {
        ....
        button1.setOnClickListener(new View.OnClickListener(){
      public void onClick(View v) {
           startActivityForResult (new Intent(MainActivity.this, NewActivity.class), 1);
       }});
        button2.setOnClickListener(new View.OnClickListener(){
      public void onClick(View v) {
           startActivityForResult (new Intent(MainActivity.this, NewActivity.class), 2);
       }}); 
       @Override 
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
               switch(requestCode){
                   case 1:
                       //来自按钮1的请求，作相应业务处理
                   case 2:
                    //来自按钮2的请求，作相应业务处理
                }
          }
}
</pre>

<p><strong>结果码的作用</strong><br>在一个Activity中，可能会使用startActivityForResult()方法打开多个不同的Activity处理不同的业务，当这些新Activity关闭后，系统都会调用前面Activity的onActivityResult(int requestCode, int resultCode, Intent data)方法。为了知道返回的数据来自于哪个新Activity，在onActivityResult()方法中可以这样做(ResultActivity和NewActivity为要打开的新Activity)：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class ResultActivity extends Activity {
       .....
       ResultActivity.this.setResult(1, intent);
       ResultActivity.this.finish();
}
public class NewActivity extends Activity {
       ......
        NewActivity.this.setResult(2, intent);
        NewActivity.this.finish();
}
public class MainActivity extends Activity { // 在该Activity会打开ResultActivity和NewActivity
       @Override protected void onActivityResult(int requestCode, int resultCode, Intent data) {
               switch(resultCode){
                   case 1:
                       // ResultActivity的返回数据
                   case 2:
                   // NewActivity的返回数据
                }
          }
}
</pre>

<h2 id="7-内存管理"><a href="#7-内存管理" class="headerlink" title="7. 内存管理"></a>7. 内存管理</h2><p>Android系统在运行多个进程时，如果系统资源不足，会强制结束一些进程。优先选择哪个进程来结束是有优先级的。以下顺序靠上的优先结束</p>
<ol>
<li>空：进程中所有Activity都已销毁</li>
<li>后台：进程中有一个停止状态的Activity</li>
<li>服务：进程中一个运行中的Service</li>
<li>可见：进程中有一个暂停状态的Activity</li>
<li>前台：进程中正在运行一个Activity</li>
</ol>
<h2 id="8-应用的响应性ANR"><a href="#8-应用的响应性ANR" class="headerlink" title="8. 应用的响应性ANR"></a>8. 应用的响应性ANR</h2><p><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%884.53.41.png" alt=""><br>在Android中，应用的响应性被活动管理器（Activity Manager）和窗口管理器（Window Manager）这两个系统服务所监视。当用户触发了输入事件（如键盘输入，点击按钮等），如果应用5秒内没有响应用户的输入事件，那么，Android会认为该应用无响应，便弹出ANR（Application No Response）对话框。</p>
<p>在正常情况下，Android程序会在一条单线程里运行。如果Activity要处理一件比较耗时的工作，应该交给子线程完成，否侧会因为主线程被阻塞，后面的用户输入事件因没能在5秒内响应，导致应用出现ANR对话框。</p>
<h2 id="9-姻缘属性affinities"><a href="#9-姻缘属性affinities" class="headerlink" title="9. 姻缘属性affinities"></a>9. 姻缘属性affinities</h2><p>应用场景：有两个android应用程序：旅游应用.apk，天气查询.apk，在Activity中配置<br>  android:allowTaskReparenting=”true”<br>   android:taskAffinity=”tianqi”<br>会将两个Activity放在同一个task任务栈，可以减少上下文切换到开销，节省资源。</p>
<h2 id="10-启动模式"><a href="#10-启动模式" class="headerlink" title="10.启动模式"></a>10.启动模式</h2><p>在AndroidManifest.xml中的<activity>标签中可以配置android:launchMode属性，用来控制Actvity的启动模式<br>在Android系统中我们创建的Acitivity是以栈的形式呈现的(task 任务栈) 一个应用程序可能包涵多个activity ,这些activity都是被放置在任务栈中的。可以把一个应用程序理解成一组任务的集合,即用户看到的界面(activity) 是被放置在任务栈当中的。</activity></p>
<ol>
<li>standard：默认的启动模式，每次调用startActivity()启动时都会创建一个新的Activity放在栈顶</li>
<li>singleTop：如果启动的Activity时，指定Activity不在栈顶就创建，如在栈顶，则不再创建，去调用onNewIntent()的方法。应用场景如浏览器的书签 ( bookmark ) 采用了该启动模式，不让用    户多次退出同一书签，增强用户的操作体验,  </li>
<li>singleTask：如果启动的Activity不存在就创建，如果存在直接跳转到指定的Activity所在位置，保证了当前的task栈中只有一个任务的实例</li>
<li>singleInstance：如果启动的Activity不存在就创建，如果存在就将指定的Activity移动到栈顶，开启一个新的task任务栈，用来维护新打开的Activity，原来的Activity中维护对其引用；</li>
</ol>
<p><strong>task任务栈，应用程序和进程之间关系</strong></p>
<ol>
<li>task任务栈：用来维护一组Activity的集合，通过设置task,可以更加合理的管理Activity;</li>
<li>应用程序：应用程序可以分为可见和不可见两种，可见的应用程序可以理解成一组任务的集合（Activity），不可见部分包括其它三大组件；</li>
<li>进程：操作系统的概念，开启的应用程序都会开启一个进程</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-15-android-basic-5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/06/Android基础-2011-06-15-android-basic-5.html" itemprop="url">
                  Android基础5 网络通信
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-15T00:00:00+08:00">
                2011-06-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-15-android-basic-5.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-15-android-basic-5.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/06/Android基础-2011-06-15-android-basic-5.html" class="leancloud_visitors" data-flag-title="Android基础5 网络通信">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-获取网络图片"><a href="#1-获取网络图片" class="headerlink" title="1. 获取网络图片"></a>1. 获取网络图片</h2><ol>
<li>通过URL对象封装地址，打开一个HttpURLConnection</li>
<li>设置超时时间以及请求方式</li>
<li>获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据</li>
<li>通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象</li>
<li>需要访问网络的权限<br> <uses-permission android:name="android.permission.INTERNET"><br>&lt;?prettify?&gt;<pre class="prettyprint">
URL url = new URL("http://photocdn.sohu.com/20100125/Img269812337.jpg");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);
conn.setRequestMethod("GET");
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();
readAsFile(is, "Img269812337.jpg"); 
public static void readAsFile(InputStream inSream, File file) throws Exception{
 FileOutputStream outStream = new FileOutputStream(file);
 byte[] buffer = new byte[1024];
 int len = -1;
 while( (len = inSream.read(buffer)) != -1 ){
     outStream.write(buffer, 0, len);
 }
  outStream.close();
 inSream.close();
}
</pre>

</uses-permission></li>
</ol>
<h2 id="2-获取HTML代码"><a href="#2-获取HTML代码" class="headerlink" title="2. 获取HTML代码"></a>2. 获取HTML代码</h2><ol>
<li>和获取图片相同，使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>需要获取服务器端代码的编码</li>
<li>代码过长屏幕显示不全可以使用<scrollview>进行显示<br>&lt;?prettify?&gt;<pre class="prettyprint">
URL url = new URL("http://www.sohu.com");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);//设置连接超时
conn.setRequestMethod(“GET”);//以get方式发起请求
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();//得到网络返回的输入流
String result = readData(is, "GBK");
conn.disconnect();
//第一个参数为输入流,第二个参数为字符集编码
public static String readData(InputStream inSream, String charsetName) throws Exception{
 ByteArrayOutputStream outStream = new ByteArrayOutputStream();
 byte[] buffer = new byte[1024];
 int len = -1;
 while( (len = inSream.read(buffer)) != -1 ){
     outStream.write(buffer, 0, len);
 }
 byte[] data = outStream.toByteArray();
 outStream.close();
 inSream.close();
 return new String(data, charsetName);
</pre>

</scrollview></li>
</ol>
<h2 id="3-获取XML"><a href="#3-获取XML" class="headerlink" title="3. 获取XML"></a>3. 获取XML</h2><ol>
<li>使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>使用XmlPullPaser解析</li>
</ol>
<h2 id="4-获取Json"><a href="#4-获取Json" class="headerlink" title="4. 获取Json"></a>4. 获取Json</h2><ol>
<li>使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>将数据转为String，封装成JSONArray对象</li>
<li>遍历JSONArray对象，获取其中的JSONObject</li>
<li>再从JSONObject中获取每个字段的信息</li>
</ol>
<h2 id="5-发送Get请求"><a href="#5-发送Get请求" class="headerlink" title="5. 发送Get请求"></a>5. 发送Get请求</h2><ol>
<li>拼接路径和参数，通过URL进行封装，打开一个HttpURLConnection，发送请求</li>
<li>如果参数是中文会出现乱码</li>
<li>URL中包含的中文参数需要使用URLEncoder进行编码</li>
<li>服务器端如果是TOMCAT，其默认使用ISO8859-1编码，接收时需要处理编码问题</li>
</ol>
<h2 id="6-发送Post请求"><a href="#6-发送Post请求" class="headerlink" title="6. 发送Post请求"></a>6. 发送Post请求</h2><ol>
<li>通过URL打开一个HttpURLConnection</li>
<li>头信息中除了超时时间和请求方式之外还必须设置Content-Type和Content-Length</li>
<li>从HttpURLConnection获得输出流输出参数数据</li>
<li>服务端可以使用request对象的setCharacterEncoding方法设置编码<br>&lt;?prettify?&gt;<pre class="prettyprint">
StringBuilder xml =  new StringBuilder();
xml.append("&lt;?xml version=\"1.0\" encoding=\"utf-8\" ?&gt;");
xml.append("&lt;M1 V=10000&gt;");
xml.append("&lt;U I=1 D=\"N73\"&gt;中国&lt;/U&gt;");
xml.append("&lt;/M1&gt;");
byte[] xmlbyte = xml.toString().getBytes("UTF-8");
URL url = new URL("http://localhost:8080/ncist/contanctmanage.do?method=readxml");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);
conn.setDoOutput(true);//允许输出
conn.setUseCaches(false);//不使用Cache
conn.setRequestMethod("POST");            
conn.setRequestProperty("Connection", "Keep-Alive");//维持长连接
conn.setRequestProperty("Charset", "UTF-8");
conn.setRequestProperty("Content-Length", String.valueOf(xmlbyte.length));
conn.setRequestProperty("Content-Type", "text/xml; charset=UTF-8");
DataOutputStream outStream = new DataOutputStream(conn.getOutputStream());
outStream.write(xmlbyte);//发送xml数据
outStream.flush();
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();//获取返回数据
String result = readAsString(is, "UTF-8");
outStream.close();    
</pre>

</li>
</ol>
<h2 id="7-Http协议上传文件"><a href="#7-Http协议上传文件" class="headerlink" title="7.Http协议上传文件"></a>7.Http协议上传文件</h2><ol>
<li>搭建服务器，完成上传功能</li>
<li>使用浏览器上传，查看请求信息</li>
</ol>
<p><strong>HttpURLConnection</strong></p>
<ol>
<li>通过URL封装路径打开一个HttpURLConnection</li>
<li>设置请求方式以及头字段：Content-Type、Content-Length、Host</li>
<li>拼接数据发送</li>
</ol>
<p><strong>Socket</strong></p>
<ol>
<li>使用HttpURLConnection发送时内部有缓存机制，如果上传较大文件会导致内存溢出</li>
<li>我们可以使用Socket发送TCP请求，将上传数据分段发送</li>
</ol>
<h2 id="8-发送Xml，访问WebService"><a href="#8-发送Xml，访问WebService" class="headerlink" title="8.发送Xml，访问WebService"></a>8.发送Xml，访问WebService</h2><p><strong>发送XML</strong></p>
<ol>
<li>通过URL封装路径打开一个HttpURLConnection</li>
<li>设置请求方式，Content-Type和Content-Length，XML文件的Content-Type为：text/xml;     charset=UTF-8</li>
<li>使用HttpURLConnection获取输出流输出数据<br>&lt;?prettify?&gt;<pre class="prettyprint">
StringBuilder xml =  new StringBuilder();
xml.append("&lt;?xml version=\"1.0\" encoding=\"utf-8\" ?&gt;");
xml.append("&lt;M1 V=10000&gt;");
xml.append("&lt;U I=1 D=\"N73\"&gt;中国&lt;/U&gt;");
xml.append("&lt;/M1&gt;");
byte[] xmlbyte = xml.toString().getBytes("UTF-8");
URL url = new URL("http://localhost:8080/ncist/contanctmanage.do?method=readxml");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);
conn.setDoOutput(true);//允许输出
conn.setUseCaches(false);//不使用Cache
conn.setRequestMethod("POST");            
conn.setRequestProperty("Connection", "Keep-Alive");//维持长连接
conn.setRequestProperty("Charset", "UTF-8");
conn.setRequestProperty("Content-Length", String.valueOf(xmlbyte.length));
conn.setRequestProperty("Content-Type", "text/xml; charset=UTF-8");
DataOutputStream outStream = new DataOutputStream(conn.getOutputStream());
outStream.write(xmlbyte);//发送xml数据
outStream.flush();
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();//获取返回数据
String result = readAsString(is, "UTF-8");
outStream.close();
</pre>

</li>
</ol>
<p><strong>WebService</strong></p>
<ol>
<li>WebService是发布在网络上的API，可以通过发送XML调用，WebService返回结果也是XML数据</li>
<li>WebService没有语言限制，只要可以发送XML数据和接收XML数据即可</li>
<li><a href="http://www.webxml.com.cn" target="_blank" rel="external">http://www.webxml.com.cn</a> 网站上提供了一些WebService服务，我们可以对其进行调用</li>
<li><a href="http://webservice.webxml.com.cn/WebServices/MobileCodeWS.asmx?op=getMobileCodeInfo" target="_blank" rel="external">http://webservice.webxml.com.cn/WebServices/MobileCodeWS.asmx?op=getMobileCodeInfo</a> 中提供了电话归属地查询的使用说明<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png" alt=""></li>
</ol>
<h2 id="9-多线程断点续传"><a href="#9-多线程断点续传" class="headerlink" title="9.多线程断点续传"></a>9.多线程断点续传</h2><ol>
<li><p>在下载的时候多个线程并发可以占用服务器端更多资源，从而加快下载速度<br>使用多线程下载文件可以更快完成文件的下载，多线程下载文件之所以快，是因为其抢占的服务器资源多。如：假设服务器同时最多服务100个用户，在服务器中一条线程对应一个用户，100条线程在计算机中并非并发执行，而是由CPU划分时间片轮流执行，如果A应用使用了99条线程下载文件，那么相当于占用了99个用户的资源，假设一秒内CPU分配给每条线程的平均执行时间是10ms，A应用在服务器中一秒内就得到了990ms的执行时间，而其他应用在一秒内只有10ms的执行时间。就如同一个水龙头，每秒出水量相等的情况下，放990毫秒的水肯定比放10毫秒的水要多。</p>
</li>
<li><p>手机端下载数据时难免会出现无信号断线、电量不足等情况，所以需要断点续传功能</p>
</li>
<li>根据下载数据长度计算每个线程下载的数据位置，程序中开启多个线程并发下载</li>
<li>在请求头中设置Range字段就可以获取指定位置的数据，例如：Range: bytes=100-200</li>
<li>在下载过程中记录每个线程已拷贝数据的数量，如果下载中断，下次启动时从记录位置继续下载</li>
</ol>
<p><strong>多线程下载的实现过程</strong></p>
<ol>
<li><p>首先得到下载文件的长度，然后设置本地文件的长度。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
HttpURLConnection.getContentLength();
RandomAccessFile file = new RandomAccessFile("QQWubiSetup.exe","rwd");
file.setLength(filesize);//设置本地文件的长度
</pre>
</li>
<li><p>根据文件长度和线程数计算每条线程下载的数据长度和下载位置。如：文件的长度为6M，线程数为3，那么，每条线程下载的数据长度为2M，每条线程开始下载的位置如下图所示。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.31.43.png" alt=""></p>
</li>
<li><p>使用Http的Range头字段指定每条线程从文件的什么位置开始下载，下载到什么位置为止，如：指定从文件的2M位置开始下载，下载到位置(4M-1byte)为止，代码如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
HttpURLConnection.setRequestProperty("Range", "bytes=2097152-4194303");
</pre>
</li>
<li><p>保存文件，使用RandomAccessFile类指定每条线程从本地文件的什么位置开始写入数据。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
RandomAccessFile threadfile = new RandomAccessFile("QQWubiSetup.exe ","rwd");
threadfile.seek(2097152);//从文件的什么位置开始写入数据
</pre>

</li>
</ol>
<p><strong>多线程下载</strong><br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.33.25.png" alt=""></p>
<ol>
<li>进度条使用&lt;Progress&gt;进行配置<br>默认为圆形进度条，水平进度条需要配置style属性，?android:attr/progressBarStyleHorizontal<br>使用android.R.attr.progressBarStyleHorizontal作为样式</li>
<li><p>当点击下载按钮时开启多线程下载，下载过程中修改进度条进度<br>设置最大刻度：setMax()<br>设置当前进度：setProgress()<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class FileDownLoader {
 @Test
 public void download() throws Exception {
     String path = "http://browse.babasport.com/QQWubiSetup.exe";
     URL url = new URL(path);
     HttpURLConnection conn = (HttpURLConnection) url.openConnection();
     conn.setConnectTimeout(5*1000);
     conn.setRequestMethod("GET");
     conn.setRequestProperty("Accept", "image/gif, image/jpeg, image/pjpeg, image/pjpeg, application/x-shockwave-flash, application/xaml+xml, application/vnd.ms-xpsdocument, application/x-ms-xbap, application/x-ms-application, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*");
     conn.setRequestProperty("Accept-Language", "zh-CN");
     conn.setRequestProperty("Charset", "UTF-8");
     conn.setRequestProperty("User-Agent", "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.2; Trident/4.0; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)");
     conn.setRequestProperty("Connection", "Keep-Alive");
     System.out.println(conn.getResponseCode());

     int filesize = conn.getContentLength();//得到文件大小
     conn.disconnect();
     int threasize = 3;//线程数
     int perthreadsize = filesize / 3 + 1;
     RandomAccessFile file = new RandomAccessFile("102.wma","rw");
     file.setLength(filesize);//设置本地文件的大小
     file.close();
     for(int i=0; i<threasize ;="" i++){="" int="" startpos="i" *="" perthreadsize;="" 计算每条线程的下载位置="" randomaccessfile="" perthreadfile="new" randomaccessfile("102.wma","rw");="" perthreadfile.seek(startpos);="" 从文件的什么位置开始写入数据="" new="" downladerthread(i,="" path,="" startpos,="" perthreadsize,="" perthreadfile).start();="" }="" 以下代码要求用户输入q才会退出测试方法，如果没有下面代码，会因为进程结束而导致进程内的下载线程被销毁="" quit="System.in.read();" while('q'!="quit){" thread.sleep(2="" 1000);="" private="" class="" downladerthread="" extends="" thread{="" startpos;="" 从文件的什么位置开始下载="" 每条线程需要下载的文件大小="" string="" path;="" file;="" threadid;="" public="" downladerthread(int="" threadid,="" perthreadfile)="" {="" this.path="path;" this.startpos="startpos;" this.perthreadsize="perthreadsize;" this.file="perthreadfile;" this.threadid="threadid;" @override="" void="" run()="" try="" url="" url(path);="" httpurlconnection="" conn="(HttpURLConnection)url.openConnection();" conn.setconnecttimeout(5="" conn.setrequestmethod("get");="" conn.setrequestproperty("accept",="" "image="" gif,="" image="" jpeg,="" pjpeg,="" application="" x-shockwave-flash,="" xaml+xml,="" vnd.ms-xpsdocument,="" x-ms-xbap,="" x-ms-application,="" vnd.ms-excel,="" vnd.ms-powerpoint,="" msword,="" *");="" conn.setrequestproperty("accept-language",="" "zh-cn");="" conn.setrequestproperty("charset",="" "utf-8");="" conn.setrequestproperty("range",="" "bytes=" + this.startpos + " -");="" inputstream="" instream="conn.getInputStream();" byte[]="" buffer="new" byte[1024];="" len="0;" length="0;" while(length<perthreadsize="" &&="" (len="inStream.read(buffer))!=-1){" file.write(buffer,="" 0,="" len);="" +="len;//累计该线程下载的总大小" file.close();="" instream.close();="" system.out.println(threadid+="" "线程完成下载");="" catch="" (exception="" e)="" e.printstacktrace();="" <="" pre="">

</threasize></pre></li>
</ol>
<p><strong>断点续传</strong></p>
<ol>
<li>断点续传需要在下载过程中记录每条线程的下载进度</li>
<li>每次下载开始之前先读取数据库,查询是否有未完成的记录，有就继续下载，没有则创建新记录插入数据库</li>
<li>在每次向文件中写入数据之后，在数据库中更新下载进度</li>
<li>下载完成之后删除数据库中下载记录</li>
</ol>
<p><strong>Handler传输数据</strong></p>
<ol>
<li>主线程中创建的View只能在主线程中修改，其他线程只能通过和主线程通信，在主线程中改变View数据</li>
<li>我们使用Handler可以处理这种需求<br>主线程中创建Handler，重写handleMessage()方法<br>新线程中使用Handler发送消息，主线程即可收到消息，并且执行handleMessage()方法</li>
</ol>
<p><strong>动态生成新View</strong></p>
<ol>
<li>创建XML文件，将要生成的View配置好</li>
<li>获取系统服务LayoutInflater，用来生成新的View<br>LayoutInflater inflater = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);</li>
<li>使用inflate(int resource, ViewGroup root)方法生成新的View</li>
<li>调用当前页面中某个容器的addView，将新创建的View添加进来</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-14-android-basic-4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/06/Android基础-2011-06-14-android-basic-4.html" itemprop="url">
                  Android基础4 内容提供者（ContentProvider）
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-14T00:00:00+08:00">
                2011-06-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-14-android-basic-4.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-14-android-basic-4.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/06/Android基础-2011-06-14-android-basic-4.html" class="leancloud_visitors" data-flag-title="Android基础4 内容提供者（ContentProvider）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-什么是内容提供者"><a href="#1-什么是内容提供者" class="headerlink" title="1.什么是内容提供者"></a>1.什么是内容提供者</h2><ul>
<li>内容提供者是Android中的四大组件之一，可以将应用中的数据对外进行共享</li>
<li>内容提供者将数据的访问方式统一，不必针对不同数据类型采取不同的访问策略</li>
<li>内容提供者将数据封装，只暴露出我们希望提供给其他程序的数据</li>
<li>内容提供者中数据更改可被监听</li>
</ul>
<h2 id="2-创建内容提供者"><a href="#2-创建内容提供者" class="headerlink" title="2. 创建内容提供者"></a>2. 创建内容提供者</h2><p>定义类继承ContentProvider，根据需要重写内部方法<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class PersonContentProvider extends ContentProvider{
   public boolean onCreate()
   public Uri insert(Uri uri, ContentValues values)
   public int delete(Uri uri, String selection, String[] selectionArgs)
   public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs)
   public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)
   public String getType(Uri uri)}
</pre>

<p>在清单文件的<application>节点下进行配置，<provider>标签中需要指定name和authorities属性，name为类名，包名从程序Package开始，以“.”开始，authorities：是访问Provider时路径，要唯一。<br>&lt;?prettify?&gt;</provider></application></p>
<pre class="prettyprint">
&lt;manifest .... &gt;
    &lt;application android:icon="@drawable/icon"android:label="@string/app_name"&gt;
     &lt;provider android:name=".PersonContentProvider" android:authorities="cn.ncist.providers.personprovider"/&gt;
    &lt;/application&gt;
&lt;/manifest&gt;
</pre>

<h2 id="3-Uri介绍"><a href="#3-Uri介绍" class="headerlink" title="3.Uri介绍"></a>3.Uri介绍</h2><p>Uri代表了要操作的数据，Uri主要包含了两部分信息：</p>
<ol>
<li>需要操作的ContentProvider </li>
<li>对ContentProvider中的什么数据进行操作，一个Uri由以下几部分组成：<br>URI代表要操作的数据，由scheme、authorites、path三部分组成<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%882.24.15.png" alt=""><br>scheme：固定为content，代表访问内容提供者，authorites：<provider>节点中的authorites属性，path：程序定义的路径，可根据业务逻辑定义</provider></li>
</ol>
<h2 id="4-UriMatcher类的使用"><a href="#4-UriMatcher类的使用" class="headerlink" title="4.UriMatcher类的使用"></a>4.UriMatcher类的使用</h2><p>UriMatcher类用于匹配Uri，它的用法如下：首先第一步把你需要匹配Uri路径全部给注册上，如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
//常量UriMatcher.NO_MATCH表示不匹配任何路径的返回码
UriMatcher  sMatcher = new UriMatcher(UriMatcher.NO_MATCH);
//如果match()方法匹配content://cn.ncist.provider.personprovider/person路径，返回匹配码为1
sMatcher.addURI(“cn.ncist.provider.personprovider”, “person”, 1);//添加需要匹配uri，如果匹配就会返回匹配码
//如果match()方法匹配content://cn.ncist.provider.personprovider/person/230路径，返回匹配码为2
sMatcher.addURI(“cn.ncist.provider.personprovider”, “person/#”, 2);//#号为通配符
switch (sMatcher.match(Uri.parse("content://cn.ncist.provider.personprovider/person/10"))) { 
   case 1
    break;
   default://不匹配
    break;
}
</pre>

<p>注册完需要匹配的Uri后，就可以使用sMatcher.match(uri)方法对输入的Uri进行匹配，如果匹配就返回匹配码，匹配码是调用addURI()方法传入的第三个参数，假设匹配content://cn.ncist.provider.personprovider/person路径，返回的匹配码为1</p>
<h2 id="5-ContentUris类使用介绍"><a href="#5-ContentUris类使用介绍" class="headerlink" title="5.ContentUris类使用介绍"></a>5.ContentUris类使用介绍</h2><p>ContentUris类用于获取Uri路径后面的ID部分，它有两个比较实用的方法：</p>
<ul>
<li><p>withAppendedId(uri, id)用于为路径加上ID部分：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Uri uri = Uri.parse("content://cn.ncist.provider.personprovider/person")
Uri resultUri = ContentUris.withAppendedId(uri, 10); 
//生成后的Uri为：content://cn.ncist.provider.personprovider/person/10
</pre>
</li>
<li><p>parseId(uri)方法用于从路径中获取ID部分：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Uri uri = Uri.parse("content://cn.ncist.provider.personprovider/person/10")
long personid = ContentUris.parseId(uri);//获取的结果为:10
</pre>

</li>
</ul>
<h2 id="6-使用ContentProvider共享数据"><a href="#6-使用ContentProvider共享数据" class="headerlink" title="6.使用ContentProvider共享数据"></a>6.使用ContentProvider共享数据</h2><p>ContentProvider类主要方法的作用：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public boolean onCreate()
该方法在ContentProvider创建后就会被调用， Android开机后， ContentProvider在其它应用第一次访问它时才会被创建。
public Uri insert(Uri uri, ContentValues values)
该方法用于供外部应用往ContentProvider添加数据。
public int delete(Uri uri, String selection, String[] selectionArgs)
该方法用于供外部应用从ContentProvider删除数据。
public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs)
该方法用于供外部应用更新ContentProvider中的数据。
public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)
该方法用于供外部应用从ContentProvider中获取数据。
public String getType(Uri uri)
该方法用于返回当前Url所代表数据的MIME类型。
</pre>

<p>如果操作的数据属于集合类型，那么MIME类型字符串应该以vnd.android.cursor.dir/开头，例如：要得到所有person记录的Uri为content://cn.ncist.provider.personprovider/person，那么返回的MIME类型字符串应该为：“vnd.android.cursor.dir/person”。如果要操作的数据属于非集合类型数据，那么MIME类型字符串应该以vnd.android.cursor.item/开头，例如：得到id为10的person记录，Uri为content://cn.ncist.provider.personprovider/person/10，那么返回的MIME类型字符串应该为：“vnd.android.cursor.item/person”。</p>
<h2 id="7-使用ContentResolver操作ContentProvider中的数据"><a href="#7-使用ContentResolver操作ContentProvider中的数据" class="headerlink" title="7.使用ContentResolver操作ContentProvider中的数据"></a>7.使用ContentResolver操作ContentProvider中的数据</h2><p>当外部应用需要对ContentProvider中的数据进行添加、删除、修改和查询操作时，可以使用ContentResolver 类来完成，要获取ContentResolver 对象，可以使用Activity提供的getContentResolver()方法。 ContentResolver 类提供了与ContentProvider类相同签名的四个方法：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public Uri insert(Uri uri, ContentValues values)
该方法用于往ContentProvider添加数据。
public int delete(Uri uri, String selection, String[] selectionArgs)
该方法用于从ContentProvider删除数据。
public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs)
该方法用于更新ContentProvider中的数据。
public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)
该方法用于从ContentProvider中获取数据。
</pre>

<p>这些方法的第一个参数为Uri，代表要操作的ContentProvider和对其中的什么数据进行操作，假设给定的是： Uri.parse(“content://cn.ncist.providers.personprovider/person/10”)，那么将会对主机名为cn.ncist.providers.personprovider的ContentProvider进行操作，操作的数据为person表中id为10的记录。<br>使用ContentResolver对ContentProvider中的数据进行添加、删除、修改和查询操作：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
ContentResolver resolver =  getContentResolver();
Uri uri = Uri.parse("content://cn.ncist.provider.personprovider/person");
//添加一条记录
ContentValues values = new ContentValues();
values.put("name", "ncist");
values.put("age", 25);
resolver.insert(uri, values);        
//获取person表中所有记录
Cursor cursor = resolver.query(uri, null, null, null, "personid desc");
while(cursor.moveToNext()){
    Log.i("ContentTest", "personid="+ cursor.getInt(0)+ ",name="+ cursor.getString(1));
}
//把id为1的记录的name字段值更新为liming
ContentValues updateValues = new ContentValues();
updateValues.put("name", "liming");
Uri updateIdUri = ContentUris.withAppendedId(uri, 2);
resolver.update(updateIdUri, updateValues, null, null);
//删除id为2的记录
Uri deleteIdUri = ContentUris.withAppendedId(uri, 2);
resolver.delete(deleteIdUri, null, null);
</pre>

<h2 id="8-ContentObserver监听ContentProvider中数据的变化"><a href="#8-ContentObserver监听ContentProvider中数据的变化" class="headerlink" title="8.ContentObserver监听ContentProvider中数据的变化"></a>8.ContentObserver监听ContentProvider中数据的变化</h2><p>如果ContentProvider的访问者需要知道ContentProvider中的数据发生了变化，可以在ContentProvider 发生数据变化时调用getContentResolver().notifyChange(uri, null)来通知注册在此URI上的访问者，例子如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class PersonContentProvider extends ContentProvider {
    public Uri insert(Uri uri, ContentValues values) {
        db.insert("person", "personid", values);
        getContext().getContentResolver().notifyChange(uri, null);}}
如果ContentProvider的访问者需要得到数据变化通知，必须使用ContentObserver对数据（数据采用uri描述）进行监听，当监听到数据变化通知时，系统就会调用ContentObserver的onChange()方法：
    getContentResolver().registerContentObserver(Uri.parse("content://cn.ncist.providers.personprovider/person"),true, new PersonObserver(new Handler()));
public class PersonObserver extends ContentObserver{
    public PersonObserver(Handler handler) {
        super(handler);
     }
    public void onChange(boolean selfChange) {
        //此处可以进行相应的业务处理
    }
}
</pre>

<h2 id="9-监听发送短信"><a href="#9-监听发送短信" class="headerlink" title="9.监听发送短信"></a>9.监听发送短信</h2><p>注意事项：</p>
<ol>
<li>Android系统提供了Provider对短信进行查询，当发出短信时也会发送更改通知</li>
<li>定义一个Observer监听”content://sms”</li>
<li>在onChange()方法中查询”content://sms/outbox”</li>
<li>短信发送数据库在 com.android.providers.telephony</li>
<li>需要权限android.permission.READ_SMS<br>用户使用系统自带的短信程序发送短信，程序会通过ContentProvider把短信保存进数据库，并且发出一个数据变化通知，使用ContentObserver对数据变化进行监听，在用户发送短信时，就会被ContentObserver窃听到短信，注册监听：<br>&lt;?prettify?&gt;<pre class="prettyprint">
getContentResolver().registerContentObserver(Uri.parse("content://sms"),  true, new SmsObserver(new Handler()));
</pre>

</li>
</ol>
<p>监听类：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
private final class SmsObserver extends ContentObserver{
    public SmsObserver(Handler handler) {
        super(handler);
    }
    public void onChange(boolean selfChange) {
    //查询发送箱中的短信(处于正在发送状态的短信放在发送箱)
        Cursor cursor = getContentResolver().query(Uri.parse("content://sms/outbox"),null, null, null, null); 
        while(cursor.moveToNext()){
            StringBuilder sb = new StringBuilder();
            sb.append("_id=").append(cursor.getInt(cursor.getColumnIndex("_id")));
        sb.append(",address=").append(cursor.getString(cursor.getColumnIndex("address")));
            sb.append(";body=").append(cursor.getString(cursor.getColumnIndex("body")));
            sb.append(";time=").append(cursor.getLong(cursor.getColumnIndex("date")));
            Log.i("ReceiveSendSMS", sb.toString());
                 } }    
</pre>

<h2 id="10-操作联系人"><a href="#10-操作联系人" class="headerlink" title="10.操作联系人"></a>10.操作联系人</h2><p><strong>获取所有联系人</strong><br>Android系统中的联系人也是通过ContentProvider来对外提供数据的，数据库路径为：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
/data/data/com.android.providers.contacts/database/contacts2.db
</pre>

<p><strong>操作联系人涉及3张表</strong><br>Provider的authorites为com.android.contacts, 先查询raw_contacts得到每个联系人的id，在使用id从data表中查询对应数据，根据mimetype分类数据。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%882.39.36.png" alt=""></p>
<p><strong>通过电话号码获取联系人</strong><br>系统内部提供了根据电话号码获取data表数据的功能，路径为：data/phones/filter/<em><br>用电话号码替换“</em>”部分就可以查到所需数据，获取“display_name”可以获取到联系人显示名</p>
<p><strong>添加联系人</strong><br>先向raw_contacts表插入id，路径为：raw_contacts<br>得到id之后再向data表插入数据，路径为：data</p>
<p><strong>使用事务添加联系人</strong><br>在添加联系人得时候是分多次访问Provider，如果在过程中出现异常，会出现数据不完整的情况，这些操作应该放在一次事务中<br>使用ContentResolver的applyBatch(String authority,ArrayList<contentprovideroperation> operations) 方法可以将多个操作在一个事务中执行。文档位置:<br>/android-sdk-windows/docs/reference/android/provider/ContactsContract.RawContacts.html</contentprovideroperation></p>
<p>关键代码：</p>
<ul>
<li><p>读取联系人信息的权限<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;uses-permission android:name="android.permission.READ_CONTACTS"/&gt;
content://com.android.contacts/contacts 操作的数据是联系人信息Uri
content://com.android.contacts/data/phones 联系人电话Uri
content://com.android.contacts/data/emails 联系人Email Uri
</pre>
</li>
<li><p>取联系人信息<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Cursor cursor = getContentResolver().query(ContactsContract.Contacts.CONTENT_URI,  null, null, null, null);  
while (cursor.moveToNext()) {  
 String contactId = cursor.getString(cursor.getColumnIndex(ContactsContract.Contacts._ID));  
 String name = cursor.getString(cursor.getColumnIndex(ContactsContract.Contacts.DISPLAY_NAME));  
 Cursor phones = getContentResolver().query(ContactsContract.CommonDataKinds.Phone.CONTENT_URI,  
      null,  ContactsContract.CommonDataKinds.Phone.CONTACT_ID +" = "+ contactId, null, null);  
  while (phones.moveToNext()) {  
   String phoneNumber = phones.getString(phones.getColumnIndex(  
       ContactsContract.CommonDataKinds.Phone.NUMBER));  
   Log.i("RongActivity", "phoneNumber="+phoneNumber);
  }  
  phones.close();  
  Cursor emails = getContentResolver().query(ContactsContract.CommonDataKinds.Email.CONTENT_URI,  
     null,  ContactsContract.CommonDataKinds.Email.CONTACT_ID + " = " + contactId,   null, null);  
     while (emails.moveToNext()) {  
      // This would allow you get several email addresses  
String  emailAddress=
emails.getString(emails.getColumnIndex(ContactsContract.CommonDataKinds.Email.DATA));
      Log.i("RongActivity", "emailAddress="+ emailAddress);
     }  
     emails.close();  
}  
cursor.close(); 
</pre>
</li>
<li><p>添加联系人<br>方法一：首先向RawContacts.CONTENT_URI执行一个空值插入，目的是获取系统返回的rawContactId  这时后面插入data表的依据，只有执行空值插入，才能使插入的联系人在通讯录里面可见<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
  public void testInsert() {
      ContentValues values = new ContentValues();
  //首先向RawContacts.CONTENT_URI执行一个空值插入，目的是获取系统返回的rawContactId 
      Uri rawContactUri = this.getContext().getContentResolver().insert(RawContacts.CONTENT_URI, values);
      long rawContactId = ContentUris.parseId(rawContactUri);
      //往data表入姓名数据
      values.clear();
      values.put(Data.RAW_CONTACT_ID, rawContactId); 
      values.put(Data.MIMETYPE, StructuredName.CONTENT_ITEM_TYPE);//内容类型
      values.put(StructuredName.GIVEN_NAME, "李天山");
  this.getContext().getContentResolver().insert(android.provider.ContactsContract.Data.CONTENT_URI, values);
      //往data表入电话数据
      values.clear();
      values.put(Data.RAW_CONTACT_ID, rawContactId);
      values.put(Data.MIMETYPE, Phone.CONTENT_ITEM_TYPE);
      values.put(Phone.NUMBER, "13921009789");
      values.put(Phone.TYPE, Phone.TYPE_MOBILE);
  this.getContext().getContentResolver().insert(android.provider.ContactsContract.Data.CONTENT_URI, values);
      //往data表入Email数据
      values.clear();
      values.put(Data.RAW_CONTACT_ID, rawContactId);
      values.put(Data.MIMETYPE, Email.CONTENT_ITEM_TYPE);
      values.put(Email.DATA, "liming@ncist.cn");
      values.put(Email.TYPE, Email.TYPE_WORK);
  this.getContext().getContentResolver().insert(android.provider.ContactsContract.Data.CONTENT_URI, values);
  }
</pre>

</li>
</ul>
<p>方法二：批量添加,处于同一个事务中<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
    public void testSave() throws Throwable{
        //文档位置：reference\android\provider\ContactsContract.RawContacts.html
        ArrayList<contentprovideroperation> ops = new ArrayList<contentprovideroperation>();
        int rawContactInsertIndex = 0;
        ops.add(ContentProviderOperation.newInsert(RawContacts.CONTENT_URI)
                .withValue(RawContacts.ACCOUNT_TYPE, null)
                .withValue(RawContacts.ACCOUNT_NAME, null)
                .build());
        //文档位置：reference\android\provider\ContactsContract.Data.html
    ops.add(ContentProviderOperation.newInsert(android.provider.ContactsContract.Data.CONTENT_URI)
                .withValueBackReference(Data.RAW_CONTACT_ID, rawContactInsertIndex)
                .withValue(Data.MIMETYPE, StructuredName.CONTENT_ITEM_TYPE)
                .withValue(StructuredName.GIVEN_NAME, "赵薇")
                .build());
    ops.add(ContentProviderOperation.newInsert(android.provider.ContactsContract.Data.CONTENT_URI)
                 .withValueBackReference(Data.RAW_CONTACT_ID, rawContactInsertIndex)
                 .withValue(Data.MIMETYPE, Phone.CONTENT_ITEM_TYPE)
                 .withValue(Phone.NUMBER, "13671323809")
                 .withValue(Phone.TYPE, Phone.TYPE_MOBILE)
                 .withValue(Phone.LABEL, "手机号")
                 .build());
    ops.add(ContentProviderOperation.newInsert(android.provider.ContactsContract.Data.CONTENT_URI)
                 .withValueBackReference(Data.RAW_CONTACT_ID, rawContactInsertIndex)
                 .withValue(Data.MIMETYPE, Email.CONTENT_ITEM_TYPE)
                 .withValue(Email.DATA, "liming@ncist.cn")
                 .withValue(Email.TYPE, Email.TYPE_WORK)
                 .build());
        ContentProviderResult[] results = this.getContext().getContentResolver()
            .applyBatch(ContactsContract.AUTHORITY, ops);
        for(ContentProviderResult result : results){
            Log.i(TAG, result.uri.toString());
        }
    }
</contentprovideroperation></contentprovideroperation></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-09-android-basic-3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/06/Android基础-2011-06-09-android-basic-3.html" itemprop="url">
                  Android基础3 Android文件操作
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-11T00:00:00+08:00">
                2011-06-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-09-android-basic-3.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-09-android-basic-3.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/06/Android基础-2011-06-09-android-basic-3.html" class="leancloud_visitors" data-flag-title="Android基础3 Android文件操作">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-读写文件"><a href="#1-读写文件" class="headerlink" title="1. 读写文件"></a>1. 读写文件</h2><h3 id="1-1-写文件"><a href="#1-1-写文件" class="headerlink" title="1.1 写文件"></a>1.1 写文件</h3><p>通过Context.openFileOutput(String name, int mode)可以获取一个文件输出流。name为文件名，mode为文件模式，有4种模式。输出流指向路径为：/data/data/包名/files/ </p>
<p>文件模式在Context中有定义常量<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-01%20%E4%B8%8B%E5%8D%886.58.13.png" alt=""></p>
<p>模式可以组合使用，例如：MODE_WORLD_READABLE + MODE_WORLD_WRITEABLE，文件被其它应用读和写。</p>
<p><strong>文件访问的原理</strong><br>android有一套自己的安全模型，当应用程序(.apk)在安装时系统就会分配给他一个userid，当该应用要去访问其他资源比如文件的时候，就需要userid匹配。默认情况下，任何应用创建的文件，sharedpreferences，数据库都应该是私有的（位于/data/data/<package name="">/files），其他程序无法访问。除非在创建时指定了Context.MODE_WORLD_READABLE或者Context.MODE_WORLD_WRITEABLE ，只有这样其他程序才能正确访问。</package></p>
<p><strong>查看文件</strong><br>通过点击Eclipse菜单“Window”-“Show View”-“Other”，在对话窗口中展开android文件夹，选择下面的File Explorer视图，然后在File Explorer视图中展开/data/data/<package name="">/files目录就可以看到该文件。</package></p>
<h3 id="1-2-读文件"><a href="#1-2-读文件" class="headerlink" title="1.2 读文件"></a>1.2 读文件</h3><p>通过Context.openFileInput(String name)可以获取一个文件输入流，该输入流可以读取 /data/data/包名/files/ 路径下的文件<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
FileInputStream inStream = this.getContext().openFileInput("ncist.txt");
Log.i("FileTest", readInStream(inStream));
</pre>

<p>或者直接使用文件的绝对路径：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
File file = new File("/data/data/cn.ncist.action/files/ncist.txt");
FileInputStream inStream = new FileInputStream(file);
Log.i("FileTest", readInStream(inStream));
</pre>

<p>注意：上面文件路径中的“cn.ncist.action”为应用所在包，当你在编写代码时应替换为你自己应用使用的包。<br>Activity还提供了getCacheDir()和getFilesDir()方法：</p>
<p>getCacheDir()方法用于获取/data/data/<package name="">/cache目录<br>getFilesDir()方法用于获取/data/data/<package name="">/files目录</package></package></p>
<p>获取当前程序Files文件路径<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
 ContextWrapper.getFilesDir()
</pre>

<h3 id="1-3-写入文件到SD卡"><a href="#1-3-写入文件到SD卡" class="headerlink" title="1.3 写入文件到SD卡"></a>1.3 写入文件到SD卡</h3><p>需要在清单文件中注册权限<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;uses-permission android:name="android.permission.MOUNT_UNMOUNT_FILESYSTEMS" /&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
</pre>

<p>2.1版本以下的SDCard位置和2.2之后版本不同<br>可以通过Environment.getExternalStorageDirectory()获取当前SDCard位置，兼容所有版本</p>
<p>获取SDCard状态<br>要往SDCard存放文件，程序必须先判断手机是否装有SDCard，并且可以进行读写。通过Environment.getExternalStorageState()方法获取SDCard当前状态，常量 Environment.MEDIA_MOUNTED 为已安装。注意：访问SDCard必须在AndroidManifest.xml中加入访问SDCard的权限<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
if(Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)){
   File sdCardDir = Environment.getExternalStorageDirectory();//获取SDCard目录
   File saveFile = new File(sdCardDir, “ncist.txt”);
FileOutputStream outStream = new FileOutputStream(saveFile);
outStream.write("Android".getBytes());
outStream.close();
}
</pre>

<h2 id="2-XML解析"><a href="#2-XML解析" class="headerlink" title="2. XML解析"></a>2. XML解析</h2><h3 id="2-1-Pull简介"><a href="#2-1-Pull简介" class="headerlink" title="2.1 Pull简介"></a>2.1 Pull简介</h3><p>常见的XML解析方式有三种，DOM、SAX、Pull，Android系统中推荐使用Pull<br>Pull解析器是一个开源的Java项目，Android系统内部解析XML文件均为此种方式，也可用于JavaEE项目。</p>
<p>Android SDK中已经集成了Pull解析器，无需添加任何jar文件<br>Pull解析器运行方式与SAX类似，提供各种事件的判断跟SAX不同的是， Pull解析器产生的事件是一个数字，而非方法，因此可以使用一个switch对感兴趣的事件进行处理。当元素开始解析时，调用parser.nextText()方法可以获取下一个Text类型节点的值。</p>
<p>官方网站：<a href="http://xmlpull.org/" target="_blank" rel="external">http://xmlpull.org/</a></p>
<h3 id="2-2-使用Pull解析器解析XML文件"><a href="#2-2-使用Pull解析器解析XML文件" class="headerlink" title="2.2 使用Pull解析器解析XML文件"></a>2.2 使用Pull解析器解析XML文件</h3><p>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Xml.newPullParser() 获得解析器
parser.setInput(in, "UTF-8") 设置输入流以及编码
parser.next() 获取下一个解析事件，得到一个事件代码
XmlPullParser中定义了常量来标识各种解析事件
START_DOCUMENT、END_DOCUMENT 、START_TAG 、END_TAG 、TEXT 
</pre>

<p>使用XmlSerializer写出XML,使用以下方法生成XML，和XML文档顺序类似<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public static String writeXML(List&lt;Person&gt; persons, Writer writer){
    XmlSerializer serializer = Xml.newSerializer();
    try {
        serializer.setOutput(writer);
        serializer.startDocument("UTF-8", true);
      //第一个参数为命名空间,如果不使用命名空间,可以设置为null
        serializer.startTag("", "persons");
        for (Person person : persons){
            serializer.startTag("", "person");
            serializer.attribute("", "id", person.getId().toString());
            serializer.startTag("", "name");
            serializer.text(person.getName());
            serializer.endTag("", "name");
            serializer.startTag("", "age");
            serializer.text(person.getAge().toString());
            serializer.endTag("", "age");
            serializer.endTag("", "person");
        }
        serializer.endTag("", "persons");
        serializer.endDocument();
        return writer.toString();
    } catch (Exception e) {
        e.printStackTrace();
    }
    return null;
}
</pre>

<h2 id="3-偏好设定（SharedPreferences）"><a href="#3-偏好设定（SharedPreferences）" class="headerlink" title="3. 偏好设定（SharedPreferences）"></a>3. 偏好设定（SharedPreferences）</h2><p>在程序中保存一些配置参数的时候我们经常使用SharedPreferences<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Context.getSharedPreferences(String name,int mode)
</pre>

<p>该方法可以在/data/data/<package>/shared_pref/目录下创建一个以name命名的xml文件，mode文件为模式</package></p>
<h3 id="3-1-存储偏好"><a href="#3-1-存储偏好" class="headerlink" title="3.1 存储偏好"></a>3.1 存储偏好</h3><p>调用edit()方法可以获取一个Editor对象，对数据进行存储，存储之后需要调用commit()保存到文件。因为SharedPreferences背后是使用xml文件保存数据，getSharedPreferences(name,mode)方法的第一个参数用于指定该文件的名称，名称不用带后缀，后缀会由Android自动加上。方法的第二个参数指定文件的操作模式，共有四种操作模式，如果希望SharedPreferences背后使用的xml文件能被其他应用读和写，可以指定Context.MODE_WORLD_READABLE和Context.MODE_WORLD_WRITEABLE权限。</p>
<p>在Activity中获取SharedPreferences<br>在Activity中可以调用getPreferences(int mode)方法获得一个SharedPreferences，文件名和Activity名一致<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
SharedPreferences sharedPreferences = getSharedPreferences("ncist", Context.MODE_PRIVATE);
Editor editor = sharedPreferences.edit();//获取编辑器
editor.putString("name", "Android");
editor.putInt("age", 4);
editor.commit();//提交修改
</pre>

<h3 id="3-2-读取偏好"><a href="#3-2-读取偏好" class="headerlink" title="3.2 读取偏好"></a>3.2 读取偏好</h3><p>获得SharedPreferences之后调用getString()、getInt()等方法获取其中设置的值<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
SharedPreferences sharedPreferences = getSharedPreferences("ncist", Context.MODE_PRIVATE);
//getString()第二个参数为缺省值，如果preference中不存在该key，将返回缺省值
String name = sharedPreferences.getString("name", "");
int age = sharedPreferences.getInt("age", 1);
</pre>

<p>如果访问其他应用中的Preference，前提条件是：该preference创建时指定了Context.MODE_WORLD_READABLE或者Context.MODE_WORLD_WRITEABLE权限。如：有个<package name="">为cn.ncist.action的应用使用下面语句创建了preference。<br>&lt;?prettify?&gt;</package></p>
<pre class="prettyprint">
getSharedPreferences("ncist", Context.MODE_WORLD_READABLE);
</pre>

<p>其他应用要访问上面应用的preference，首先需要创建上面应用的Context，然后通过Context 访问preference ，访问preference时会在应用所在包下的shared_prefs目录找到preference ：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
Context otherAppsContext = createPackageContext("cn.ncist.action", Context.CONTEXT_IGNORE_SECURITY);
SharedPreferences sharedPreferences = otherAppsContext.getSharedPreferences("ncist", Context.MODE_WORLD_READABLE);
String name = sharedPreferences.getString("name", "");
int age = sharedPreferences.getInt("age", 0);
</pre>

<p>如果不通过创建Context访问其他应用的preference，也可以以读取xml文件方式直接访问其他应用preference对应的xml文件，如：<br>File xmlFile = new File(“/data/data/<package name="">/shared_prefs/ncist.xml”);//<package name="">应替换成应用的包名</package></package></p>
<h2 id="4-数据库（SQLite）"><a href="#4-数据库（SQLite）" class="headerlink" title="4. 数据库（SQLite）"></a>4. 数据库（SQLite）</h2><h3 id="4-1-SQLite特点"><a href="#4-1-SQLite特点" class="headerlink" title="4.1 SQLite特点"></a>4.1 SQLite特点</h3><p>Android平台中嵌入了一个关系型数据库SQLite，和其他数据库不同的是SQLite存储数据时不区分类型，例如一个字段声明为Integer类型，我们也可以将一个字符串存入，一个字段声明为布尔型，我们也可以存入浮点数。除非是主键被定义为Integer，这时只能存储64位整数<br>创建数据库的表时可以不指定数据类型，例如：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint"> 
CREATE TABLE person(id INTEGER PRIMARY KEY, name)
</pre>

<p>SQLite支持大部分标准SQL语句，增删改查语句都是通用的，分页查询语句和MySQL相同<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint"> 
SELECT * FROM person LIMIT 20 OFFSET 10
SELECT * FROM person LIMIT 20,10
</pre>

<h3 id="4-2-创建数据库"><a href="#4-2-创建数据库" class="headerlink" title="4.2 创建数据库"></a>4.2 创建数据库</h3><ul>
<li>定义类继承SQLiteOpenHelper</li>
<li>声明构造函数，4个参数</li>
<li>重写onCreate()方法</li>
<li>重写upGrade()方法</li>
</ul>
<p>为了实现对数据库版本进行管理，SQLiteOpenHelper类提供了两个重要的方法，分别是onCreate(SQLiteDatabase db)和onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion)，前者用于初次使用软件时生成数据库表，后者用于升级软件时更新数据库表结构。</p>
<p>当调用SQLiteOpenHelper的getWritableDatabase()或者getReadableDatabase()方法获取用于操作数据库的SQLiteDatabase实例的时候，如果数据库不存在，Android系统会自动生成一个数据库，接着调用onCreate()方法，onCreate()方法在初次生成数据库时才会被调用，在onCreate()方法里可以生成数据库表结构及添加一些应用使用到的初始化数据。onUpgrade()方法在数据库的版本发生变化时会被调用，一般在软件升级时才需改变版本号，并且在onUpgrade()方法里面实现表结构的更新。当软件的版本升级次数比较多，这时在onUpgrade()方法里面可以根据原版号和目标版本号进行判断，然后作出相应的表结构及数据更新。</p>
<p>getWritableDatabase()和getReadableDatabase()方法都可以获取一个用于操作数据库的SQLiteDatabase实例。但getWritableDatabase() 方法以读写方式打开数据库，一旦数据库的磁盘空间满了，数据库就只能读而不能写，倘若使用getWritableDatabase()打开数据库就会出错。getReadableDatabase()方法先以读写方式打开数据库，如果数据库的磁盘空间满了，就会打开失败，当打开失败后会继续尝试以只读方式打开数据库。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint"> 
public class DatabaseHelper extends SQLiteOpenHelper {
    //类没有实例化,是不能用作父类构造器的参数,必须声明为静态
      private static final String name = "ncist"; //数据库名称
      private static final int version = 1; //数据库版本
      public DatabaseHelper(Context context) {
//第三个参数CursorFactory指定在执行查询时获得一个游标实例的工厂类,设置为null,代表使用系统默认的工厂类
        super(context, name, null, version);
}
public void onCreate(SQLiteDatabase db) {
db.execSQL("CREATE TABLE IF NOT EXISTS person (personid integer primary key autoincrement, name varchar(20), age INTEGER)");   
}
public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
db.execSQL(" ALTER TABLE person ADD phone VARCHAR(12) NULL "); //往表中增加一列
    // DROP TABLE IF EXISTS person 删除表
 }}
</pre>

<h3 id="4-3-CRUD操作"><a href="#4-3-CRUD操作" class="headerlink" title="4.3 CRUD操作"></a>4.3 CRUD操作</h3><h4 id="4-3-1-execSQL-和rawQuery-方法"><a href="#4-3-1-execSQL-和rawQuery-方法" class="headerlink" title="4.3.1 execSQL()和rawQuery()方法"></a>4.3.1 execSQL()和rawQuery()方法</h4><p>和JDBC访问数据库不同，操作SQLite数据库无需加载驱动，不用获取连接，直接可以使用，获取SQLiteDatabase对象之后通过该对象直接可以执行SQL语句。对SQLiteDatabase的学习，我们应该重点掌握execSQL()和rawQuery()方法。 execSQL()方法可以执行insert、delete、update和CREATE TABLE之类有更改行为的SQL语句； rawQuery()方法用于执行select语句。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
SQLiteDatabase db = ....;
db.execSQL("insert into person(name, age) values(?,?)", new Object[]{"Android", 4}); 
db.close();
</pre>

<p>execSQL(String sql, Object[] bindArgs)方法的第一个参数为SQL语句，第二个参数为SQL语句中占位符参数的值，参数值在数组中的顺序要和占位符的位置对应。<br>SQLiteDatabase的rawQuery() 用于执行select语句，使用例子如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
SQLiteDatabase db = ....;
Cursor cursor = db.rawQuery(“select * from person”, null);
while (cursor.moveToNext()) {
    int personid = cursor.getInt(0); //获取第一列的值,第一列的索引从0开始
    String name = cursor.getString(1);//获取第二列的值
    int age = cursor.getInt(2);//获取第三列的值
}
cursor.close();
db.close(); 
</pre>

<p>rawQuery()方法的第一个参数为select语句；第二个参数为select语句中占位符参数的值，如果select语句没有使用占位符，该参数可以设置为null。带占位符参数的select语句使用例子如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint"> 
Cursor cursor = db.rawQuery("select * from person where name like ? and age=?", new String[]{"%华科%", "4"});
</pre>

<p>Cursor是结果集游标，用于对结果集进行随机访问，如果大家熟悉jdbc， 其实Cursor与JDBC中的ResultSet作用很相似。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-01%20%E4%B8%8B%E5%8D%887.10.06.png" alt=""></p>
<h4 id="4-3-2-getReadableDatabase-和getWritableDatabase-的区别"><a href="#4-3-2-getReadableDatabase-和getWritableDatabase-的区别" class="headerlink" title="4.3.2 getReadableDatabase()和getWritableDatabase()的区别"></a>4.3.2 getReadableDatabase()和getWritableDatabase()的区别</h4><p>查看源代码后我们发现getReadableDatabase()在通常情况下返回的就是getWritableDatabase()拿到的数据库只有在抛出异常的时候才会以只读方式打开。</p>
<p><strong>数据库对象缓存</strong></p>
<p>getWritableDatabase()方法最后会使用一个成员变量记住这个数据库对象，下次打开时判断是否重用SQLiteDatabase封装了insert()、delete()、update()、query()四个方法也可以对数据库进行操作。这些方法封装了部分SQL语句，通过参数进行拼接.</p>
<h3 id="4-4-事务处理"><a href="#4-4-事务处理" class="headerlink" title="4.4 事务处理"></a>4.4 事务处理</h3><p>在使用SQLite数据库时可以使用SQLiteDatabase类中定义的相关方法控制事务<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint"> 
beginTransaction() 开启事务
setTransactionSuccessful() 设置事务成功标记
endTransaction() 结束事务
</pre>

<p>如果程序执行到endTransaction()之前调用了setTransactionSuccessful() 方法设置事务的标志为成功则提交事务，如果没有调用setTransactionSuccessful() 方法则回滚事务。使用例子如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
SQLiteDatabase db = ....;
db.beginTransaction();//开始事务
try {
    db.execSQL("insert into person(name, age) values(?,?)", new Object[]{"Android", 4});
    db.execSQL("update person set name=? where personid=?", new Object[]{"Android", 1});
db.setTransactionSuccessful();
//调用此方法会在执行到endTransaction() 时提交当前事务，如果不调用此方法会回滚事务
} finally {
    db.endTransaction();//由事务的标志决定是提交事务，还是回滚事务
} 
db.close();
</pre>

<p>endTransaction()需要放在finally中执行，否则事务只有到超时的时候才自动结束会降低数据库并发效率。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-07-android-basic-2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/2011/06/Android基础-2011-06-07-android-basic-2.html" itemprop="url">
                  Android基础2 布局
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-07T00:00:00+08:00">
                2011-06-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-07-android-basic-2.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-07-android-basic-2.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/blog/2011/06/Android基础-2011-06-07-android-basic-2.html" class="leancloud_visitors" data-flag-title="Android基础2 布局">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-布局"><a href="#1-布局" class="headerlink" title="1. 布局"></a>1. 布局</h2><p>Android 有4种布局方式，分别是Linearlayout(线性布局)、RelativeLayout（相对布局）、TableLayout（表格布局）、FrameLayout（帧布局）。</p>
<h3 id="1-1-Linearlayout-线性布局"><a href="#1-1-Linearlayout-线性布局" class="headerlink" title="1.1 Linearlayout(线性布局)"></a>1.1 Linearlayout(线性布局)</h3><p>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="fill_parent"
android:layout_height="fill_parent"    
android:orientation="vertical"&gt;
</pre>

<ul>
<li>属性“xmlns:android”指定命名空间，顶级元素必须指定命名空间，而在该命名空间中的控件的属性，要在属性前加上“android”做前缀。</li>
<li>属性“layout_width”指定该元素的宽度，可选值有三种，“fill_parent”、“wrap_content”、具体数字。其中，“fill_parent”代表填满其父元素，对于顶级元素来说，其父元素就是整个手机屏幕。“wrap_content”代表该元素的大小仅包裹其自身的内容，而数字则代表其占相应的px。</li>
<li>属性“layout_height”指定该元素的高度，可选参数值与“layout_width”的参数意义相同。</li>
<li>属性“orientation”指定子元素的排列方式，其中指定为“vertical”则是子元素垂直排列，每个子元素会占独立的一行。而另一个可选值为“horizontal”代表子元素水平排列，即每个子元素会占独立的一列。</li>
</ul>
<h3 id="1-2-RelativeLayout（相对布局）"><a href="#1-2-RelativeLayout（相对布局）" class="headerlink" title="1.2 RelativeLayout（相对布局）"></a>1.2 RelativeLayout（相对布局）</h3><p>文档位置：    android-sdk-windows/docs/guide/topics/ui/layout-objects.html#relativelayout</p>
<p>相对布局中的视图组件是按照相互之间的相对位置来确定的。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-01%20%E4%B8%8B%E5%8D%886.39.18.png" alt=""></p>
<h3 id="1-3-TableLayout（表格布局）"><a href="#1-3-TableLayout（表格布局）" class="headerlink" title="1.3 TableLayout（表格布局）"></a>1.3 TableLayout（表格布局）</h3><p>文档位置：android-sdk-windows/docs/guide/topics/ui/layout-objects.html#tablelayout<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-01%20%E4%B8%8B%E5%8D%886.40.31.png" alt=""></p>
<h3 id="1-4-FrameLayout（帧布局）"><a href="#1-4-FrameLayout（帧布局）" class="headerlink" title="1.4 FrameLayout（帧布局）"></a>1.4 FrameLayout（帧布局）</h3><p>文档位置：android-sdk-windows/docs/guide/topics/ui/layout-objects.html#framelayout</p>
<h2 id="2-Junit"><a href="#2-Junit" class="headerlink" title="2. Junit"></a>2. Junit</h2><ol>
<li><p>项目中添加测试类<br>在AndroidManifest.xml清单文件中添加配置<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
&lt;uses-library android:name="android.test.runner" /&gt;    
&lt;instrumentation 
 android:targetPackage="cn.ncist.junit"     android:name="android.test.InstrumentationTestRunner" /&gt;
</pre>
</li>
<li><p>定义一个类继承AndroidTestCase，定义测试方法</p>
</li>
<li>在Outline视图下右键点击测试方法 – Run as – Android Junit Test</li>
<li>创建测试项目<br>创建Android Test Project<br>输入项目名，选择一个已存在的工程，Eclipse可以自动配置Junit环境</li>
</ol>
<h2 id="3-日志信息"><a href="#3-日志信息" class="headerlink" title="3. 日志信息"></a>3. 日志信息</h2><p><strong>调试android程序的两种手段</strong>：</p>
<ol>
<li>debug模式<br>打断点，debug as –&gt;android application</li>
</ol>
<p>如果程序长时间停留在waiting dubug页面 –&gt;androidmainfest.xml在application节点中增加属性debuggable = true；</p>
<ol>
<li>输出log，看logcat的信息，android 将日志信息打印到logcat中。日志信息的级别;<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-01%20%E4%B8%8B%E5%8D%886.44.36.png" alt=""></li>
</ol>
<p>在LogCat视图中我们可以看到程序的日志信息，也可以在程序中输出信息到LogCat中。程序中我们可以使用Log类来输出信息。</p>
<p>System.out和System.err输出的信息也会显示在LogCat中，注意System.out输出信息是Info级别，System.err是Warn级别。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Scott" />
          <p class="site-author-name" itemprop="name">Scott</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Scott</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Scott.disqus.com/count.js" async></script>
    

    

  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("iH9ug4Eu98bS8XiH30QEwODs-gzGzoHsz", "D0qgHUsqtcQOClhgS4ElkmDQ");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
