<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android基础," />





  <link rel="alternate" href="/atom.xml" title="Scott-小白" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="1. 获取网络图片 通过URL对象封装地址，打开一个HttpURLConnection 设置超时时间以及请求方式 获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据 通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象 需要访问网络的权限 &amp;lt;?p">
<meta name="keywords" content="Android基础">
<meta property="og:type" content="article">
<meta property="og:title" content="Android基础5 网络通信">
<meta property="og:url" content="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-15-android-basic-5.html">
<meta property="og:site_name" content="Scott-小白">
<meta property="og:description" content="1. 获取网络图片 通过URL对象封装地址，打开一个HttpURLConnection 设置超时时间以及请求方式 获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据 通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象 需要访问网络的权限 &amp;lt;?p">
<meta property="og:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png">
<meta property="og:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.31.43.png">
<meta property="og:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.33.25.png">
<meta property="og:updated_time" content="2016-11-22T01:59:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android基础5 网络通信">
<meta name="twitter:description" content="1. 获取网络图片 通过URL对象封装地址，打开一个HttpURLConnection 设置超时时间以及请求方式 获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据 通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象 需要访问网络的权限 &amp;lt;?p">
<meta name="twitter:image" content="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-15-android-basic-5.html"/>





  <title>Android基础5 网络通信 | Scott-小白</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?760edc77a59a2329550e2d68c6400d9b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Scott-小白</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.sguotao.com/blog/2011/06/Android基础-2011-06-15-android-basic-5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Scott">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Scott-小白">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                Android基础5 网络通信
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-06-15T00:00:00+08:00">
                2011-06-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2011/06/Android基础-2011-06-15-android-basic-5.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="/blog/2011/06/Android基础-2011-06-15-android-basic-5.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1-获取网络图片"><a href="#1-获取网络图片" class="headerlink" title="1. 获取网络图片"></a>1. 获取网络图片</h2><ol>
<li>通过URL对象封装地址，打开一个HttpURLConnection</li>
<li>设置超时时间以及请求方式</li>
<li>获取相应码，如果成功返回200即可从HttpURLConnection中获取输入流读取数据</li>
<li>通过BitmapFactory的decodeByteArray(byte[] data, int offset, int length)方法将数据转换为图片对象</li>
<li>需要访问网络的权限<br> <uses-permission android:name="android.permission.INTERNET"><br>&lt;?prettify?&gt;<pre class="prettyprint">
URL url = new URL("http://photocdn.sohu.com/20100125/Img269812337.jpg");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);
conn.setRequestMethod("GET");
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();
readAsFile(is, "Img269812337.jpg"); 
public static void readAsFile(InputStream inSream, File file) throws Exception{
 FileOutputStream outStream = new FileOutputStream(file);
 byte[] buffer = new byte[1024];
 int len = -1;
 while( (len = inSream.read(buffer)) != -1 ){
     outStream.write(buffer, 0, len);
 }
  outStream.close();
 inSream.close();
}
</pre>

</uses-permission></li>
</ol>
<h2 id="2-获取HTML代码"><a href="#2-获取HTML代码" class="headerlink" title="2. 获取HTML代码"></a>2. 获取HTML代码</h2><ol>
<li>和获取图片相同，使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>需要获取服务器端代码的编码</li>
<li>代码过长屏幕显示不全可以使用<scrollview>进行显示<br>&lt;?prettify?&gt;<pre class="prettyprint">
URL url = new URL("http://www.sohu.com");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);//设置连接超时
conn.setRequestMethod(“GET”);//以get方式发起请求
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();//得到网络返回的输入流
String result = readData(is, "GBK");
conn.disconnect();
//第一个参数为输入流,第二个参数为字符集编码
public static String readData(InputStream inSream, String charsetName) throws Exception{
 ByteArrayOutputStream outStream = new ByteArrayOutputStream();
 byte[] buffer = new byte[1024];
 int len = -1;
 while( (len = inSream.read(buffer)) != -1 ){
     outStream.write(buffer, 0, len);
 }
 byte[] data = outStream.toByteArray();
 outStream.close();
 inSream.close();
 return new String(data, charsetName);
</pre>

</scrollview></li>
</ol>
<h2 id="3-获取XML"><a href="#3-获取XML" class="headerlink" title="3. 获取XML"></a>3. 获取XML</h2><ol>
<li>使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>使用XmlPullPaser解析</li>
</ol>
<h2 id="4-获取Json"><a href="#4-获取Json" class="headerlink" title="4. 获取Json"></a>4. 获取Json</h2><ol>
<li>使用URL封装路径，打开一个HttpURLConnection</li>
<li>设置头信息之后获取相应码，从输入流中获取数据</li>
<li>将数据转为String，封装成JSONArray对象</li>
<li>遍历JSONArray对象，获取其中的JSONObject</li>
<li>再从JSONObject中获取每个字段的信息</li>
</ol>
<h2 id="5-发送Get请求"><a href="#5-发送Get请求" class="headerlink" title="5. 发送Get请求"></a>5. 发送Get请求</h2><ol>
<li>拼接路径和参数，通过URL进行封装，打开一个HttpURLConnection，发送请求</li>
<li>如果参数是中文会出现乱码</li>
<li>URL中包含的中文参数需要使用URLEncoder进行编码</li>
<li>服务器端如果是TOMCAT，其默认使用ISO8859-1编码，接收时需要处理编码问题</li>
</ol>
<h2 id="6-发送Post请求"><a href="#6-发送Post请求" class="headerlink" title="6. 发送Post请求"></a>6. 发送Post请求</h2><ol>
<li>通过URL打开一个HttpURLConnection</li>
<li>头信息中除了超时时间和请求方式之外还必须设置Content-Type和Content-Length</li>
<li>从HttpURLConnection获得输出流输出参数数据</li>
<li>服务端可以使用request对象的setCharacterEncoding方法设置编码<br>&lt;?prettify?&gt;<pre class="prettyprint">
StringBuilder xml =  new StringBuilder();
xml.append("&lt;?xml version=\"1.0\" encoding=\"utf-8\" ?&gt;");
xml.append("&lt;M1 V=10000&gt;");
xml.append("&lt;U I=1 D=\"N73\"&gt;中国&lt;/U&gt;");
xml.append("&lt;/M1&gt;");
byte[] xmlbyte = xml.toString().getBytes("UTF-8");
URL url = new URL("http://localhost:8080/ncist/contanctmanage.do?method=readxml");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);
conn.setDoOutput(true);//允许输出
conn.setUseCaches(false);//不使用Cache
conn.setRequestMethod("POST");            
conn.setRequestProperty("Connection", "Keep-Alive");//维持长连接
conn.setRequestProperty("Charset", "UTF-8");
conn.setRequestProperty("Content-Length", String.valueOf(xmlbyte.length));
conn.setRequestProperty("Content-Type", "text/xml; charset=UTF-8");
DataOutputStream outStream = new DataOutputStream(conn.getOutputStream());
outStream.write(xmlbyte);//发送xml数据
outStream.flush();
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();//获取返回数据
String result = readAsString(is, "UTF-8");
outStream.close();    
</pre>

</li>
</ol>
<h2 id="7-Http协议上传文件"><a href="#7-Http协议上传文件" class="headerlink" title="7.Http协议上传文件"></a>7.Http协议上传文件</h2><ol>
<li>搭建服务器，完成上传功能</li>
<li>使用浏览器上传，查看请求信息</li>
</ol>
<p><strong>HttpURLConnection</strong></p>
<ol>
<li>通过URL封装路径打开一个HttpURLConnection</li>
<li>设置请求方式以及头字段：Content-Type、Content-Length、Host</li>
<li>拼接数据发送</li>
</ol>
<p><strong>Socket</strong></p>
<ol>
<li>使用HttpURLConnection发送时内部有缓存机制，如果上传较大文件会导致内存溢出</li>
<li>我们可以使用Socket发送TCP请求，将上传数据分段发送</li>
</ol>
<h2 id="8-发送Xml，访问WebService"><a href="#8-发送Xml，访问WebService" class="headerlink" title="8.发送Xml，访问WebService"></a>8.发送Xml，访问WebService</h2><p><strong>发送XML</strong></p>
<ol>
<li>通过URL封装路径打开一个HttpURLConnection</li>
<li>设置请求方式，Content-Type和Content-Length，XML文件的Content-Type为：text/xml;     charset=UTF-8</li>
<li>使用HttpURLConnection获取输出流输出数据<br>&lt;?prettify?&gt;<pre class="prettyprint">
StringBuilder xml =  new StringBuilder();
xml.append("&lt;?xml version=\"1.0\" encoding=\"utf-8\" ?&gt;");
xml.append("&lt;M1 V=10000&gt;");
xml.append("&lt;U I=1 D=\"N73\"&gt;中国&lt;/U&gt;");
xml.append("&lt;/M1&gt;");
byte[] xmlbyte = xml.toString().getBytes("UTF-8");
URL url = new URL("http://localhost:8080/ncist/contanctmanage.do?method=readxml");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.setConnectTimeout(5* 1000);
conn.setDoOutput(true);//允许输出
conn.setUseCaches(false);//不使用Cache
conn.setRequestMethod("POST");            
conn.setRequestProperty("Connection", "Keep-Alive");//维持长连接
conn.setRequestProperty("Charset", "UTF-8");
conn.setRequestProperty("Content-Length", String.valueOf(xmlbyte.length));
conn.setRequestProperty("Content-Type", "text/xml; charset=UTF-8");
DataOutputStream outStream = new DataOutputStream(conn.getOutputStream());
outStream.write(xmlbyte);//发送xml数据
outStream.flush();
if (conn.getResponseCode() != 200) throw new RuntimeException("请求url失败");
InputStream is = conn.getInputStream();//获取返回数据
String result = readAsString(is, "UTF-8");
outStream.close();
</pre>

</li>
</ol>
<p><strong>WebService</strong></p>
<ol>
<li>WebService是发布在网络上的API，可以通过发送XML调用，WebService返回结果也是XML数据</li>
<li>WebService没有语言限制，只要可以发送XML数据和接收XML数据即可</li>
<li><a href="http://www.webxml.com.cn" target="_blank" rel="external">http://www.webxml.com.cn</a> 网站上提供了一些WebService服务，我们可以对其进行调用</li>
<li><a href="http://webservice.webxml.com.cn/WebServices/MobileCodeWS.asmx?op=getMobileCodeInfo" target="_blank" rel="external">http://webservice.webxml.com.cn/WebServices/MobileCodeWS.asmx?op=getMobileCodeInfo</a> 中提供了电话归属地查询的使用说明<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.19.32.png" alt=""></li>
</ol>
<h2 id="9-多线程断点续传"><a href="#9-多线程断点续传" class="headerlink" title="9.多线程断点续传"></a>9.多线程断点续传</h2><ol>
<li><p>在下载的时候多个线程并发可以占用服务器端更多资源，从而加快下载速度<br>使用多线程下载文件可以更快完成文件的下载，多线程下载文件之所以快，是因为其抢占的服务器资源多。如：假设服务器同时最多服务100个用户，在服务器中一条线程对应一个用户，100条线程在计算机中并非并发执行，而是由CPU划分时间片轮流执行，如果A应用使用了99条线程下载文件，那么相当于占用了99个用户的资源，假设一秒内CPU分配给每条线程的平均执行时间是10ms，A应用在服务器中一秒内就得到了990ms的执行时间，而其他应用在一秒内只有10ms的执行时间。就如同一个水龙头，每秒出水量相等的情况下，放990毫秒的水肯定比放10毫秒的水要多。</p>
</li>
<li><p>手机端下载数据时难免会出现无信号断线、电量不足等情况，所以需要断点续传功能</p>
</li>
<li>根据下载数据长度计算每个线程下载的数据位置，程序中开启多个线程并发下载</li>
<li>在请求头中设置Range字段就可以获取指定位置的数据，例如：Range: bytes=100-200</li>
<li>在下载过程中记录每个线程已拷贝数据的数量，如果下载中断，下次启动时从记录位置继续下载</li>
</ol>
<p><strong>多线程下载的实现过程</strong></p>
<ol>
<li><p>首先得到下载文件的长度，然后设置本地文件的长度。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
HttpURLConnection.getContentLength();
RandomAccessFile file = new RandomAccessFile("QQWubiSetup.exe","rwd");
file.setLength(filesize);//设置本地文件的长度
</pre>
</li>
<li><p>根据文件长度和线程数计算每条线程下载的数据长度和下载位置。如：文件的长度为6M，线程数为3，那么，每条线程下载的数据长度为2M，每条线程开始下载的位置如下图所示。<br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.31.43.png" alt=""></p>
</li>
<li><p>使用Http的Range头字段指定每条线程从文件的什么位置开始下载，下载到什么位置为止，如：指定从文件的2M位置开始下载，下载到位置(4M-1byte)为止，代码如下：<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
HttpURLConnection.setRequestProperty("Range", "bytes=2097152-4194303");
</pre>
</li>
<li><p>保存文件，使用RandomAccessFile类指定每条线程从本地文件的什么位置开始写入数据。<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
RandomAccessFile threadfile = new RandomAccessFile("QQWubiSetup.exe ","rwd");
threadfile.seek(2097152);//从文件的什么位置开始写入数据
</pre>

</li>
</ol>
<p><strong>多线程下载</strong><br><img src="http://7u2np3.com1.z0.glb.clouddn.com/blog%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-06-14%20%E4%B8%8B%E5%8D%883.33.25.png" alt=""></p>
<ol>
<li>进度条使用&lt;Progress&gt;进行配置<br>默认为圆形进度条，水平进度条需要配置style属性，?android:attr/progressBarStyleHorizontal<br>使用android.R.attr.progressBarStyleHorizontal作为样式</li>
<li><p>当点击下载按钮时开启多线程下载，下载过程中修改进度条进度<br>设置最大刻度：setMax()<br>设置当前进度：setProgress()<br>&lt;?prettify?&gt;</p>
<pre class="prettyprint">
public class FileDownLoader {
 @Test
 public void download() throws Exception {
     String path = "http://browse.babasport.com/QQWubiSetup.exe";
     URL url = new URL(path);
     HttpURLConnection conn = (HttpURLConnection) url.openConnection();
     conn.setConnectTimeout(5*1000);
     conn.setRequestMethod("GET");
     conn.setRequestProperty("Accept", "image/gif, image/jpeg, image/pjpeg, image/pjpeg, application/x-shockwave-flash, application/xaml+xml, application/vnd.ms-xpsdocument, application/x-ms-xbap, application/x-ms-application, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*");
     conn.setRequestProperty("Accept-Language", "zh-CN");
     conn.setRequestProperty("Charset", "UTF-8");
     conn.setRequestProperty("User-Agent", "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.2; Trident/4.0; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)");
     conn.setRequestProperty("Connection", "Keep-Alive");
     System.out.println(conn.getResponseCode());

     int filesize = conn.getContentLength();//得到文件大小
     conn.disconnect();
     int threasize = 3;//线程数
     int perthreadsize = filesize / 3 + 1;
     RandomAccessFile file = new RandomAccessFile("102.wma","rw");
     file.setLength(filesize);//设置本地文件的大小
     file.close();
     for(int i=0; i<threasize ;="" i++){="" int="" startpos="i" *="" perthreadsize;="" 计算每条线程的下载位置="" randomaccessfile="" perthreadfile="new" randomaccessfile("102.wma","rw");="" perthreadfile.seek(startpos);="" 从文件的什么位置开始写入数据="" new="" downladerthread(i,="" path,="" startpos,="" perthreadsize,="" perthreadfile).start();="" }="" 以下代码要求用户输入q才会退出测试方法，如果没有下面代码，会因为进程结束而导致进程内的下载线程被销毁="" quit="System.in.read();" while('q'!="quit){" thread.sleep(2="" 1000);="" private="" class="" downladerthread="" extends="" thread{="" startpos;="" 从文件的什么位置开始下载="" 每条线程需要下载的文件大小="" string="" path;="" file;="" threadid;="" public="" downladerthread(int="" threadid,="" perthreadfile)="" {="" this.path="path;" this.startpos="startpos;" this.perthreadsize="perthreadsize;" this.file="perthreadfile;" this.threadid="threadid;" @override="" void="" run()="" try="" url="" url(path);="" httpurlconnection="" conn="(HttpURLConnection)url.openConnection();" conn.setconnecttimeout(5="" conn.setrequestmethod("get");="" conn.setrequestproperty("accept",="" "image="" gif,="" image="" jpeg,="" pjpeg,="" application="" x-shockwave-flash,="" xaml+xml,="" vnd.ms-xpsdocument,="" x-ms-xbap,="" x-ms-application,="" vnd.ms-excel,="" vnd.ms-powerpoint,="" msword,="" *");="" conn.setrequestproperty("accept-language",="" "zh-cn");="" conn.setrequestproperty("charset",="" "utf-8");="" conn.setrequestproperty("range",="" "bytes=" + this.startpos + " -");="" inputstream="" instream="conn.getInputStream();" byte[]="" buffer="new" byte[1024];="" len="0;" length="0;" while(length<perthreadsize="" &&="" (len="inStream.read(buffer))!=-1){" file.write(buffer,="" 0,="" len);="" +="len;//累计该线程下载的总大小" file.close();="" instream.close();="" system.out.println(threadid+="" "线程完成下载");="" catch="" (exception="" e)="" e.printstacktrace();="" <="" pre="">

</threasize></pre></li>
</ol>
<p><strong>断点续传</strong></p>
<ol>
<li>断点续传需要在下载过程中记录每条线程的下载进度</li>
<li>每次下载开始之前先读取数据库,查询是否有未完成的记录，有就继续下载，没有则创建新记录插入数据库</li>
<li>在每次向文件中写入数据之后，在数据库中更新下载进度</li>
<li>下载完成之后删除数据库中下载记录</li>
</ol>
<p><strong>Handler传输数据</strong></p>
<ol>
<li>主线程中创建的View只能在主线程中修改，其他线程只能通过和主线程通信，在主线程中改变View数据</li>
<li>我们使用Handler可以处理这种需求<br>主线程中创建Handler，重写handleMessage()方法<br>新线程中使用Handler发送消息，主线程即可收到消息，并且执行handleMessage()方法</li>
</ol>
<p><strong>动态生成新View</strong></p>
<ol>
<li>创建XML文件，将要生成的View配置好</li>
<li>获取系统服务LayoutInflater，用来生成新的View<br>LayoutInflater inflater = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);</li>
<li>使用inflate(int resource, ViewGroup root)方法生成新的View</li>
<li>调用当前页面中某个容器的addView，将新创建的View添加进来</li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android基础/" rel="tag"># Android基础</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2011/06/Android基础-2011-06-27-android-basic-6.html" rel="next" title="Android基础6 活动(Activity)">
                <i class="fa fa-chevron-left"></i> Android基础6 活动(Activity)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2011/06/Android基础-2011-06-14-android-basic-4.html" rel="prev" title="Android基础4 内容提供者（ContentProvider）">
                Android基础4 内容提供者（ContentProvider） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Scott" />
          <p class="site-author-name" itemprop="name">Scott</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-获取网络图片"><span class="nav-number">1.</span> <span class="nav-text">1. 获取网络图片</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-获取HTML代码"><span class="nav-number">2.</span> <span class="nav-text">2. 获取HTML代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-获取XML"><span class="nav-number">3.</span> <span class="nav-text">3. 获取XML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-获取Json"><span class="nav-number">4.</span> <span class="nav-text">4. 获取Json</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-发送Get请求"><span class="nav-number">5.</span> <span class="nav-text">5. 发送Get请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-发送Post请求"><span class="nav-number">6.</span> <span class="nav-text">6. 发送Post请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Http协议上传文件"><span class="nav-number">7.</span> <span class="nav-text">7.Http协议上传文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-发送Xml，访问WebService"><span class="nav-number">8.</span> <span class="nav-text">8.发送Xml，访问WebService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-多线程断点续传"><span class="nav-number">9.</span> <span class="nav-text">9.多线程断点续传</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Scott</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Scott.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.sguotao.com/blog/2011/06/Android基础-2011-06-15-android-basic-5.html';
          this.page.identifier = '/blog/2011/06/Android基础-2011-06-15-android-basic-5.html';
          this.page.title = 'Android基础5 网络通信';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Scott.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  





  

  

  

  

  

</body>
</html>
